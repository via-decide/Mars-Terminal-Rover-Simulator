<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HEX-01 · Mars Geological Survey</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HEX-01">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="description" content="ISRO Mars Rover Cognitive Simulator — Geological Survey Mission HEX-01">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@300;400;700;900&family=Share+Tech+Mono&family=Rajdhani:wght@300;400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;background:#000;user-select:none}
:root{
  --rust:#c8440a;--amber:#ff9922;--cyan:#00c8ff;--white:#e8e0d0;
  --bg:#050608;--panel:#080b0f;--border:#1a2a1a;
  --accent:#4dff91;--accent-dim:#1a4d2e;
  --red:#ff3b3b;--text:#8ab88a;--text-dim:#3d5c3d;--sim-white:#c8dcc8;
  --scan-line:rgba(0,255,80,0.03);
  --mono:'Share Tech Mono',monospace;--display:'Orbitron',sans-serif;--ui:'Rajdhani',sans-serif;
}

/* ── SCREEN SYSTEM ── */
.screen{position:fixed;inset:0;opacity:0;pointer-events:none;transition:opacity 0.7s ease}
.screen.active{opacity:1;pointer-events:all}

/* ════════════════════════════════════
   INTRO SCREEN
════════════════════════════════════ */
#intro-screen{background:#000;cursor:none}
.cursor{position:fixed;width:20px;height:20px;pointer-events:none;z-index:9999;transform:translate(-50%,-50%)}
.cursor::before{content:'';position:absolute;top:50%;left:50%;width:4px;height:4px;background:var(--cyan);border-radius:50%;transform:translate(-50%,-50%)}
.cursor::after{content:'';position:absolute;inset:0;border:1px solid rgba(0,200,255,0.5);border-radius:50%;animation:cursorPulse 2s ease-in-out infinite}
@keyframes cursorPulse{0%,100%{transform:scale(1);opacity:0.5}50%{transform:scale(1.4);opacity:0.2}}

#stage{position:absolute;inset:0;background:#000}
#globe-canvas,#stars-canvas{position:absolute;inset:0;width:100%;height:100%}
.scan-lines{position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,0,0,0.18) 0px,rgba(0,0,0,0.18) 1px,transparent 1px,transparent 3px);pointer-events:none;z-index:20}
.vignette{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 50%,transparent 30%,rgba(0,0,0,0.75) 100%);pointer-events:none;z-index:21}

.hud-corners{position:absolute;inset:0;pointer-events:none;z-index:30;opacity:0;animation:hudFadeIn 1s 2s forwards}
@keyframes hudFadeIn{to{opacity:1}}
.corner{position:absolute;width:40px;height:40px}
.corner::before,.corner::after{content:'';position:absolute;background:var(--cyan);opacity:0.6}
.corner.tl{top:24px;left:24px}.corner.tr{top:24px;right:24px}
.corner.bl{bottom:24px;left:24px}.corner.br{bottom:24px;right:24px}
.corner.tl::before{top:0;left:0;width:2px;height:20px}.corner.tl::after{top:0;left:0;height:2px;width:20px}
.corner.tr::before{top:0;right:0;width:2px;height:20px}.corner.tr::after{top:0;right:0;height:2px;width:20px}
.corner.bl::before{bottom:0;left:0;width:2px;height:20px}.corner.bl::after{bottom:0;left:0;height:2px;width:20px}
.corner.br::before{bottom:0;right:0;width:2px;height:20px}.corner.br::after{bottom:0;right:0;height:2px;width:20px}

.hud-top{position:absolute;top:0;left:0;right:0;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 70px;border-bottom:1px solid rgba(0,200,255,0.12);background:linear-gradient(to bottom,rgba(0,0,0,0.7),transparent);z-index:30;opacity:0;animation:hudFadeIn 0.8s 2.5s forwards}
.hud-top-left{font-family:var(--display);font-size:10px;font-weight:400;letter-spacing:4px;color:rgba(0,200,255,0.7);text-transform:uppercase}
.hud-top-center{font-family:var(--mono);font-size:9px;letter-spacing:3px;color:rgba(232,224,208,0.3);text-align:center}
.hud-top-right{font-family:var(--mono);font-size:9px;letter-spacing:2px;color:rgba(0,200,255,0.5);text-align:right}
.i-sig-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--cyan);margin-right:6px;animation:sigBlink 2s ease-in-out infinite}
@keyframes sigBlink{0%,100%{opacity:1}50%{opacity:0.2}}

.hud-bottom{position:absolute;bottom:0;left:0;right:0;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 70px;border-top:1px solid rgba(0,200,255,0.12);background:linear-gradient(to top,rgba(0,0,0,0.7),transparent);z-index:30;opacity:0;animation:hudFadeIn 0.8s 2.5s forwards}
.hud-bottom-item{font-family:var(--mono);font-size:8px;letter-spacing:2.5px;color:rgba(232,224,208,0.25);text-transform:uppercase}
.hud-bottom-item span{color:rgba(0,200,255,0.6);display:block;font-size:10px;margin-top:2px}

.telemetry-panel{position:absolute;left:70px;top:50%;transform:translateY(-50%);z-index:30;opacity:0;animation:slideInLeft 0.8s 3s forwards}
@keyframes slideInLeft{from{opacity:0;transform:translateY(-50%) translateX(-20px)}to{opacity:1;transform:translateY(-50%) translateX(0)}}
.telem-row{display:flex;flex-direction:column;margin-bottom:20px;border-left:1px solid rgba(0,200,255,0.2);padding-left:12px}
.telem-label{font-family:var(--mono);font-size:7px;letter-spacing:2.5px;color:rgba(232,224,208,0.3);margin-bottom:3px}
.telem-value{font-family:var(--display);font-size:13px;font-weight:400;letter-spacing:1px;color:var(--cyan)}
.telem-value.amber{color:var(--amber)}.telem-value.white{color:var(--white)}

.quadrant-panel{position:absolute;right:70px;top:50%;transform:translateY(-50%);z-index:30;opacity:0;animation:slideInRight 0.8s 3.2s forwards;text-align:right}
@keyframes slideInRight{from{opacity:0;transform:translateY(-50%) translateX(20px)}to{opacity:1;transform:translateY(-50%) translateX(0)}}
.quad-row{display:flex;flex-direction:column;margin-bottom:20px;border-right:1px solid rgba(255,153,34,0.2);padding-right:12px}
.quad-label{font-family:var(--mono);font-size:7px;letter-spacing:2.5px;color:rgba(232,224,208,0.3);margin-bottom:3px}
.quad-value{font-family:var(--display);font-size:13px;font-weight:400;letter-spacing:1px;color:var(--amber)}

.title-sequence{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:40;pointer-events:none}
.title-agency{font-family:var(--display);font-size:clamp(9px,1.5vw,12px);font-weight:300;letter-spacing:clamp(6px,2vw,14px);color:rgba(232,224,208,0.4);text-transform:uppercase;opacity:0;transform:translateY(10px);animation:titleRise 1s 0.5s forwards;margin-bottom:18px}
@keyframes titleRise{to{opacity:1;transform:translateY(0)}}
.title-main{font-family:var(--display);font-size:clamp(28px,7vw,72px);font-weight:900;letter-spacing:clamp(4px,1.5vw,12px);color:var(--white);text-transform:uppercase;opacity:0;transform:translateY(20px);animation:titleRise 1.2s 0.9s forwards;line-height:1;text-align:center}
.title-main em{color:var(--rust);font-style:normal}
.title-sub{font-family:var(--mono);font-size:clamp(8px,1.2vw,11px);letter-spacing:clamp(3px,1vw,8px);color:rgba(200,68,10,0.8);text-transform:uppercase;opacity:0;animation:titleRise 1s 1.6s forwards;margin-top:14px}
.title-divider{width:0;height:1px;background:rgba(200,68,10,0.5);opacity:0;animation:dividerExpand 1.2s 1.3s forwards;margin:16px 0 12px}
@keyframes dividerExpand{to{width:280px;opacity:1}}

.briefing-block{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);text-align:center;z-index:40;pointer-events:none;width:90%;max-width:600px}
.briefing-line{font-family:var(--mono);font-size:clamp(8px,1.3vw,10px);letter-spacing:1.5px;color:rgba(232,224,208,0.35);line-height:2;opacity:0}
.briefing-line.l1{animation:briefFadeIn 0.6s 4.5s forwards}
.briefing-line.l2{animation:briefFadeIn 0.6s 5.1s forwards}
.briefing-line.l3{animation:briefFadeIn 0.6s 5.7s forwards}
@keyframes briefFadeIn{to{opacity:1}}

.cta-wrap{position:absolute;bottom:36px;left:50%;transform:translateX(-50%);z-index:50;opacity:0;animation:ctaReveal 0.8s 6.5s forwards}
@keyframes ctaReveal{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.cta-btn{display:flex;align-items:center;gap:12px;background:none;border:1px solid rgba(0,200,255,0.6);color:var(--cyan);font-family:var(--mono);font-size:11px;letter-spacing:4px;padding:14px 36px;cursor:pointer;text-transform:uppercase;position:relative;overflow:hidden;transition:all 0.3s}
.cta-btn::before{content:'';position:absolute;inset:0;background:var(--cyan);transform:scaleX(0);transform-origin:left;transition:transform 0.4s ease;opacity:0.08}
.cta-btn:hover::before{transform:scaleX(1)}
.cta-btn:hover{border-color:var(--cyan);box-shadow:0 0 30px rgba(0,200,255,0.15)}
.cta-btn:active{background:rgba(0,200,255,0.15)}
.cta-pulse{width:8px;height:8px;border-radius:50%;background:var(--cyan);animation:ctaDotPulse 1.5s ease-in-out infinite}
@keyframes ctaDotPulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.3;transform:scale(0.6)}}

.coord-grid{position:absolute;inset:0;z-index:22;pointer-events:none;opacity:0;animation:gridFadeIn 2s 1.5s forwards}
@keyframes gridFadeIn{to{opacity:1}}

.location-pin{position:absolute;z-index:35;pointer-events:none;opacity:0;transition:opacity 0.5s}
.location-pin.visible{opacity:1}
.pin-ring{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:1px solid rgba(255,153,34,0.6);border-radius:50%}
.pin-ring.r1{width:24px;height:24px}
.pin-ring.r2{width:44px;height:44px;opacity:0.4;animation:pinRingExpand 1.5s ease-out infinite}
@keyframes pinRingExpand{0%{width:24px;height:24px;opacity:0.6}100%{width:70px;height:70px;opacity:0}}
.pin-dot{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:50%;background:var(--amber)}
.pin-label{position:absolute;top:50%;left:50%;transform:translate(18px,-50%);font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--amber);white-space:nowrap}

.data-stream{position:absolute;right:70px;bottom:90px;z-index:30;text-align:right;opacity:0;animation:hudFadeIn 0.8s 4s forwards}
.ds-line{font-family:var(--mono);font-size:8px;letter-spacing:1.5px;color:rgba(0,200,255,0.25);line-height:2}
.ds-line.active{color:rgba(0,200,255,0.7)}

.entry-flash{position:absolute;inset:0;background:#000;z-index:100;animation:flashOut 0.8s 0.1s forwards}
@keyframes flashOut{to{opacity:0;pointer-events:none}}
.skip-btn{position:absolute;top:20px;right:24px;z-index:200;font-family:var(--mono);font-size:9px;letter-spacing:2px;color:rgba(232,224,208,0.25);background:none;border:none;cursor:pointer;transition:color 0.2s}
.skip-btn:hover{color:rgba(232,224,208,0.6)}

.orbital-svg{position:absolute;inset:0;width:100%;height:100%;z-index:23;pointer-events:none;opacity:0;animation:hudFadeIn 1.5s 2s forwards}
.met{position:absolute;top:62px;left:50%;transform:translateX(-50%);z-index:30;font-family:var(--mono);font-size:9px;letter-spacing:3px;color:rgba(232,224,208,0.2);opacity:0;animation:hudFadeIn 0.6s 3.5s forwards}

/* ════════════════════════════════════
   SIM SCREEN
════════════════════════════════════ */
#sim-screen{background:var(--bg);color:var(--text);font-family:var(--mono);display:flex;flex-direction:column;height:100dvh}
#sim-screen::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,var(--scan-line) 2px,var(--scan-line) 4px);pointer-events:none;z-index:800}
#sim-screen::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 55%,rgba(0,0,0,0.85) 100%);pointer-events:none;z-index:799}

.sim-top-bar{display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid var(--border);background:var(--panel);padding:0 10px;align-items:center;gap:4px;flex-shrink:0;height:44px}
.stat-block{display:flex;flex-direction:column;padding:4px 0}
.stat-label{font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;font-family:var(--ui);font-weight:300}
.stat-value{font-size:12px;color:var(--sim-white)}
.stat-block.center{text-align:center;align-items:center;border-left:1px solid var(--border);border-right:1px solid var(--border)}
.energy-row{display:flex;align-items:center;gap:6px}
.energy-bar-track{flex:1;height:5px;background:#0d1a0d;border:1px solid var(--accent-dim);width:80px}
.energy-bar-fill{height:100%;background:var(--accent);transition:width 0.8s ease,background 0.5s}
.energy-pct{font-size:11px;min-width:34px;text-align:right}
.validation-row{display:flex;gap:3px;margin-top:2px}
.val-pip{width:8px;height:8px;border:1px solid var(--accent-dim);border-radius:1px;transition:background 0.3s}
.val-pip.filled{background:var(--accent)}
.latency-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--accent);margin-right:5px;vertical-align:middle;animation:latency-ping 2s infinite}
.latency-dot.high{background:var(--amber)}
@keyframes latency-ping{0%,100%{opacity:1}50%{opacity:0.2}}

.sim-viewport{position:relative;overflow:hidden;background:#020304;cursor:crosshair;flex:1;min-height:0}
.terrain-bg{position:absolute;inset:0;background:radial-gradient(ellipse 200% 60% at 50% 110%,#1a0c05 0%,transparent 60%),radial-gradient(ellipse 80% 40% at 30% 90%,#120a04 0%,transparent 50%),radial-gradient(ellipse 60% 30% at 70% 85%,#0e0804 0%,transparent 40%),linear-gradient(180deg,#040507 0%,#0a0704 60%,#1a1208 100%)}
.stars-bg{position:absolute;top:0;left:0;right:0;height:45%;background-image:radial-gradient(1px 1px at 15% 20%,rgba(255,255,255,0.6),transparent),radial-gradient(1px 1px at 32% 8%,rgba(255,255,255,0.4),transparent),radial-gradient(1px 1px at 55% 15%,rgba(255,255,255,0.5),transparent),radial-gradient(1px 1px at 78% 25%,rgba(255,255,255,0.3),transparent),radial-gradient(1px 1px at 88% 5%,rgba(255,255,255,0.6),transparent),radial-gradient(1px 1px at 5% 35%,rgba(255,255,255,0.3),transparent),radial-gradient(1px 1px at 45% 30%,rgba(255,255,255,0.4),transparent),radial-gradient(1px 1px at 65% 10%,rgba(255,255,255,0.5),transparent),radial-gradient(1px 1px at 92% 40%,rgba(255,255,255,0.2),transparent),radial-gradient(1px 1px at 22% 45%,rgba(255,255,255,0.3),transparent)}
.horizon{position:absolute;bottom:38%;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#3d2a1a 20%,#5c3d20 50%,#3d2a1a 80%,transparent);opacity:0.6}
.ground{position:absolute;bottom:0;left:-10%;right:-10%;height:40%;background:linear-gradient(180deg,#1a1208 0%,#0f0c07 100%);clip-path:polygon(0% 20%,8% 5%,15% 18%,25% 2%,35% 14%,45% 0%,55% 12%,65% 3%,75% 15%,85% 5%,93% 18%,100% 8%,100% 100%,0% 100%)}
.rocks{position:absolute;bottom:37%;left:0;right:0;height:80px;pointer-events:none;transition:transform 0.4s ease}
.rock{position:absolute;background:#1e1510;border-radius:50% 50% 0 0;border-top:1px solid #2d1f12}

/* Rover mast */
.rover-mast{position:absolute;bottom:35%;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;animation:idle-vibrate 3s ease-in-out infinite;z-index:6}
@keyframes idle-vibrate{0%,100%{transform:translateX(-50%) translateY(0) rotate(0deg)}25%{transform:translateX(-50%) translateY(-1px) rotate(0.3deg)}75%{transform:translateX(-50%) translateY(1px) rotate(-0.3deg)}}
.rover-mast.moving{animation:move-shake 0.15s infinite}
@keyframes move-shake{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-2px)}}
.mast-pole{width:6px;height:80px;background:linear-gradient(90deg,#2a2a2a,#444,#2a2a2a);border-radius:3px;position:relative}
.mast-pole::after{content:'';position:absolute;left:-8px;top:20px;right:-8px;height:2px;background:#333}
.cam-head{width:44px;height:32px;background:linear-gradient(160deg,#383838 0%,#1a1a1a 100%);border-radius:4px;position:relative;display:flex;align-items:center;justify-content:center;border:1px solid #444}
.cam-lens{width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#1a3a5c,#050d14);border:2px solid #555;position:relative}
.cam-lens::after{content:'';position:absolute;top:3px;left:3px;width:5px;height:5px;border-radius:50%;background:rgba(100,180,255,0.4)}
.cam-eye{position:absolute;right:6px;top:6px;width:6px;height:6px;border-radius:50%;background:#ff3b3b;box-shadow:0 0 6px #ff3b3b;animation:blink 4s infinite}
@keyframes blink{0%,96%,100%{opacity:1}97%,99%{opacity:0}}

.dust-container{position:absolute;inset:0;pointer-events:none}
.dust{position:absolute;width:2px;height:2px;background:rgba(180,120,60,0.4);border-radius:50%;animation:dust-float 2s ease-out forwards}
@keyframes dust-float{from{opacity:0.6;transform:translateY(0) translateX(0)}to{opacity:0;transform:translateY(-30px) translateX(var(--dx))}}

.terrain-overlay{position:absolute;top:12px;left:12px;font-size:10px;color:var(--text-dim);line-height:1.8;letter-spacing:0.5px;z-index:5}
.terrain-overlay .bright{color:var(--accent)}.terrain-overlay .warn{color:var(--amber)}
/* Risk indicator in terrain overlay */
.terrain-overlay .risk-val{color:var(--red)}

.node-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:120px;height:120px;border-radius:50%;border:1px solid var(--accent);opacity:0;transition:opacity 0.5s;animation:node-pulse 2s ease-in-out infinite;pointer-events:none;z-index:5}
.node-indicator.visible{opacity:0.4}
@keyframes node-pulse{0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.4}50%{transform:translate(-50%,-50%) scale(1.1);opacity:0.2}}
.cmd-feedback{position:absolute;bottom:12px;right:12px;font-size:9px;color:var(--accent);letter-spacing:1px;opacity:0;transition:opacity 0.3s;z-index:5}
.cmd-feedback.show{opacity:1}
.solar-glow-sim{position:absolute;inset:0;pointer-events:none;border:2px solid transparent;transition:border-color 0.5s,box-shadow 0.5s;z-index:4}
.solar-glow-sim.active{border-color:rgba(255,179,71,0.2);box-shadow:inset 0 0 40px rgba(255,179,71,0.05)}
.night-overlay{position:absolute;inset:0;background:rgba(0,5,20,0);pointer-events:none;transition:background 2s;z-index:3}
.night-overlay.active{background:rgba(0,5,20,0.45)}
.storm-overlay{position:absolute;inset:0;background:rgba(80,40,10,0);pointer-events:none;transition:background 1s;z-index:4}
.storm-overlay.active{background:rgba(80,40,10,0.35)}
.low-energy-frame{position:absolute;inset:0;pointer-events:none;animation:energy-pulse 1s ease-in-out infinite;opacity:0;border:3px solid var(--red);z-index:4}
.low-energy-frame.active{opacity:1}
@keyframes energy-pulse{0%,100%{opacity:0.2}50%{opacity:0.6}}
.scanning-overlay{position:absolute;inset:0;pointer-events:none;opacity:0;transition:opacity 0.3s;z-index:6}
.scanning-overlay.active{opacity:1}
.scan-beam{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scan-vertical 1.2s linear infinite}
@keyframes scan-vertical{from{top:0}to{top:100%}}
.scan-corner{position:absolute;width:20px;height:20px;border-color:var(--accent);border-style:solid;opacity:0.7}
.sc-tl{top:8px;left:8px;border-width:1px 0 0 1px}.sc-tr{top:8px;right:8px;border-width:1px 1px 0 0}
.sc-bl{bottom:8px;left:8px;border-width:0 0 1px 1px}.sc-br{bottom:8px;right:8px;border-width:0 1px 1px 0}

/* Risk budget indicator */
.risk-bar-wrap{position:absolute;top:12px;right:12px;z-index:5;display:flex;flex-direction:column;align-items:flex-end;gap:3px}
.risk-bar-label{font-size:8px;color:var(--text-dim);letter-spacing:2px}
.risk-bar-track{width:80px;height:4px;background:#1a0a0a;border:1px solid #3d1010}
.risk-bar-fill{height:100%;background:var(--red);transition:width 0.6s ease}
.risk-pct{font-size:9px;color:var(--red)}

.bottom-panel{display:grid;grid-template-columns:1fr 1fr;border-top:1px solid var(--border);background:var(--panel);flex-shrink:0;height:180px}
.cam-feed{border-right:1px solid var(--border);padding:8px;display:flex;flex-direction:column;gap:4px;overflow:hidden}
.sim-panel-label{font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;font-family:var(--ui);font-weight:300;border-bottom:1px solid var(--border);padding-bottom:4px;margin-bottom:2px}
.cam-data{font-size:9px;line-height:1.9;color:var(--text-dim)}
.cam-data .key{color:var(--text-dim)}.cam-data .val{color:var(--text)}.cam-data .highlight{color:var(--accent)}
.scan-line-anim{width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scan-sweep 3s linear infinite;opacity:0.5;margin-top:4px}
@keyframes scan-sweep{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
.move-control{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;position:relative;gap:4px;touch-action:none}
.move-control .sim-panel-label{align-self:stretch}
.dir-grid{display:grid;grid-template-columns:repeat(3,40px);grid-template-rows:repeat(3,40px);gap:3px}
.dir-btn{display:flex;align-items:center;justify-content:center;background:#0d130d;border:1px solid var(--border);border-radius:3px;color:var(--text-dim);font-size:14px;cursor:pointer;transition:all 0.15s;touch-action:manipulation}
.dir-btn:active,.dir-btn.pressed{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);box-shadow:0 0 8px rgba(77,255,145,0.3)}
.dir-btn.center-btn{background:#111;font-size:9px;color:var(--text-dim);letter-spacing:0.5px;font-family:var(--ui)}
.dir-btn.center-btn:active{background:rgba(77,255,145,0.1);color:var(--accent)}

.toast-container{position:fixed;bottom:190px;left:50%;transform:translateX(-50%);z-index:700;display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none}
.toast{background:rgba(8,11,15,0.95);border:1px solid var(--border);color:var(--text);font-size:9px;letter-spacing:1px;padding:6px 14px;text-transform:uppercase;animation:toast-life 3s forwards;white-space:nowrap}
@keyframes toast-life{0%{opacity:0;transform:translateY(8px)}15%{opacity:1;transform:translateY(0)}75%{opacity:1}100%{opacity:0}}

/* ════════════════════════════════════
   MODALS
════════════════════════════════════ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(2px)}
.modal-overlay.hidden{display:none}
.modal-box{background:var(--panel);border:1px solid var(--accent-dim);padding:20px;width:100%;max-width:380px;position:relative;font-size:12px;line-height:1.8;max-height:80vh;overflow-y:auto}
.modal-box::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent)}
.modal-title{font-size:11px;color:var(--accent);letter-spacing:3px;text-transform:uppercase;margin-bottom:12px;font-family:var(--ui);font-weight:600}
.modal-terrain-info{border:1px solid var(--border);padding:10px;margin-bottom:14px;font-size:10px;color:var(--text-dim);line-height:2}
.modal-terrain-info .name{color:var(--sim-white);font-size:13px}
.modal-terrain-info .idx{color:var(--amber)}.modal-terrain-info .low{color:var(--red)}
.modal-question{color:var(--sim-white);font-size:11px;margin-bottom:14px;line-height:1.7;border-left:2px solid var(--accent-dim);padding-left:10px}
.modal-choices{display:flex;flex-direction:column;gap:8px}
.choice-btn{background:#0a100a;border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:10px;padding:10px 12px;text-align:left;cursor:pointer;transition:all 0.2s;letter-spacing:0.3px}
.choice-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(77,255,145,0.05)}
.choice-btn.correct{border-color:var(--accent);background:rgba(77,255,145,0.1);color:var(--accent)}
.choice-btn.wrong{border-color:var(--red);background:rgba(255,59,59,0.05);color:var(--red)}
.modal-result{text-align:center;padding:10px 0}
.result-icon{font-size:28px;margin-bottom:8px}
.result-title{font-size:13px;color:var(--accent);letter-spacing:3px;margin-bottom:8px}
.result-title.fail{color:var(--red)}
.result-delta{font-size:10px;color:var(--text-dim);margin-bottom:14px}
.result-delta .pos{color:var(--accent)}.result-delta .neg{color:var(--red)}
.modal-btn{width:100%;background:none;border:1px solid var(--accent);color:var(--accent);font-family:var(--mono);font-size:11px;letter-spacing:2px;padding:10px;cursor:pointer;margin-top:10px;transition:all 0.2s}
.modal-btn:hover{background:var(--accent);color:#000}
.modal-btn.secondary{border-color:var(--border);color:var(--text-dim);margin-top:6px}
.modal-btn.secondary:hover{border-color:var(--text-dim);background:none;color:var(--text)}
.modal-btn.danger{border-color:var(--red);color:var(--red)}
.modal-btn.danger:hover{background:rgba(255,59,59,0.1)}
.storm-icon{color:var(--amber);font-size:24px;margin-bottom:8px;text-align:center}
.efail-modal .modal-title{color:var(--red)}
/* Risk abort modal */
.riskabort-modal .modal-title{color:var(--red)}

/* ════════════════════════════════════
   RESEARCH / SEND TO DEV
════════════════════════════════════ */
.research-modal-overlay{position:fixed;inset:0;z-index:600;background:rgba(0,0,0,0.92);display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity 0.3s}
.research-modal-overlay.open{opacity:1;pointer-events:all}
.research-card{width:100%;background:var(--panel);border-top:2px solid var(--accent);padding:20px 16px 28px;max-height:82vh;overflow-y:auto;transform:translateY(16px);transition:transform 0.3s;font-size:12px}
.research-modal-overlay.open .research-card{transform:translateY(0)}
.r-tag{font-size:7px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px;font-family:var(--mono)}
.r-title{font-family:var(--display);font-size:16px;font-weight:400;color:var(--accent);letter-spacing:1.5px;margin:6px 0}
.r-sub{font-size:9px;color:var(--text-dim);line-height:1.8;margin-bottom:12px}
.r-divider{height:1px;background:#1a2a1a;margin:14px 0}
.r-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.r-card{border:1px solid var(--border);background:rgba(77,255,145,0.02);padding:10px}
.r-k{font-size:7px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px;font-family:var(--mono)}
.r-v{font-family:var(--display);font-size:15px;letter-spacing:1px;color:var(--sim-white)}
.r-v.good{color:var(--accent)}.r-v.warn{color:var(--amber)}.r-v.bad{color:var(--red)}
.r-mini{margin-top:6px;font-size:9px;color:var(--text-dim);line-height:1.6;font-family:var(--mono)}
.packet-box{margin-top:12px;border:1px solid #1a2a1a;background:rgba(0,0,0,0.2);padding:10px}
.packet-lbl{font-size:7px;letter-spacing:2.5px;color:var(--accent);margin-bottom:6px;text-transform:uppercase;font-family:var(--mono)}
.packet-pre{white-space:pre-wrap;word-break:break-word;font-size:9px;line-height:1.6;color:var(--text);opacity:0.92;font-family:var(--mono)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.inp{width:100%;background:rgba(2,4,8,0.9);border:1px solid #1a2a1a;color:var(--text);font-family:var(--mono);font-size:10px;padding:10px;outline:none}
.inp:focus{border-color:var(--accent)}
textarea.inp{min-height:78px;resize:none;grid-column:1/-1}
.r-cta-row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.r-btn{flex:1;min-width:100px;background:none;border:1px solid #1a2a1a;color:var(--text);font-family:var(--mono);font-size:10px;letter-spacing:2px;padding:12px 10px;cursor:pointer;transition:all 0.2s;text-transform:uppercase}
.r-btn.primary{border-color:var(--accent);color:var(--accent)}
.r-btn.primary:hover{background:rgba(77,255,145,0.06)}
.r-btn:hover{background:rgba(255,255,255,0.03)}
.r-btn.danger{border-color:var(--red);color:var(--red)}
.r-btn.danger:hover{background:rgba(255,59,59,0.08)}
.status-pill{margin-top:10px;border:1px solid var(--border);padding:8px 10px;font-size:9px;letter-spacing:1px;color:var(--text-dim);font-family:var(--mono)}
.status-pill.ok{border-color:#1a4d2e;color:#6adf80}
.status-pill.warn{border-color:#5a3a00;color:var(--amber)}
.status-pill.bad{border-color:#5a0a0a;color:var(--red)}

/* PWA install bar */
#pwa-bar{display:none;position:fixed;bottom:0;left:0;right:0;z-index:1000;background:#080b0f;border-top:1px solid var(--accent-dim);padding:10px 16px;align-items:center;justify-content:space-between;gap:10px}
#pwa-bar.show{display:flex}
#pwa-bar span{font-size:10px;letter-spacing:1.5px;color:var(--text);font-family:var(--mono)}
.pwa-install-btn{background:none;border:1px solid var(--accent);color:var(--accent);font-family:var(--mono);font-size:9px;letter-spacing:2px;padding:7px 14px;cursor:pointer}
.pwa-dismiss-btn{background:none;border:none;color:var(--text-dim);font-family:var(--mono);font-size:9px;cursor:pointer}
</style>
</head>
<body>

<!-- PWA Install Banner -->
<div id="pwa-bar">
  <span>◈ INSTALL HEX-01 · OFFLINE CAPABLE</span>
  <div style="display:flex;gap:8px">
    <button class="pwa-install-btn" id="pwa-install-btn">INSTALL</button>
    <button class="pwa-dismiss-btn" id="pwa-dismiss-btn">✕</button>
  </div>
</div>

<!-- ══════════════════════════════════
     SCREEN 1 · INTRO
══════════════════════════════════════ -->
<div id="intro-screen" class="screen active">
  <div class="cursor" id="cursor"></div>
  <div id="stage">
    <div class="entry-flash"></div>
    <canvas id="stars-canvas"></canvas>
    <canvas id="globe-canvas"></canvas>
    <div class="scan-lines"></div>
    <div class="vignette"></div>
    <canvas id="grid-canvas" class="coord-grid" style="position:absolute;inset:0;width:100%;height:100%;z-index:22;pointer-events:none;"></canvas>
    <svg class="orbital-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
      <ellipse cx="50" cy="50" rx="34" ry="12" fill="none" stroke="rgba(0,200,255,0.12)" stroke-width="0.3" stroke-dasharray="2 4"/>
      <circle r="1.2" fill="rgba(0,200,255,0.7)"><animateMotion dur="8s" repeatCount="indefinite"><mpath href="#orb-path"/></animateMotion></circle>
      <path id="orb-path" d="M84,50 A34,12 0 1,1 83.99,49.9" fill="none"/>
    </svg>
    <div class="hud-corners">
      <div class="corner tl"></div><div class="corner tr"></div>
      <div class="corner bl"></div><div class="corner br"></div>
    </div>
    <div class="hud-top">
      <div class="hud-top-left">ISRO · HEX-01 · OPS CENTER</div>
      <div class="hud-top-center">MARS SURFACE OPERATIONS<br><span style="font-size:7px;letter-spacing:4px;color:rgba(0,200,255,0.3)">GEOLOGICAL SURVEY MISSION</span></div>
      <div class="hud-top-right"><span class="i-sig-dot"></span>DSN RELAY ACTIVE<br><span style="font-size:7px;opacity:0.5">SIG: 97.4%</span></div>
    </div>
    <div class="met" id="met">MET: SOL 127 · 09:41:03</div>
    <div class="hud-bottom">
      <div class="hud-bottom-item">Rover Mass<span>899 KG</span></div>
      <div class="hud-bottom-item">Max Speed<span>4.16 CM/S</span></div>
      <div class="hud-bottom-item">Solar Power<span>900 WH/SOL</span></div>
      <div class="hud-bottom-item">APXS Range<span>CONTACT</span></div>
      <div class="hud-bottom-item">Mission Phase<span>QUADRANT A3</span></div>
    </div>
    <div class="telemetry-panel">
      <div class="telem-row"><div class="telem-label">ENERGY RESERVE</div><div class="telem-value">84.0%</div></div>
      <div class="telem-row"><div class="telem-label">SIGNAL LATENCY</div><div class="telem-value amber">12m 30s</div></div>
      <div class="telem-row"><div class="telem-label">ROVER STATE</div><div class="telem-value white">STANDBY</div></div>
      <div class="telem-row"><div class="telem-label">TEMP SURFACE</div><div class="telem-value amber">−54.2°C</div></div>
      <div class="telem-row"><div class="telem-label">SOLAR EFFICIENCY</div><div class="telem-value">OPTIMAL</div></div>
    </div>
    <div class="quadrant-panel">
      <div class="quad-row"><div class="quad-label">SURVEY QUADRANT</div><div class="quad-value">A3</div></div>
      <div class="quad-row"><div class="quad-label">TERRAIN TYPE</div><div class="quad-value">BASALTIC</div></div>
      <div class="quad-row"><div class="quad-label">NODES AVAILABLE</div><div class="quad-value">10</div></div>
      <div class="quad-row"><div class="quad-label">VALIDATION</div><div class="quad-value">0.00%</div></div>
      <div class="quad-row"><div class="quad-label">HAZARD INDEX</div><div class="quad-value">LOW</div></div>
    </div>
    <div class="title-sequence">
      <div class="title-agency">Indian Space Research Organisation</div>
      <div class="title-main"><em>Mars</em> Rover<br>Cognitive Simulator</div>
      <div class="title-divider"></div>
      <div class="title-sub">Mission HEX-01 · Geological Survey · Sol 127</div>
    </div>
    <div class="briefing-block">
      <div class="briefing-line l1">OPERATOR: YOU ARE TAKING COMMAND OF ROVER HEX-01</div>
      <div class="briefing-line l2">OBJECTIVE: GEOLOGICAL SURVEY · QUADRANT A3 · APXS VALIDATION</div>
      <div class="briefing-line l3">ALL COMMANDS SUBJECT TO 12m 30s SIGNAL LATENCY · MANAGE ENERGY</div>
    </div>
    <div class="data-stream">
      <div class="ds-line active" id="ds1">INITIALISING NAV SYSTEMS…</div>
      <div class="ds-line" id="ds2">LOADING TERRAIN MAP…</div>
      <div class="ds-line" id="ds3">APXS CALIBRATION CHECK…</div>
      <div class="ds-line" id="ds4">RELAY LINK ESTABLISHED…</div>
      <div class="ds-line" id="ds5">OPERATOR ACCESS GRANTED</div>
    </div>
    <div class="location-pin" id="location-pin">
      <div class="pin-dot"></div>
      <div class="pin-ring r1"></div>
      <div class="pin-ring r2"></div>
      <div class="pin-label">HEX-01 · A3</div>
    </div>
    <div class="cta-wrap">
      <button class="cta-btn" onclick="enterSimulator()">
        <span class="cta-pulse"></span>BEGIN MISSION
      </button>
    </div>
    <button class="skip-btn" onclick="enterSimulator()">SKIP INTRO ›</button>
  </div>
</div>

<!-- ══════════════════════════════════
     SCREEN 2 · SIMULATOR
══════════════════════════════════════ -->
<div id="sim-screen" class="screen">
  <div class="sim-top-bar">
    <div class="stat-block">
      <div class="stat-label">Energy Reserve</div>
      <div class="energy-row">
        <div class="energy-bar-track"><div class="energy-bar-fill" id="energyFill" style="width:84%"></div></div>
        <div class="energy-pct" id="energyPct">84%</div>
      </div>
    </div>
    <div class="stat-block center">
      <div class="stat-label">Sol / Latency</div>
      <div class="stat-value"><span class="latency-dot" id="latDot"></span><span id="solVal">SOL 127 // 1.2s RTT</span></div>
    </div>
    <div class="stat-block" style="align-items:flex-end">
      <div class="stat-label">Mission Valid.</div>
      <div class="validation-row" id="validPips">
        <div class="val-pip"></div><div class="val-pip"></div><div class="val-pip"></div>
        <div class="val-pip"></div><div class="val-pip"></div>
      </div>
    </div>
  </div>

  <div class="sim-viewport" id="viewport">
    <div class="terrain-bg"></div>
    <div class="stars-bg"></div>
    <div class="horizon"></div>
    <div class="ground"></div>
    <div class="rocks" id="rocks">
      <div class="rock" style="width:60px;height:30px;left:10%;bottom:0"></div>
      <div class="rock" style="width:25px;height:18px;left:22%;bottom:0"></div>
      <div class="rock" style="width:90px;height:40px;left:60%;bottom:0"></div>
      <div class="rock" style="width:40px;height:22px;left:80%;bottom:0"></div>
      <div class="rock" style="width:15px;height:10px;left:45%;bottom:0"></div>
    </div>
    <div class="rover-mast" id="roverMast">
      <div class="cam-head"><div class="cam-lens"></div><div class="cam-eye"></div></div>
      <div class="mast-pole"></div>
    </div>
    <div class="dust-container" id="dustContainer"></div>
    <div class="terrain-overlay">
      <div>TERRAIN: <span class="bright" id="terrainName">Basaltic Flats</span></div>
      <div>COMPLEXITY: <span class="warn" id="terrainComplex">4.2</span></div>
      <div>QUADRANT: <span id="quadrantVal">A3-07</span></div>
      <div>DUST IDX: <span class="warn" id="dustVal">0.05</span></div>
      <div>RISK: <span class="risk-val" id="riskVal">0</span><span style="color:var(--text-dim)">/100</span></div>
      <div>SOL PHASE: <span id="solPhaseVal">DAY</span></div>
    </div>
    <!-- Risk bar top-right -->
    <div class="risk-bar-wrap">
      <div class="risk-bar-label">RISK BUDGET</div>
      <div class="risk-bar-track"><div class="risk-bar-fill" id="riskBarFill" style="width:0%"></div></div>
      <div class="risk-pct" id="riskBarPct">0%</div>
    </div>
    <div class="node-indicator" id="nodeRing"></div>
    <div class="cmd-feedback" id="cmdFeedback">CMD QUEUED →</div>
    <div class="solar-glow-sim" id="solarGlow"></div>
    <div class="night-overlay" id="nightOverlay"></div>
    <div class="storm-overlay" id="stormOverlay"></div>
    <div class="low-energy-frame" id="lowEnergyFrame"></div>
    <div class="scanning-overlay" id="scanningOverlay">
      <div class="scan-beam"></div>
      <div class="scan-corner sc-tl"></div><div class="scan-corner sc-tr"></div>
      <div class="scan-corner sc-bl"></div><div class="scan-corner sc-br"></div>
    </div>
  </div>

  <div class="bottom-panel">
    <div class="cam-feed">
      <div class="sim-panel-label">// CAM FEED — HEX-01-A</div>
      <div class="cam-data" id="camData">
        <div><span class="key">TEMP  </span><span class="val" id="tempVal">-63°C</span></div>
        <div><span class="key">PRESS </span><span class="val">0.636 kPa</span></div>
        <div><span class="key">WIND  </span><span class="val" id="windVal">4.2 m/s NNW</span></div>
        <div><span class="key">RAD   </span><span class="val" id="radVal">0.18 mGy/d</span></div>
        <div><span class="key">STATE </span><span class="highlight" id="stateVal">IDLE</span></div>
      </div>
      <div class="scan-line-anim"></div>
    </div>
    <div class="move-control">
      <div class="sim-panel-label">// MOVEMENT — SWIPE OR TAP</div>
      <div class="dir-grid">
        <div class="dir-btn" onclick="move('NW')">↖</div>
        <div class="dir-btn" onclick="move('N')">↑</div>
        <div class="dir-btn" onclick="move('NE')">↗</div>
        <div class="dir-btn" onclick="move('W')">←</div>
        <div class="dir-btn center-btn" onclick="scan()">SCAN</div>
        <div class="dir-btn" onclick="move('E')">→</div>
        <div class="dir-btn" onclick="move('SW')">↙</div>
        <div class="dir-btn" onclick="move('S')">↓</div>
        <div class="dir-btn" onclick="move('SE')">↘</div>
      </div>
    </div>
  </div>
</div>

<!-- ══ MODALS ══ -->
<div class="modal-overlay hidden" id="nodeModal">
  <div class="modal-box">
    <div class="modal-title">// GEOLOGICAL NODE DETECTED</div>
    <div class="modal-terrain-info">
      <div class="name" id="nodeTerrainName">Basaltic Ridge</div>
      <div>Complexity Index: <span class="idx" id="nodeComplex">7.4</span></div>
      <div>Rover Success Rate: <span class="low" id="nodeSuccess">42%</span></div>
      <div>Energy cost: <span class="idx">-8%</span> (scan)</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="modal-btn" onclick="startScan()">INITIATE SCAN</button>
      <button class="modal-btn secondary" onclick="closeModal('nodeModal')">WITHDRAW</button>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="challengeModal">
  <div class="modal-box">
    <div class="modal-title" id="challengeTerrainLabel">// SCAN ANALYSIS</div>
    <div class="modal-question" id="challengeQuestion">Loading...</div>
    <div class="modal-choices" id="challengeChoices"></div>
  </div>
</div>

<div class="modal-overlay hidden" id="resultModal">
  <div class="modal-box">
    <div class="modal-result">
      <div class="result-icon" id="resultIcon">✓</div>
      <div class="result-title" id="resultTitle">TRANSMISSION LOGGED</div>
      <div class="result-delta" id="resultDelta"></div>
    </div>
    <button class="modal-btn" onclick="closeModal('resultModal')">RESUME MISSION</button>
  </div>
</div>

<div class="modal-overlay hidden" id="stormModal">
  <div class="modal-box">
    <div class="storm-icon">⚠</div>
    <div class="modal-title" style="color:var(--amber)">// DUST STORM DETECTED</div>
    <p style="font-size:10px;color:var(--text-dim);line-height:1.9;margin-bottom:14px">Visibility: DEGRADED<br>Solar efficiency: −40%<br>Signal latency: +3.2s<br><br>Recommend: Cease movement. Preserve energy reserves.</p>
    <div style="display:flex;gap:8px">
      <button class="modal-btn" onclick="pauseForStorm()">HALT & WAIT</button>
      <button class="modal-btn secondary" onclick="overrideStorm()">OVERRIDE</button>
    </div>
  </div>
</div>

<div class="modal-overlay hidden" id="efailModal">
  <div class="modal-box efail-modal">
    <div class="modal-title">// ENERGY DEPLETED</div>
    <p style="font-size:10px;color:var(--text-dim);line-height:2;margin-bottom:14px">HEX-01 has entered power-save mode.<br>Awaiting solar recharge cycle.<br>Est. recovery: 2h 18m [Mars Sol]</p>
    <button class="modal-btn" onclick="solarRecover()">WAIT FOR SOLAR RECHARGE</button>
    <button class="modal-btn secondary" onclick="openResearchModal()">SUBMIT MISSION DATA →</button>
    <button class="modal-btn danger" onclick="resetToIntro()">END SIMULATION</button>
  </div>
</div>

<!-- Risk budget exceeded modal -->
<div class="modal-overlay hidden" id="riskAbortModal">
  <div class="modal-box riskabort-modal">
    <div class="modal-title">// MISSION ABORT — RISK BUDGET EXCEEDED</div>
    <p style="font-size:10px;color:var(--text-dim);line-height:2;margin-bottom:14px">
      Cumulative risk index has reached critical threshold.<br>
      HEX-01 has been placed in emergency safe mode by ground control.<br>
      Mission integrity: COMPROMISED
    </p>
    <button class="modal-btn secondary" onclick="openResearchModal()">SUBMIT MISSION DATA →</button>
    <button class="modal-btn danger" onclick="resetToIntro()">END SIMULATION</button>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<!-- ══ RESEARCH / SEND TO DEV ══ -->
<div class="research-modal-overlay" id="research-modal">
  <div class="research-card">
    <div class="r-tag">◈ RESEARCH MODE · OPERATOR DECISION PACKET</div>
    <div class="r-title">MISSION ENDED · SUBMIT FOR DEV REVIEW</div>
    <div class="r-sub">Send this packet to the dev team. They will analyze your mission run and forward to ISRO if feasible.</div>
    <div class="r-divider"></div>
    <div class="r-grid">
      <div class="r-card"><div class="r-k">Validation Score</div><div class="r-v good" id="rg-val">0 pts</div><div class="r-mini" id="rg-val-mini">Correct interpretations logged.</div></div>
      <div class="r-card"><div class="r-k">Decision Accuracy</div><div class="r-v" id="rg-acc">—</div><div class="r-mini" id="rg-acc-mini">Correct / total analyses.</div></div>
      <div class="r-card"><div class="r-k">Risk Events</div><div class="r-v warn" id="rg-risk">0</div><div class="r-mini" id="rg-risk-mini">Slips + storms encountered.</div></div>
      <div class="r-card"><div class="r-k">Latency Penalty</div><div class="r-v" id="rg-lat">—</div><div class="r-mini" id="rg-lat-mini">Penalties accumulated.</div></div>
    </div>
    <div class="packet-box">
      <div class="packet-lbl">◈ PACKET PREVIEW</div>
      <div class="packet-pre" id="packet-preview">—</div>
      <div class="form-row">
        <input class="inp" id="op-name" placeholder="Operator name (optional)">
        <input class="inp" id="op-email" placeholder="Email (optional)">
        <textarea class="inp" id="op-notes" placeholder="Notes for dev team: goals, constraints, feature requests…"></textarea>
      </div>
      <div class="status-pill" id="submit-status">STATUS: READY · NOT SENT</div>
    </div>
    <div class="r-cta-row">
      <button class="r-btn primary" onclick="sendToDev()">SEND TO DEV REVIEW</button>
      <button class="r-btn" onclick="copyPacket()">COPY PACKET</button>
      <button class="r-btn danger" onclick="resetToIntro()">END SIMULATION</button>
    </div>
  </div>
</div>

<script>
/* ════════════════════════════════════════════════════════════
   CONFIG
════════════════════════════════════════════════════════════ */
const DEV_WEBHOOK_URL    = '';
const DEV_FALLBACK_EMAIL = 'dharam@viadecide.com';

/* ════════════════════════════════════════════════════════════
   MARS CONSTANTS  (from constraint engine)
════════════════════════════════════════════════════════════ */
const MARS = {
  SOL_MINUTES : 1477,
  NIGHT_START : 0.78,   // fraction of sol when night begins
  NIGHT_END   : 0.22,   // fraction of sol when night ends
  MAX_RISK    : 100
};

/* ════════════════════════════════════════════════════════════
   STATE
════════════════════════════════════════════════════════════ */
const S = {
  /* original sim state */
  energy:84, validation:0, roverState:'IDLE',
  stormActive:false, isCharging:false, nodeProximity:0,
  nodeCount:0, stepCount:0, latencyMs:1200, scanningActive:false,
  runId:null, startTs:null, endedTs:null,
  metrics:{moves:0,scans:0,correct:0,wrong:0,slips:0,storms:0,latencyPenalty:0},
  log:[],

  /* constraint engine state */
  solNumber          : 127,
  timeFrac           : 0.42,   // current fraction of the Mars sol (0–1)
  dust               : 0.05,   // dust opacity (0–0.9)
  risk               : 0,      // cumulative risk budget (0–100)
  instrumentCooldown : 0,      // ticks until instrument is ready
  instrumentReliability: 1.0   // degrades with extreme cold
};

const TERRAINS=[
  {name:'Basaltic Flats', complex:4.2,success:72,quadrant:'A3-07'},
  {name:'Regolith Field', complex:5.8,success:61,quadrant:'A3-12'},
  {name:'Basaltic Ridge', complex:7.4,success:42,quadrant:'A3-19'},
  {name:'Scoria Outcrop', complex:6.1,success:55,quadrant:'B1-03'},
  {name:'Sulfate Layer',  complex:8.9,success:38,quadrant:'B1-08'},
];
const CHALLENGES=[
  {q:"Spectral analysis shows Fe₂O₃ concentrations of 18.2%. What does this primarily indicate about the surface mineralogy?",options:[{t:'A. Active volcanic degassing',correct:false},{t:'B. Oxidized iron — ancient aqueous or atmospheric oxidation',correct:true},{t:'C. Presence of subsurface ice deposits',correct:false},{t:'D. Recent meteorite impact event',correct:false}]},
  {q:"REMS sensor shows an unexpected pressure spike of +0.8 kPa over 4 minutes. Most probable cause?",options:[{t:'A. Sensor calibration error',correct:false},{t:'B. Localized atmospheric dust devil passing',correct:true},{t:'C. Methane release from subsurface',correct:false},{t:'D. Solar wind interaction',correct:false}]},
  {q:"Rock samples show alternating light/dark layering at 2mm intervals. This lamination pattern most strongly suggests:",options:[{t:'A. Impact shock metamorphism',correct:false},{t:'B. Cyclic seasonal sediment deposition',correct:true},{t:'C. Lava flow cooling fractures',correct:false},{t:'D. Eolian cross-bedding',correct:false}]},
  {q:"ChemCam detects elevated SiO₂ (62%) with low FeO. In Mars geological context, this suggests:",options:[{t:'A. Ultramafic mantle extrusion',correct:false},{t:'B. Felsic igneous intrusion — rare on Mars',correct:true},{t:'C. Evaporitic salt deposit',correct:false},{t:'D. Carbonaceous chondrite inclusion',correct:false}]},
  {q:"Energy is critically low and a storm approaches. Optimal strategy?",options:[{t:'A. Sprint to nearest node before storm hits',correct:false},{t:'B. Deploy science instruments immediately',correct:false},{t:'C. Park facing optimal solar angle, power down non-essentials',correct:true},{t:'D. Increase signal frequency to Earth',correct:false}]},
  {q:"During APXS integration, the instrument stops recording real events and generates artificial counts at the lowest energy channel (lockup anomaly). Required mitigation?",options:[{t:'A. Increase integration time to 5 hours to override the buffer',correct:false},{t:'B. Power cycle and split long integrations into two shorter sessions',correct:true},{t:'C. Deploy arm to calibration slab to reset Curium-244 flux',correct:false}]},
];
let currentChallenge=null, currentTerrain=TERRAINS[0], moveTimeout=null, ambientTimers=[];

/* ════════════════════════════════════════════════════════════
   CONSTRAINT ENGINE CORE
════════════════════════════════════════════════════════════ */

/** True if the rover is currently in the Martian night */
function isNight(){
  return (S.timeFrac > MARS.NIGHT_START || S.timeFrac < MARS.NIGHT_END);
}

/** Effective solar panel output fraction (0–1) */
function solarEfficiency(){
  const base = isNight() ? 0 : 1;
  return base * (1 - S.dust);
}

/** Advance sol time by a fraction (rolls over at 1.0 → new sol) */
function advanceTime(frac){
  S.timeFrac += frac;
  if(S.timeFrac >= 1){
    S.timeFrac -= 1;
    S.solNumber++;
    toast('SOL ' + S.solNumber + ' — NEW MARTIAN DAY');
  }
}

/** Instrument reliability degrades in extreme cold */
function updateThermal(){
  const temp = -70 + 40 * Math.sin(S.timeFrac * Math.PI * 2);
  if(temp < -60){
    S.instrumentReliability = Math.max(0.1, S.instrumentReliability - 0.01);
  }
  // Update cam feed temperature to reflect actual sol temperature
  document.getElementById('tempVal').textContent = temp.toFixed(1) + '°C';
}

/** Dust accumulates; storms accelerate accumulation */
function updateDust(){
  S.dust += 0.002;
  if(S.stormActive) S.dust += 0.02;
  S.dust = Math.min(0.9, S.dust);
}

/** Energy changes based on sol phase — drains at night, trickle charges in day */
function updateEnergy(){
  if(isNight()){
    S.energy -= 0.3;
  } else {
    S.energy += solarEfficiency() * 0.6;
  }
  S.energy = Math.max(0, Math.min(100, S.energy));
}

/** Random storm trigger (5% chance per move/scan tick) */
function maybeRandomStorm(){
  if(!S.stormActive && Math.random() < 0.05){
    S.metrics.storms++;
    triggerStorm();
  }
}

/**
 * Check cumulative risk budget.
 * If exceeded, abort mission — mirrors the v2 constraint engine behaviour.
 */
function riskCheck(){
  if(S.risk >= MARS.MAX_RISK){
    S.endedTs = nowISO();
    logEvent('RUN_END', {reason:'RISK_BUDGET_EXCEEDED', risk: S.risk});
    closeAllModals();
    document.getElementById('riskAbortModal').classList.remove('hidden');
  }
}

/** Update all constraint-engine-derived UI elements */
function updateConstraintUI(){
  // Dust index
  const dustEl = document.getElementById('dustVal');
  if(dustEl) dustEl.textContent = S.dust.toFixed(3);

  // Risk display
  const riskEl = document.getElementById('riskVal');
  if(riskEl) riskEl.textContent = Math.round(S.risk);

  const riskPct = Math.min(100, S.risk);
  const riskFill = document.getElementById('riskBarFill');
  const riskBarPct = document.getElementById('riskBarPct');
  if(riskFill){
    riskFill.style.width = riskPct + '%';
    // Colour gradient: green → amber → red
    riskFill.style.background = riskPct >= 70 ? 'var(--red)' : riskPct >= 40 ? 'var(--amber)' : 'var(--accent)';
  }
  if(riskBarPct) riskBarPct.textContent = Math.round(riskPct) + '%';

  // Sol phase label
  const solPhaseEl = document.getElementById('solPhaseVal');
  if(solPhaseEl){
    solPhaseEl.textContent = isNight() ? 'NIGHT' : 'DAY';
    solPhaseEl.style.color = isNight() ? 'var(--amber)' : 'var(--accent)';
  }

  // Night overlay
  const nightEl = document.getElementById('nightOverlay');
  if(nightEl){
    nightEl.classList.toggle('active', isNight() && !S.stormActive);
  }

  // Solar glow only when actually generating power
  const sgEl = document.getElementById('solarGlow');
  if(sgEl && !S.isCharging){
    const producing = !isNight() && !S.stormActive && S.roverState === 'IDLE';
    sgEl.classList.toggle('active', producing);
  }
}

/* ════════════════════════════════════════════════════════════
   INTRO — CURSOR
════════════════════════════════════════════════════════════ */
const cursorEl=document.getElementById('cursor');
document.addEventListener('mousemove',e=>{cursorEl.style.left=e.clientX+'px';cursorEl.style.top=e.clientY+'px'});

/* ── STARS ── */
(function(){
  const c=document.getElementById('stars-canvas'),ctx=c.getContext('2d');let stars=[];
  function resize(){c.width=window.innerWidth;c.height=window.innerHeight;stars=[];for(let i=0;i<280;i++)stars.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*1.2,a:Math.random(),sp:0.0003+Math.random()*0.0005});}
  function draw(){ctx.clearRect(0,0,c.width,c.height);const t=Date.now();stars.forEach(s=>{const a=s.a*(0.6+0.4*Math.sin(t*s.sp));ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fillStyle=`rgba(220,210,200,${a})`;ctx.fill();});requestAnimationFrame(draw);}
  window.addEventListener('resize',resize);resize();draw();
})();

/* ── GLOBE ── */
(function(){
  const c=document.getElementById('globe-canvas'),ctx=c.getContext('2d');
  let W,H,cx,cy,R,rot=0;
  function resize(){W=c.width=window.innerWidth;H=c.height=window.innerHeight;cx=W/2;cy=H/2;R=Math.min(W,H)*0.34;}
  const patches=[{lo:-30,la:20,w:60,h:28,shade:'rgba(90,28,4,0.55)'},{lo:40,la:-15,w:45,h:22,shade:'rgba(80,24,4,0.5)'},{lo:120,la:10,w:50,h:25,shade:'rgba(85,26,4,0.52)'},{lo:200,la:-5,w:40,h:20,shade:'rgba(78,22,4,0.48)'},{lo:290,la:15,w:55,h:24,shade:'rgba(88,27,4,0.53)'},{lo:0,la:-30,w:70,h:30,shade:'rgba(180,70,18,0.35)'},{lo:80,la:25,w:55,h:22,shade:'rgba(170,65,16,0.32)'},{lo:160,la:-20,w:60,h:28,shade:'rgba(175,68,17,0.33)'},{lo:240,la:5,w:65,h:25,shade:'rgba(165,62,15,0.30)'},{lo:0,la:75,w:360,h:30,shade:'rgba(200,185,175,0.4)'},{lo:0,la:-75,w:360,h:25,shade:'rgba(190,178,168,0.3)'},{lo:280,la:0,w:80,h:8,shade:'rgba(60,18,4,0.65)'},{lo:226,la:18,w:18,h:14,shade:'rgba(220,100,30,0.45)'}];
  const craters=[{lo:25,la:10,r:4},{lo:100,la:-20,r:6},{lo:180,la:5,r:5},{lo:260,la:-10,r:4},{lo:320,la:20,r:5},{lo:50,la:-35,r:3},{lo:140,la:25,r:4},{lo:210,la:-25,r:6},{lo:305,la:0,r:3}];
  function proj(lon,lat,rOff){const lonR=(lon+rOff)*Math.PI/180,latR=lat*Math.PI/180;const x3=Math.cos(latR)*Math.cos(lonR),y3=Math.sin(latR),z3=Math.cos(latR)*Math.sin(lonR);return{x:cx+R*z3,y:cy-R*y3,visible:x3>0,depth:x3};}
  function drawGlobe(t){
    ctx.clearRect(0,0,W,H);rot=(t*0.008)%360;
    const glow=ctx.createRadialGradient(cx,cy,R*0.2,cx,cy,R*1.6);glow.addColorStop(0,'rgba(160,50,10,0.06)');glow.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=glow;ctx.fillRect(0,0,W,H);
    const bg=ctx.createRadialGradient(cx-R*0.25,cy-R*0.2,R*0.05,cx,cy,R);bg.addColorStop(0,'#7a2a10');bg.addColorStop(0.35,'#5a1c08');bg.addColorStop(0.7,'#3a1006');bg.addColorStop(1,'#1a0804');ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,R-0.5,0,Math.PI*2);ctx.clip();
    patches.forEach(p=>{const center=proj(p.lo+p.w/2,p.la,rot);if(!center.visible)return;const fade=Math.pow(center.depth,0.7),pts=[],steps=12;for(let i=0;i<=steps;i++){const pt=proj(p.lo+(i/steps)*p.w,p.la+p.h/2,rot);if(pt.visible)pts.push(pt);}for(let i=steps;i>=0;i--){const pt=proj(p.lo+(i/steps)*p.w,p.la-p.h/2,rot);if(pt.visible)pts.push(pt);}if(pts.length<4)return;ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);pts.forEach(pt=>ctx.lineTo(pt.x,pt.y));ctx.closePath();ctx.globalAlpha=fade;ctx.fillStyle=p.shade;ctx.fill();ctx.globalAlpha=1;});
    craters.forEach(c=>{const pt=proj(c.lo,c.la,rot);if(!pt.visible||pt.depth<0.1)return;const r=c.r*R/100*Math.min(1,pt.depth*2),fade=Math.pow(pt.depth,0.5);ctx.globalAlpha=fade*0.5;ctx.beginPath();ctx.arc(pt.x,pt.y,r,0,Math.PI*2);ctx.strokeStyle='rgba(40,12,4,0.8)';ctx.lineWidth=r*0.3;ctx.stroke();ctx.globalAlpha=1;});
    ctx.restore();
    const atm=ctx.createRadialGradient(cx,cy,R*0.94,cx,cy,R*1.1);atm.addColorStop(0,'rgba(200,80,20,0.25)');atm.addColorStop(0.5,'rgba(160,50,10,0.08)');atm.addColorStop(1,'rgba(0,0,0,0)');ctx.beginPath();ctx.arc(cx,cy,R*1.08,0,Math.PI*2);ctx.fillStyle=atm;ctx.fill();
    const spec=ctx.createRadialGradient(cx-R*0.3,cy-R*0.28,0,cx-R*0.25,cy-R*0.25,R*0.55);spec.addColorStop(0,'rgba(255,200,160,0.14)');spec.addColorStop(1,'rgba(0,0,0,0)');ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=spec;ctx.fill();
    const term=ctx.createLinearGradient(cx+R*0.3,cy,cx+R,cy);term.addColorStop(0,'rgba(0,0,0,0)');term.addColorStop(1,'rgba(0,0,0,0.72)');ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=term;ctx.fill();
    ctx.save();ctx.beginPath();ctx.arc(cx,cy,R-0.5,0,Math.PI*2);ctx.clip();ctx.strokeStyle='rgba(0,200,255,0.06)';ctx.lineWidth=0.5;
    for(let lat=-60;lat<=60;lat+=30){ctx.beginPath();let f=true;for(let lon=0;lon<=360;lon+=3){const pt=proj(lon,lat,rot);if(!pt.visible){f=true;continue;}f?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y);f=false;}ctx.stroke();}
    for(let lon=0;lon<360;lon+=30){ctx.beginPath();let f=true;for(let lat2=-90;lat2<=90;lat2+=3){const pt=proj(lon,lat2,rot);if(!pt.visible){f=true;continue;}f?ctx.moveTo(pt.x,pt.y):ctx.lineTo(pt.x,pt.y);f=false;}ctx.stroke();}
    ctx.restore();
    const pin=proj(295,5,rot);
    const pinEl=document.getElementById('location-pin');
    if(pin.visible&&pin.depth>0.3){pinEl.style.left=pin.x+'px';pinEl.style.top=pin.y+'px';pinEl.style.transform='translate(-50%,-50%)';pinEl.classList.add('visible');}else pinEl.classList.remove('visible');
    requestAnimationFrame(drawGlobe);
  }
  window.addEventListener('resize',resize);resize();requestAnimationFrame(drawGlobe);
})();

/* ── GRID ── */
(function(){
  const c=document.getElementById('grid-canvas'),ctx=c.getContext('2d');
  function resize(){c.width=window.innerWidth;c.height=window.innerHeight;}
  function draw(){ctx.clearRect(0,0,c.width,c.height);const W=c.width,H=c.height;ctx.strokeStyle='rgba(0,200,255,0.04)';ctx.lineWidth=0.5;for(let y=0;y<H;y+=44){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}for(let x=0;x<W;x+=44){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}ctx.fillStyle='rgba(0,200,255,0.15)';for(let y=44;y<H;y+=132)for(let x=44;x<W;x+=132)ctx.fillRect(x-1,y-1,2,2);}
  window.addEventListener('resize',()=>{resize();draw();});resize();draw();
})();

['ds1','ds2','ds3','ds4','ds5'].forEach((id,i)=>setTimeout(()=>document.getElementById(id).classList.add('active'),4000+i*500));
(function(){let s=9*3600+41*60+3;setInterval(()=>{s++;const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60,pad=n=>String(n).padStart(2,'0');document.getElementById('met').textContent=`MET: SOL 127 · ${pad(h)}:${pad(m)}:${pad(sec)}`;},1000);})();

/* ════════════════════════════════════════════════════════════
   SCREEN TRANSITIONS
════════════════════════════════════════════════════════════ */
function flash(cb){const f=document.createElement('div');f.style.cssText='position:fixed;inset:0;background:#000;z-index:9999;opacity:0;transition:opacity 0.7s;pointer-events:none;';document.body.appendChild(f);requestAnimationFrame(()=>{f.style.opacity='1';});setTimeout(()=>{cb();f.style.opacity='0';setTimeout(()=>f.remove(),700);},750);}

function enterSimulator(){
  flash(()=>{
    document.getElementById('intro-screen').classList.remove('active');
    document.getElementById('sim-screen').classList.add('active');
    startSim();
  });
}

function resetToIntro(){
  closeAllModals();
  document.getElementById('research-modal').classList.remove('open');
  document.getElementById('riskAbortModal').classList.add('hidden');
  ambientTimers.forEach(t=>clearInterval(t));ambientTimers=[];clearTimeout(moveTimeout);

  /* Reset original state */
  S.energy=84;S.validation=0;S.roverState='IDLE';S.stormActive=false;S.isCharging=false;
  S.nodeProximity=0;S.nodeCount=0;S.stepCount=0;S.latencyMs=1200;S.scanningActive=false;
  S.runId=null;S.startTs=null;S.endedTs=null;
  S.metrics={moves:0,scans:0,correct:0,wrong:0,slips:0,storms:0,latencyPenalty:0};S.log=[];

  /* Reset constraint engine state */
  S.solNumber=127; S.timeFrac=0.42; S.dust=0.05;
  S.risk=0; S.instrumentCooldown=0; S.instrumentReliability=1.0;

  currentTerrain=TERRAINS[0];
  const rocks=document.getElementById('rocks');rocks.dataset.offset=0;rocks.style.transform='';
  document.getElementById('stormOverlay').classList.remove('active');
  document.getElementById('nightOverlay').classList.remove('active');
  document.getElementById('solarGlow').classList.remove('active');
  document.getElementById('lowEnergyFrame').classList.remove('active');
  document.getElementById('latDot').classList.remove('high');
  updateUI();updateValidationPips();updateConstraintUI();
  flash(()=>{
    document.getElementById('sim-screen').classList.remove('active');
    document.getElementById('intro-screen').classList.add('active');
  });
}

/* ════════════════════════════════════════════════════════════
   SIM ENGINE
════════════════════════════════════════════════════════════ */
function startSim(){
  S.runId=mkRunId();S.startTs=nowISO();S.endedTs=null;S.log=[];
  logEvent('RUN_START',{runId:S.runId});
  startAmbientLoop();startSolarCycle();startNodeProximityTimer();startConstraintLoop();
  updateUI();updateValidationPips();updateConstraintUI();
  toast('HEX-01 ONLINE — MISSION ACTIVE');
}

/**
 * Constraint engine tick loop — runs every second (mirrors the setInterval
 * in the v2 constraint engine).  Handles instrument cooldown, dust, thermal,
 * and energy passage-of-time effects.
 */
function startConstraintLoop(){
  const iv = setInterval(()=>{
    if(!document.getElementById('sim-screen').classList.contains('active')) return;

    // Instrument cooldown ticker
    if(S.instrumentCooldown > 0) S.instrumentCooldown--;

    // Passive time-based constraint updates
    advanceTime(0.0007);      // ~1 min of Mars sol per real second (compressed)
    updateThermal();
    updateDust();
    updateEnergy();           // night drain / solar trickle
    updateUI();
    updateConstraintUI();
  }, 1000);
  ambientTimers.push(iv);
}

function move(dir){
  if(S.roverState==='SCANNING'||S.scanningActive){toast('CANNOT MOVE DURING SCAN');return;}
  if(S.energy<=0){showEnergyFail();return;}
  if(S.energy<5){toast('CRITICAL ENERGY — MOVEMENT BLOCKED');return;}

  const fb=document.getElementById('cmdFeedback');
  fb.textContent=`CMD [${dir}] QUEUED →`;fb.classList.add('show');
  setState('MOVING');clearTimeout(moveTimeout);

  moveTimeout=setTimeout(()=>{
    fb.classList.remove('show');

    /* ── Constraint engine: advance time & environmental state per move ── */
    advanceTime(0.01);   // each move costs ~15 Mars minutes
    updateThermal();
    updateDust();
    updateEnergy();

    /* Dust slip → risk accumulation */
    if(Math.random() < S.dust){
      S.risk += 5;
      S.metrics.slips++;
      logEvent('DUST_SLIP', {dust: S.dust, riskNow: S.risk});
      toast('TRACTION LOSS — DUST HAZARD DETECTED');
    }

    /* Check risk budget */
    riskCheck();
    if(S.risk >= MARS.MAX_RISK) return; // aborted

    /* ── Original move logic ── */
    const drain=1.5+Math.random()*0.5;modEnergy(-drain);S.metrics.moves++;
    const rocks=document.getElementById('rocks');
    const shift={N:0,S:0,E:-2,W:2,NE:-1,NW:1,SE:-1,SW:1};
    const offset=parseFloat(rocks.dataset.offset||0)+(shift[dir]||0);
    rocks.dataset.offset=offset;rocks.style.transform=`translateX(${offset}px)`;
    spawnDust();S.stepCount++;logEvent('MOVE',{dir,drain,risk:S.risk,dust:S.dust});

    /* Storm trigger (uses constraint engine probability based on dust) */
    maybeRandomStorm();

    S.nodeProximity+=0.15+Math.random()*0.1;
    if(S.nodeProximity>=1){S.nodeProximity=0;openNodeModal();}
    updateNodeRing();setState('IDLE');updateUI();updateConstraintUI();

    if(S.energy<=0)showEnergyFail();
    else if(S.energy<15)document.getElementById('lowEnergyFrame').classList.add('active');
    else document.getElementById('lowEnergyFrame').classList.remove('active');
  },S.latencyMs);

  document.getElementById('roverMast').classList.add('moving');
  setTimeout(()=>document.getElementById('roverMast').classList.remove('moving'),S.latencyMs+300);
}

function scan(){
  /* Instrument cooldown check (from constraint engine) */
  if(S.instrumentCooldown > 0){
    toast('INSTRUMENT COOLING — WAIT ' + S.instrumentCooldown + 's');
    return;
  }
  if(S.energy<8){toast('INSUFFICIENT ENERGY FOR SCAN');return;}
  if(S.scanningActive)return;
  if(S.roverState==='MOVING'){toast('CEASE MOVEMENT BEFORE SCANNING');return;}
  openNodeModal();
}

function openNodeModal(){
  currentTerrain=TERRAINS[Math.floor(Math.random()*TERRAINS.length)];
  document.getElementById('nodeTerrainName').textContent=currentTerrain.name;
  document.getElementById('nodeComplex').textContent=currentTerrain.complex;
  document.getElementById('nodeSuccess').textContent=currentTerrain.success+'%';
  document.getElementById('nodeModal').classList.remove('hidden');
  updateTerrainOverlay();
}

function startScan(){
  closeModal('nodeModal');
  if(S.energy<8){toast('INSUFFICIENT ENERGY');return;}

  /* Constraint engine: scan cost & time advance */
  advanceTime(0.02);  // ~30 Mars minutes for a scan
  updateThermal();
  updateDust();
  updateEnergy();

  modEnergy(-8);S.scanningActive=true;S.metrics.scans++;setState('SCANNING');
  document.getElementById('scanningOverlay').classList.add('active');
  document.getElementById('stateVal').textContent='SCANNING...';
  logEvent('SCAN_START',{terrain:currentTerrain.name, dust:S.dust, reliability:S.instrumentReliability});

  setTimeout(()=>{
    document.getElementById('scanningOverlay').classList.remove('active');
    S.scanningActive=false;

    /* Constraint engine: instrument reliability affects scan outcome */
    const successChance = S.instrumentReliability - S.dust * 0.5;
    if(Math.random() > successChance){
      // Instrument glitch
      S.risk += 4;
      S.metrics.slips++;
      toast('INSTRUMENT ANOMALY — SCAN DEGRADED');
      logEvent('SCAN_ANOMALY', {successChance, risk:S.risk});
    }

    /* Instrument cooldown (from v2 engine: 3 ticks) */
    S.instrumentCooldown = 3;

    setState('IDLE');openChallenge();
    riskCheck();
    updateConstraintUI();
  },2200);
  updateUI();
}

function openChallenge(){
  currentChallenge=CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
  document.getElementById('challengeTerrainLabel').textContent=`// ${currentTerrain.name.toUpperCase()} — ANALYSIS`;
  document.getElementById('challengeQuestion').textContent=currentChallenge.q;
  const el=document.getElementById('challengeChoices');el.innerHTML='';
  currentChallenge.options.forEach((opt,i)=>{
    const btn=document.createElement('button');btn.className='choice-btn';btn.textContent=opt.t;
    btn.onclick=()=>evaluateAnswer(i);el.appendChild(btn);
  });
  document.getElementById('challengeModal').classList.remove('hidden');
}

function evaluateAnswer(idx){
  const opts=document.querySelectorAll('.choice-btn');
  opts.forEach(b=>b.onclick=null);
  const correct=currentChallenge.options[idx].correct;
  currentChallenge.options.forEach((o,i)=>{if(o.correct)opts[i].classList.add('correct');});
  if(!correct)opts[idx].classList.add('wrong');
  logEvent('ANSWER',{correct,terrain:currentTerrain.name});
  if(correct)S.metrics.correct++;else S.metrics.wrong++;
  setTimeout(()=>{closeModal('challengeModal');showResult(correct);},1200);
}

function showResult(correct){
  const icon=document.getElementById('resultIcon'),title=document.getElementById('resultTitle'),delta=document.getElementById('resultDelta');
  if(correct){
    icon.textContent='✓';title.textContent='TRANSMISSION LOGGED';title.className='result-title';
    modEnergy(+12);S.validation=Math.min(5,S.validation+1);
    /* Correct answer slightly clears risk — reward good decisions */
    S.risk = Math.max(0, S.risk - 3);
    delta.innerHTML='Energy: <span class="pos">+12%</span> &nbsp;|&nbsp; Validation: <span class="pos">+1</span> &nbsp;|&nbsp; Risk: <span class="pos">−3</span>';
    updateValidationPips();updateUI();updateConstraintUI();
  }else{
    icon.textContent='✗';title.textContent='ANALYSIS FAILED';title.className='result-title fail';
    modEnergy(-6);S.latencyMs=Math.min(3000,S.latencyMs+400);S.metrics.latencyPenalty+=400;
    /* Wrong answer adds risk — poor analysis = mission risk */
    S.risk += 4;
    delta.innerHTML='Energy: <span class="neg">−6%</span> &nbsp;|&nbsp; Signal delay: <span class="neg">+0.4s</span> &nbsp;|&nbsp; Risk: <span class="neg">+4</span>';
    updateUI();updateConstraintUI();
    riskCheck();
  }
  document.getElementById('resultModal').classList.remove('hidden');
}

function triggerStorm(){
  S.stormActive=true;
  document.getElementById('stormOverlay').classList.add('active');
  document.getElementById('latDot').classList.add('high');
  S.latencyMs=Math.min(3500,S.latencyMs+800);
  document.getElementById('stormModal').classList.remove('hidden');
  logEvent('STORM_START',{dust:S.dust, risk:S.risk});
}

function pauseForStorm(){
  /* Constraint engine: HALT costs 2 risk (safe choice) */
  closeModal('stormModal');
  S.risk += 2;
  S.isCharging=true;
  document.getElementById('solarGlow').classList.add('active');
  toast('HALTED — AWAITING STORM PASSAGE');
  setTimeout(()=>{
    S.stormActive=false;S.isCharging=false;
    document.getElementById('stormOverlay').classList.remove('active');
    document.getElementById('solarGlow').classList.remove('active');
    document.getElementById('latDot').classList.remove('high');
    S.latencyMs=Math.max(1200,S.latencyMs-800);
    toast('STORM CLEARED — RESUMING OPERATIONS');
    logEvent('STORM_END',{via:'HALT', risk:S.risk});
    updateConstraintUI();
  },8000);
  updateConstraintUI();
}

function overrideStorm(){
  /* Constraint engine: OVERRIDE costs 8 risk (risky choice) */
  S.risk += 8;
  closeModal('stormModal');
  S.stormActive=false;
  document.getElementById('stormOverlay').classList.remove('active');
  document.getElementById('latDot').classList.remove('high');
  S.latencyMs=Math.max(1200,S.latencyMs-800);
  toast('STORM OVERRIDE — HIGH RISK ACCEPTED (+8 RISK)');
  logEvent('STORM_OVERRIDE',{risk:S.risk});
  riskCheck();
  updateConstraintUI();
}

function showEnergyFail(){
  S.endedTs=nowISO();logEvent('RUN_END',{reason:'ENERGY_DEPLETED'});
  document.getElementById('efailModal').classList.remove('hidden');
}

function solarRecover(){
  closeModal('efailModal');S.isCharging=true;
  document.getElementById('solarGlow').classList.add('active');toast('SOLAR RECOVERY INITIATED');
  const iv=setInterval(()=>{
    modEnergy(+2);updateUI();
    if(S.energy>=25){clearInterval(iv);S.isCharging=false;document.getElementById('solarGlow').classList.remove('active');document.getElementById('lowEnergyFrame').classList.remove('active');toast('ENERGY RESTORED — OPERATIONS RESUMED');}
  },1500);
  ambientTimers.push(iv);
}

/* ── HELPERS ── */
function modEnergy(d){S.energy=Math.max(0,Math.min(100,S.energy+d));}
function setState(st){S.roverState=st;document.getElementById('stateVal').textContent=st;}
function updateUI(){
  const e=Math.round(S.energy);
  document.getElementById('energyFill').style.width=e+'%';
  document.getElementById('energyPct').textContent=e+'%';
  const fill=document.getElementById('energyFill');
  fill.style.background=e<15?'var(--red)':e<35?'var(--amber)':'var(--accent)';
  document.getElementById('energyPct').style.color=e<15?'var(--red)':e<35?'var(--amber)':'var(--text)';

  // Sol info with actual constraint engine time
  const hour=Math.floor(S.timeFrac*24);
  const minute=Math.floor((S.timeFrac*24-hour)*60);
  document.getElementById('solVal').textContent=
    `SOL ${S.solNumber} · ${hour}:${String(minute).padStart(2,'0')} // ${(S.latencyMs/1000).toFixed(1)}s RTT`;
}
function updateTerrainOverlay(){
  document.getElementById('terrainName').textContent=currentTerrain.name;
  document.getElementById('terrainComplex').textContent=currentTerrain.complex;
  document.getElementById('quadrantVal').textContent=currentTerrain.quadrant;
}
function updateValidationPips(){document.querySelectorAll('.val-pip').forEach((p,i)=>p.classList.toggle('filled',i<S.validation));}
function updateNodeRing(){document.getElementById('nodeRing').classList.toggle('visible',S.nodeProximity>0.5);}
function closeModal(id){document.getElementById(id).classList.add('hidden');}
function closeAllModals(){['nodeModal','challengeModal','resultModal','stormModal','efailModal','riskAbortModal'].forEach(id=>closeModal(id));}
function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.getElementById('toastContainer').appendChild(t);setTimeout(()=>t.remove(),3200);}
function spawnDust(){const c=document.getElementById('dustContainer');for(let i=0;i<4;i++){const d=document.createElement('div');d.className='dust';d.style.left=(40+Math.random()*20)+'%';d.style.bottom='36%';d.style.setProperty('--dx',(Math.random()*20-10)+'px');d.style.animationDelay=(Math.random()*0.3)+'s';c.appendChild(d);setTimeout(()=>d.remove(),2200);}}

/* ── AMBIENT LOOPS ── */
function startAmbientLoop(){
  ambientTimers.push(setInterval(()=>{
    // Temperature now driven by constraint engine updateThermal()
    // but wind/rad still randomise for ambiance
    document.getElementById('windVal').textContent=(2+Math.random()*6).toFixed(1)+' m/s '+['N','NNW','NW','NE','E'][Math.floor(Math.random()*5)];
    document.getElementById('radVal').textContent=(0.15+Math.random()*0.08).toFixed(2)+' mGy/d';
  },5000));
  ambientTimers.push(setInterval(()=>{
    if(S.roverState==='MOVING'){modEnergy(-0.3);updateUI();}
  },1000));
}

function startSolarCycle(){
  // Solar glow is now managed by updateConstraintUI() based on isNight() / stormActive
  // This timer is kept as a no-op placeholder for compatibility
  ambientTimers.push(setInterval(()=>{
    updateConstraintUI();
  },3000));
}

function startNodeProximityTimer(){
  ambientTimers.push(setInterval(()=>{
    if(S.roverState==='IDLE'&&S.stepCount>0&&S.nodeProximity<0.4&&Math.random()<0.05){S.nodeProximity+=0.1;updateNodeRing();}
  },2000));
}

/* ════════════════════════════════════════════════════════════
   RESEARCH / SEND TO DEV
════════════════════════════════════════════════════════════ */
function nowISO(){return new Date().toISOString();}
function mkRunId(){return`HEX01-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`.toUpperCase();}
function logEvent(type,data={}){S.log.push({t:nowISO(),type,...data});if(S.log.length>150)S.log.splice(0,S.log.length-150);}

function buildResearchPacket(){
  const total=S.metrics.correct+S.metrics.wrong;
  const acc=total>0?Math.round((S.metrics.correct/total)*1000)/10:null;
  return{
    schema:'HEX01_REVIEW_PACKET_V1',runId:S.runId,startedAt:S.startTs,endedAt:S.endedTs||nowISO(),
    operator:{
      name:(document.getElementById('op-name')?.value||'').trim()||null,
      email:(document.getElementById('op-email')?.value||'').trim()||null,
      notes:(document.getElementById('op-notes')?.value||'').trim()||null
    },
    finalState:{
      energy:Math.max(0,Math.floor(S.energy)),
      validation:S.validation,
      latencyMs:Math.floor(S.latencyMs),
      stepCount:S.stepCount,
      terrain:currentTerrain?.name||null,
      /* constraint engine fields */
      solNumber:S.solNumber,
      timeFrac:Math.round(S.timeFrac*1000)/1000,
      dustIndex:Math.round(S.dust*1000)/1000,
      riskBudgetUsed:Math.round(S.risk),
      instrumentReliability:Math.round(S.instrumentReliability*100)/100
    },
    metrics:{...S.metrics,decisionAccuracy:acc},
    eventLog:S.log
  };
}

function openResearchModal(){
  if(!S.endedTs){S.endedTs=nowISO();logEvent('RUN_END',{reason:'MANUAL'});}
  const total=S.metrics.correct+S.metrics.wrong;
  const accPct=total?Math.round((S.metrics.correct/total)*100):null;
  document.getElementById('rg-val').textContent=S.validation+' pts';
  document.getElementById('rg-val-mini').textContent=`${S.metrics.correct} correct scan${S.metrics.correct!==1?'s':''}`;
  const accEl=document.getElementById('rg-acc');
  accEl.textContent=accPct===null?'—':accPct+'%';
  accEl.className='r-v '+(accPct===null?'':(accPct>=70?'good':accPct>=45?'warn':'bad'));
  document.getElementById('rg-acc-mini').textContent=`${S.metrics.correct} correct / ${total} total`;
  const risk=S.metrics.slips+S.metrics.storms;
  const riskEl=document.getElementById('rg-risk');
  riskEl.textContent=risk;riskEl.className='r-v '+(risk<=2?'good':risk<=5?'warn':'bad');
  document.getElementById('rg-risk-mini').textContent=`${S.metrics.slips} slips · ${S.metrics.storms} storms · risk budget ${Math.round(S.risk)}/100`;
  const latEl=document.getElementById('rg-lat');
  latEl.textContent='+'+S.metrics.latencyPenalty+'ms';
  latEl.className='r-v '+(S.metrics.latencyPenalty<=800?'good':S.metrics.latencyPenalty<=2000?'warn':'bad');
  document.getElementById('rg-lat-mini').textContent=`current RTT ${(S.latencyMs/1000).toFixed(1)}s`;
  const pkt=buildResearchPacket();
  document.getElementById('packet-preview').textContent=JSON.stringify({
    runId:pkt.runId,
    validation:pkt.finalState.validation,
    energy:pkt.finalState.energy,
    accuracy:pkt.metrics.decisionAccuracy,
    riskBudgetUsed:pkt.finalState.riskBudgetUsed,
    dustIndex:pkt.finalState.dustIndex,
    solNumber:pkt.finalState.solNumber,
    instrumentReliability:pkt.finalState.instrumentReliability,
    latencyPenalty:pkt.metrics.latencyPenalty
  },null,2);
  setSubmitStatus('STATUS: READY · NOT SENT','');
  closeAllModals();closeModal('efailModal');
  document.getElementById('research-modal').classList.add('open');
}

function setSubmitStatus(text,cls){const el=document.getElementById('submit-status');el.textContent=text;el.className='status-pill '+(cls||'');}

async function sendToDev(){
  const pkt=buildResearchPacket();setSubmitStatus('STATUS: SENDING…','warn');
  if(DEV_WEBHOOK_URL&&DEV_WEBHOOK_URL.trim()){
    try{
      const res=await fetch(DEV_WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(pkt)});
      if(!res.ok)throw new Error('HTTP '+res.status);
      setSubmitStatus('STATUS: SENT ✓ DEV REVIEW QUEUED','ok');toast('PACKET SENT');logEvent('DEV_SUBMIT',{via:'webhook',ok:true});return;
    }catch(e){setSubmitStatus('STATUS: WEBHOOK FAILED · USING EMAIL','warn');}
  }
  try{
    const subject=encodeURIComponent(`HEX-01 Review Packet · ${pkt.runId}`);
    const bodyTxt='HEX-01 DEV REVIEW REQUEST\n\n'+JSON.stringify({runId:pkt.runId,summary:{validation:pkt.finalState.validation,energy:pkt.finalState.energy,decisionAccuracy:pkt.metrics.decisionAccuracy,riskBudgetUsed:pkt.finalState.riskBudgetUsed,dustIndex:pkt.finalState.dustIndex}},null,2)+'\n\n(Use COPY PACKET for full JSON.)';
    window.location.href=`mailto:${DEV_FALLBACK_EMAIL}?subject=${subject}&body=${encodeURIComponent(bodyTxt)}`;
    setSubmitStatus('STATUS: EMAIL DRAFT OPENED · SEND MANUALLY','ok');logEvent('DEV_SUBMIT',{via:'mailto',ok:true});
  }catch(e){setSubmitStatus('STATUS: FAILED · USE COPY PACKET','bad');}
}

async function copyPacket(){
  const txt=JSON.stringify(buildResearchPacket(),null,2);
  try{await navigator.clipboard.writeText(txt);setSubmitStatus('STATUS: COPIED ✓','ok');toast('PACKET COPIED');}
  catch{prompt('Copy packet:',txt);setSubmitStatus('STATUS: MANUAL COPY','warn');}
  logEvent('PACKET_COPY',{});
}

/* ════════════════════════════════════════════════════════════
   TOUCH / KEYBOARD
════════════════════════════════════════════════════════════ */
let touchStart=null;
const vp=document.getElementById('viewport');
vp.addEventListener('touchstart',e=>{touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};},{passive:true});
vp.addEventListener('touchend',e=>{
  if(!touchStart)return;
  const dx=e.changedTouches[0].clientX-touchStart.x,dy=e.changedTouches[0].clientY-touchStart.y;
  if(Math.abs(dx)<30&&Math.abs(dy)<30){scan();touchStart=null;return;}
  const angle=Math.atan2(-dy,dx)*180/Math.PI;
  let dir;
  if(angle>-22.5&&angle<=22.5)dir='E';else if(angle>22.5&&angle<=67.5)dir='NE';else if(angle>67.5&&angle<=112.5)dir='N';else if(angle>112.5&&angle<=157.5)dir='NW';else if(angle>157.5||angle<=-157.5)dir='W';else if(angle>-157.5&&angle<=-112.5)dir='SW';else if(angle>-112.5&&angle<=-67.5)dir='S';else dir='SE';
  move(dir);touchStart=null;
},{passive:true});
document.querySelectorAll('.dir-btn').forEach(btn=>{
  btn.addEventListener('touchstart',()=>btn.classList.add('pressed'),{passive:true});
  btn.addEventListener('touchend',()=>setTimeout(()=>btn.classList.remove('pressed'),200),{passive:true});
  btn.addEventListener('mouseleave',()=>btn.classList.remove('pressed'));
});
document.addEventListener('keydown',e=>{
  const map={ArrowUp:'N',ArrowDown:'S',ArrowLeft:'W',ArrowRight:'E',w:'N',s:'S',a:'W',d:'E',q:'NW',e:'NE',z:'SW',c:'SE'};
  if(e.key===' '){e.preventDefault();scan();return;}
  if(map[e.key]&&document.getElementById('sim-screen').classList.contains('active')){e.preventDefault();move(map[e.key]);}
});

/* ════════════════════════════════════════════════════════════
   PWA
════════════════════════════════════════════════════════════ */
let deferredPrompt=null;
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').then(r=>console.log('[HEX-01] SW',r.scope)).catch(e=>console.warn('[HEX-01] SW fail',e));
  });
}
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;document.getElementById('pwa-bar').classList.add('show');});
document.getElementById('pwa-install-btn').addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();const{outcome}=await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('pwa-bar').classList.remove('show');});
document.getElementById('pwa-dismiss-btn').addEventListener('click',()=>document.getElementById('pwa-bar').classList.remove('show'));
window.addEventListener('appinstalled',()=>{document.getElementById('pwa-bar').classList.remove('show');deferredPrompt=null;});
</script>
</body>
</html>
