<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--
  FIX: removed maximum-scale=1.0 / user-scalable=no to allow iOS to reflow properly.
  viewport-fit=cover gives us safe-area inset support for the notch.
-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Mars Survival Decision Lab â€” Constraint Learning Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Syne+Mono&family=Bebas+Neue&family=Syne:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” MARS DECISION LAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --mars:       #D64000;
  --mars-deep:  #8B2500;
  --mars-glow:  #FF6B35;
  --dust:       #C4956A;
  --dust-light: #E8C4A0;
  --void:       #060608;
  --void2:      #0D0E12;
  --panel:      #111318;
  --panel2:     #181B22;
  --border:     rgba(255,255,255,0.07);
  --border2:    rgba(214,64,0,0.3);
  --text:       #E8E4DC;
  --text-dim:   #6B6860;
  --text-mid:   #A8A49C;
  --green:      #3DFF8F;
  --green-dim:  #1A4D35;
  --amber:      #FFB830;
  --amber-dim:  #3D2800;
  --red:        #FF3B3B;
  --red-dim:    #3D0000;
  --cyan:       #00D4FF;
  --mono:       'Syne Mono', monospace;
  --display:    'Bebas Neue', sans-serif;
  --ui:         'Syne', sans-serif;
  --body:       'Space Grotesk', sans-serif;

  /* iOS safe-area env() variables â€” fallback to 0 on non-notch devices */
  --sat: env(safe-area-inset-top, 0px);
  --sar: env(safe-area-inset-right, 0px);
  --sab: env(safe-area-inset-bottom, 0px);
  --sal: env(safe-area-inset-left, 0px);
}

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

/*
  FIX (mobile scroll): html & body must NOT have overflow:hidden globally.
  Each screen manages its own scroll behaviour.
  height:100% on html/body ensures the full-screen fixed screens still work.
*/
html {
  width: 100%;
  height: 100%;
  /* Allow iOS rubber-band so the body doesn't trap touches */
  -webkit-overflow-scrolling: touch;
}
body {
  width: 100%;
  min-height: 100%;
  background: var(--void);
  color: var(--text);
  font-family: var(--body);
  /* No overflow:hidden here â€” the game screens handle their own containment */
}

/* â”€â”€ SCREENS â”€â”€ */
/*
  FIX: Non-landing screens keep position:fixed + overflow:hidden (game viewport).
  Landing screen is different â€” see #screen-landing below.
*/
.screen {
  position: fixed;
  inset: 0;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s;
  overflow: hidden;
}
.screen.active { opacity: 1; pointer-events: all; }

/* â”€â”€ SHARED UTILS â”€â”€ */
.pill { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 10px; font-family: var(--mono); letter-spacing: 1px; text-transform: uppercase; }
.pill.green  { background: var(--green-dim);  color: var(--green);  border: 1px solid rgba(61,255,143,0.25); }
.pill.amber  { background: var(--amber-dim);  color: var(--amber);  border: 1px solid rgba(255,184,48,0.25); }
.pill.red    { background: var(--red-dim);    color: var(--red);    border: 1px solid rgba(255,59,59,0.25); }
.pill.mars   { background: rgba(214,64,0,0.15); color: var(--mars-glow); border: 1px solid var(--border2); }
.btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 22px; font-family: var(--mono); font-size: 11px; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; border: none; transition: all 0.2s; }
.btn-primary   { background: var(--mars); color: #fff; }
.btn-primary:hover { background: var(--mars-glow); }
.btn-secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--text-mid); }
.btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid transparent; }
.btn-ghost:hover { color: var(--text); }
.btn-green { background: transparent; color: var(--green); border: 1px solid rgba(61,255,143,0.4); }
.btn-green:hover { background: var(--green-dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 0 â€” LANDING / ROLE SELECT
   FIX: Landing must scroll when content overflows on small screens.
   We override the .screen fixed+overflow:hidden with a scroll-friendly layout.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-landing {
  background: var(--void);
  /*
    FIX: Use position:fixed so it layers correctly, but allow Y overflow scroll.
    On short phones the role cards must be reachable.
  */
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  /* FIX: account for iOS notch at top and home-bar at bottom */
  padding-top: var(--sat);
  padding-bottom: calc(var(--sab) + 8px);
}

/*
  FIX: Background decorative layers must NOT intercept touch/scroll events.
  Any position:absolute decoration inside landing gets pointer-events:none.
*/
#screen-landing .bg-grid,
#screen-landing .bg-glow,
#screen-landing .mars-sphere {
  pointer-events: none;
}

/* Animated background grid */
.bg-grid {
  position: absolute; inset: 0; z-index: 0;
  background-image:
    linear-gradient(rgba(214,64,0,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(214,64,0,0.04) 1px, transparent 1px);
  background-size: 48px 48px;
  animation: gridDrift 20s linear infinite;
}
@keyframes gridDrift { from { background-position: 0 0; } to { background-position: 48px 48px; } }

.bg-glow {
  position: absolute; inset: 0; z-index: 0;
  background: radial-gradient(ellipse 80% 60% at 50% 100%, rgba(214,64,0,0.12) 0%, transparent 60%);
  pointer-events: none;
}
.mars-sphere {
  position: absolute; bottom: -180px; left: 50%; transform: translateX(-50%);
  width: 520px; height: 520px; border-radius: 50%;
  background: radial-gradient(circle at 35% 30%, #8B3A1A 0%, #5A1E08 35%, #2A0C02 70%, #0A0401 100%);
  box-shadow: 0 0 120px rgba(214,64,0,0.25), inset -60px -60px 100px rgba(0,0,0,0.7);
  z-index: 1;
}
.mars-sphere::before {
  content: '';
  position: absolute; top: 15%; left: 10%; width: 35%; height: 25%;
  background: rgba(180,80,20,0.2);
  border-radius: 50%;
  filter: blur(20px);
}
.mars-sphere::after {
  content: '';
  position: absolute; inset: -2px; border-radius: 50%;
  background: radial-gradient(circle at 35% 30%, transparent 60%, rgba(0,0,0,0.85) 100%);
}

/*
  FIX: landing-content no longer uses height:100% (that works only in fixed parents
  without scroll). Use min-height + padding so content is always accessible.
  On tall screens it still appears vertically centred.
*/
.landing-content {
  position: relative;
  z-index: 10;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  /* FIX: min-height instead of height so content can grow past viewport */
  min-height: 100dvh;       /* dvh = dynamic viewport height, handles mobile toolbars */
  padding: 24px 20px 40px;
}
.landing-eyebrow { font-family: var(--mono); font-size: 10px; letter-spacing: 4px; color: var(--mars-glow); opacity: 0; animation: rise 0.6s 0.3s forwards; margin-bottom: 16px; }
.landing-title { font-family: var(--display); font-size: clamp(52px, 10vw, 110px); color: var(--text); line-height: 0.9; text-align: center; opacity: 0; animation: rise 0.7s 0.6s forwards; margin-bottom: 8px; }
.landing-title em { color: var(--mars); font-style: normal; }
.landing-subtitle { font-family: var(--mono); font-size: clamp(9px, 1.5vw, 12px); color: var(--text-dim); letter-spacing: 3px; text-align: center; opacity: 0; animation: rise 0.6s 0.9s forwards; margin-bottom: 48px; text-transform: uppercase; }
.landing-tagline {
  max-width: 520px; text-align: center; font-size: 14px; color: var(--text-mid); line-height: 1.7;
  opacity: 0; animation: rise 0.6s 1.2s forwards; margin-bottom: 48px;
}

.role-cards {
  display: flex; gap: 12px;
  opacity: 0; animation: rise 0.6s 1.5s forwards;
  /* FIX: allow wrapping on narrow screens so cards don't get cut off */
  flex-wrap: wrap;
  justify-content: center;
  /* FIX: ensure cards are above the mars sphere z-layer */
  position: relative;
  z-index: 10;
  /* FIX: bottom padding so last card clears the iOS home indicator */
  padding-bottom: 12px;
}
.role-card {
  width: 180px; padding: 20px 16px; border: 1px solid var(--border);
  background: var(--panel); cursor: pointer; transition: all 0.25s; text-align: center;
  position: relative; overflow: hidden;
  /* FIX: ensure touch target is large enough on mobile */
  -webkit-tap-highlight-color: rgba(214,64,0,0.15);
  touch-action: manipulation;
}
.role-card::before { content: ''; position: absolute; inset: 0; background: var(--mars); transform: scaleY(0); transform-origin: bottom; transition: transform 0.25s; opacity: 0.08; }
.role-card:hover::before { transform: scaleY(1); }
.role-card:hover { border-color: var(--border2); transform: translateY(-3px); }
.role-card:hover .role-icon { color: var(--mars-glow); }
.role-icon { font-size: 28px; margin-bottom: 10px; display: block; transition: color 0.2s; }
.role-name { font-family: var(--ui); font-weight: 700; font-size: 14px; color: var(--text); margin-bottom: 6px; }
.role-desc { font-size: 11px; color: var(--text-dim); line-height: 1.5; }
.role-badge { position: absolute; top: 8px; right: 8px; }

@keyframes rise { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 1 â€” SIMULATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-sim {
  background: var(--void);
  display: flex; flex-direction: column;
  /* FIX: use dvh for reliable mobile height */
  height: 100dvh;
  /* FIX: account for safe areas inside the fixed game shell */
  padding-top: var(--sat);
  padding-left: var(--sal);
  padding-right: var(--sar);
  padding-bottom: var(--sab);
}

/* â”€â”€ TOP STATUS BAR â”€â”€ */
.sim-topbar {
  display: grid; grid-template-columns: 1fr auto 1fr;
  align-items: center; padding: 8px 14px;
  border-bottom: 1px solid var(--border);
  background: var(--panel); flex-shrink: 0;
  gap: 8px;
}
.topbar-left { display: flex; gap: 14px; align-items: center; }
.topbar-center { text-align: center; }
.topbar-right { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }

.stat-chip { display: flex; flex-direction: column; gap: 2px; }
.stat-chip-label { font-family: var(--mono); font-size: 7px; color: var(--text-dim); letter-spacing: 2px; }
.stat-chip-val { font-family: var(--mono); font-size: 12px; color: var(--text); }

.energy-bar { display: flex; align-items: center; gap: 6px; }
.ebar-track { width: 70px; height: 4px; background: #1a1a1a; border: 1px solid var(--border); }
.ebar-fill { height: 100%; transition: width 0.6s, background 0.4s; }

.mission-badge { font-family: var(--display); font-size: 18px; color: var(--mars-glow); letter-spacing: 2px; }
.sol-line { font-family: var(--mono); font-size: 9px; color: var(--text-dim); }

.tier-display { display: flex; align-items: center; gap: 6px; font-family: var(--mono); font-size: 10px; color: var(--amber); }
.xp-mini { font-size: 9px; color: var(--text-dim); }

/* â”€â”€ VIEWPORT â”€â”€ */
.sim-viewport {
  flex: 1; position: relative; overflow: hidden;
  background: #030405; cursor: crosshair; min-height: 0;
}

/* Sky layers */
.sky { position: absolute; inset: 0; background: linear-gradient(180deg, #060309 0%, #0D0810 40%, #1A0C08 70%, #2A1208 100%); z-index: 0; }
.stars { position: absolute; top: 0; left: 0; right: 0; height: 60%; z-index: 1; }
.horizon-glow { position: absolute; bottom: 35%; left: 0; right: 0; height: 80px; background: linear-gradient(180deg, transparent, rgba(200,80,20,0.15)); z-index: 2; }
.ground { position: absolute; bottom: 0; left: 0; right: 0; height: 37%; background: linear-gradient(180deg, #1A0E06 0%, #0F0A04 100%); clip-path: polygon(0% 25%,4% 10%,10% 22%,18% 5%,26% 18%,34% 3%,42% 16%,50% 2%,58% 15%,66% 4%,74% 18%,82% 6%,90% 20%,96% 8%,100% 18%,100% 100%,0% 100%); z-index: 3; }

/* Rover */
.rover-mast {
  position: absolute; bottom: 34%; left: 50%; transform: translateX(-50%);
  display: flex; flex-direction: column; align-items: center;
  animation: idle-bob 4s ease-in-out infinite; z-index: 8;
}
@keyframes idle-bob { 0%,100%{transform:translateX(-50%) translateY(0)} 50%{transform:translateX(-50%) translateY(-2px)} }
.rover-mast.moving { animation: shake 0.12s infinite; }
@keyframes shake { 0%,100%{transform:translateX(-50%)} 50%{transform:translateX(calc(-50% + 2px))} }
.cam-head { width: 48px; height: 36px; background: #2A2A2A; border-radius: 5px 5px 3px 3px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; position: relative; }
.cam-lens { width: 20px; height: 20px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #0A2A4A, #030810); border: 2px solid #555; }
.cam-lens::after { content:''; position:absolute; top:6px; left:8px; width:5px; height:5px; border-radius:50%; background:rgba(0,212,255,0.3); }
.cam-eye { position:absolute; right:7px; top:7px; width:6px; height:6px; border-radius:50%; background:var(--mars); box-shadow:0 0 8px var(--mars); animation:eye-blink 5s infinite; }
@keyframes eye-blink { 0%,95%,100%{opacity:1}96%,99%{opacity:0} }
.mast-pole { width:6px; height:76px; background: linear-gradient(90deg,#222,#444,#222); border-radius:3px; }
.mast-pole::after { content:''; position:absolute; left:-7px; top:24px; right:-7px; height:2px; background:#333; }

/* Terrain overlays */
.terrain-info {
  position: absolute; top: 10px; left: 10px; z-index: 10;
  font-family: var(--mono); font-size: 9px; line-height: 2;
  color: var(--text-dim); background: rgba(6,6,8,0.7);
  padding: 8px 12px; border-left: 2px solid var(--border2);
}
.terrain-info .hi { color: var(--mars-glow); }
.terrain-info .warn { color: var(--amber); }
.terrain-info .crit { color: var(--red); }
.terrain-info .ok { color: var(--green); }

/* Risk bar */
.risk-wrap { position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.risk-label { font-family: var(--mono); font-size: 7px; color: var(--text-dim); letter-spacing: 2px; }
.risk-track { width: 90px; height: 5px; background: #1a0a0a; border: 1px solid #3d1010; }
.risk-fill { height: 100%; transition: width 0.5s, background 0.4s; }
.risk-pct { font-family: var(--mono); font-size: 9px; color: var(--red); }

/* Scan overlay */
.scan-overlay { position:absolute;inset:0;z-index:9;opacity:0;transition:opacity 0.3s;pointer-events:none; }
.scan-overlay.active { opacity:1; }
.scan-beam { position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--green),transparent);animation:scan-sweep 1s linear infinite; }
@keyframes scan-sweep { from{top:0} to{top:100%} }
.scan-corners span { position:absolute; width:18px; height:18px; border-color:var(--green); border-style:solid; opacity:0.7; }
.scan-corners .tl{top:8px;left:8px;border-width:1px 0 0 1px}
.scan-corners .tr{top:8px;right:8px;border-width:1px 1px 0 0}
.scan-corners .bl{bottom:8px;left:8px;border-width:0 0 1px 1px}
.scan-corners .br{bottom:8px;right:8px;border-width:0 1px 1px 0}

/* Environmental overlays */
.night-layer { position:absolute;inset:0;z-index:5;background:rgba(0,5,20,0);pointer-events:none;transition:background 3s; }
.night-layer.active { background:rgba(0,5,20,0.5); }
.storm-layer { position:absolute;inset:0;z-index:6;background:rgba(80,40,10,0);pointer-events:none;transition:background 1s; }
.storm-layer.active { background:rgba(80,40,10,0.4); }
.low-energy-ring { position:absolute;inset:0;z-index:7;border:3px solid var(--red);opacity:0;pointer-events:none;animation:ring-pulse 1s ease-in-out infinite; }
.low-energy-ring.active { opacity:1; }
@keyframes ring-pulse { 0%,100%{opacity:0.2}50%{opacity:0.7} }
.solar-ring { position:absolute;inset:0;z-index:4;border:2px solid transparent;pointer-events:none;transition:all 0.5s; }
.solar-ring.active { border-color:rgba(255,184,48,0.2);box-shadow:inset 0 0 50px rgba(255,184,48,0.06); }

/* â”€â”€ BOTTOM PANEL â”€â”€ */
.sim-bottom { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border); background: var(--panel); flex-shrink: 0; height: 178px; }
.cam-panel { border-right: 1px solid var(--border); padding: 8px 10px; display: flex; flex-direction: column; gap: 3px; overflow: hidden; }
.panel-lbl { font-family: var(--mono); font-size: 7px; color: var(--text-dim); letter-spacing: 2px; border-bottom: 1px solid var(--border); padding-bottom: 4px; margin-bottom: 3px; text-transform: uppercase; }
.cam-telem { font-family: var(--mono); font-size: 9px; line-height: 2; }
.cam-telem .k { color: var(--text-dim); }
.cam-telem .v { color: var(--text-mid); }
.cam-telem .v.green { color: var(--green); }
.cam-telem .v.amber { color: var(--amber); }
.scan-sweep-line { width:100%;height:1px;background:linear-gradient(90deg,transparent,var(--green),transparent);animation:sweep 3s linear infinite;opacity:0.5;margin-top:4px; }
@keyframes sweep { from{transform:translateX(-100%)} to{transform:translateX(100%)} }

.ctrl-panel { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; gap: 6px; touch-action: none; }
.dir-grid { display: grid; grid-template-columns: repeat(3,40px); grid-template-rows: repeat(3,40px); gap: 3px; }
.dir-btn {
  display: flex; align-items: center; justify-content: center;
  background: var(--panel2); border: 1px solid var(--border);
  color: var(--text-dim); font-size: 14px; cursor: pointer;
  transition: all 0.12s; touch-action: manipulation;
}
.dir-btn:active, .dir-btn.pressed { background: rgba(214,64,0,0.15); border-color: var(--mars); color: var(--mars-glow); box-shadow: 0 0 10px rgba(214,64,0,0.3); }
.dir-btn.scan-btn { font-family: var(--mono); font-size: 8px; color: var(--text-dim); letter-spacing: 0.5px; }
.dir-btn.scan-btn:active { color: var(--green); border-color: var(--green); background: var(--green-dim); }

/* â”€â”€ ROCKS â”€â”€ */
.rocks { position:absolute;bottom:35%;left:-10%;right:-10%;height:80px;pointer-events:none;transition:transform 0.3s;z-index:4; }
.rock { position:absolute;background:#160D05;border-radius:50% 50% 0 0;border-top:1px solid #241508; }

/* â”€â”€ DUST â”€â”€ */
.dust-p { position:absolute;width:2px;height:2px;background:rgba(196,149,106,0.5);border-radius:50%;animation:dust-rise 1.8s ease-out forwards; }
@keyframes dust-rise { from{opacity:0.6;transform:translateY(0) translateX(0)} to{opacity:0;transform:translateY(-28px) translateX(var(--dx))} }

/* â”€â”€ TOAST â”€â”€ */
#toast-wrap { position:fixed;bottom:195px;left:50%;transform:translateX(-50%);z-index:500;display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none; }
.toast-item { background:var(--panel2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:9px;letter-spacing:1px;padding:6px 16px;text-transform:uppercase;animation:toast-anim 3s forwards;white-space:nowrap; }
@keyframes toast-anim { 0%{opacity:0;transform:translateY(8px)} 12%{opacity:1;transform:translateY(0)} 75%{opacity:1} 100%{opacity:0} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-bg { position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:300;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity 0.2s; }
.modal-bg.open { opacity:1;pointer-events:all; }
.modal { background:var(--panel);border:1px solid var(--border);width:100%;max-width:400px;position:relative;overflow:hidden;max-height:88vh;overflow-y:auto; }
.modal::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--mars),transparent); }
.modal-head { padding:16px 18px 12px;border-bottom:1px solid var(--border); }
.modal-title { font-family: var(--ui); font-weight:700; font-size:13px; color:var(--mars-glow); letter-spacing:2px; text-transform:uppercase; margin-bottom:4px; }
.modal-sub { font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:1px; }
.modal-body { padding:16px 18px; }
.modal-footer { padding:12px 18px 16px;display:flex;gap:8px;flex-wrap:wrap; }

/* Node modal */
.node-terrain-card { border:1px solid var(--border2);padding:12px;margin-bottom:14px; }
.ntc-name { font-family:var(--ui);font-weight:700;font-size:16px;color:var(--text);margin-bottom:8px; }
.ntc-stats { display:grid;grid-template-columns:1fr 1fr;gap:6px; }
.ntc-stat { display:flex;flex-direction:column;gap:2px; }
.ntc-stat-lbl { font-family:var(--mono);font-size:7px;color:var(--text-dim);letter-spacing:2px; }
.ntc-stat-val { font-family:var(--mono);font-size:12px;color:var(--amber); }

/* Challenge modal */
.challenge-q { font-size:12px;color:var(--text);line-height:1.7;padding:12px;background:rgba(214,64,0,0.05);border-left:3px solid var(--border2);margin-bottom:14px; }
.choices { display:flex;flex-direction:column;gap:7px; }
.choice-btn { background:var(--panel2);border:1px solid var(--border);color:var(--text-mid);font-family:var(--body);font-size:11px;padding:11px 14px;text-align:left;cursor:pointer;transition:all 0.18s; }
.choice-btn:hover { border-color:var(--text-dim);color:var(--text); }
.choice-btn.correct { border-color:var(--green);background:rgba(61,255,143,0.08);color:var(--green); }
.choice-btn.wrong { border-color:var(--red);background:rgba(255,59,59,0.06);color:var(--red); }

/* Result modal */
.result-icon { font-size:36px;text-align:center;margin-bottom:8px; }
.result-title { font-family:var(--display);font-size:22px;color:var(--green);text-align:center;letter-spacing:2px;margin-bottom:6px; }
.result-title.fail { color:var(--red); }
.result-deltas { display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:4px; }
.delta-chip { font-family:var(--mono);font-size:10px;padding:4px 10px;border-radius:3px; }
.delta-chip.pos { background:var(--green-dim);color:var(--green);border:1px solid rgba(61,255,143,0.2); }
.delta-chip.neg { background:var(--red-dim);color:var(--red);border:1px solid rgba(255,59,59,0.2); }

/* Explanation box */
.explanation-box { margin-top:12px;padding:12px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-left:2px solid var(--mars); }
.explanation-box .exp-lbl { font-family:var(--mono);font-size:7px;color:var(--mars-glow);letter-spacing:2px;margin-bottom:5px; }
.explanation-box p { font-size:11px;color:var(--text-dim);line-height:1.7; }

/* Storm modal */
.storm-icon-big { font-size:32px;text-align:center;margin-bottom:8px;animation:storm-pulse 1s ease-in-out infinite; }
@keyframes storm-pulse { 0%,100%{transform:scale(1)}50%{transform:scale(1.08)} }

/* Energy fail */
.efail-title { font-family:var(--display);font-size:24px;color:var(--red);letter-spacing:2px; }

/* Risk abort */
.rabort-title { font-family:var(--display);font-size:22px;color:var(--red);letter-spacing:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 2 â€” SKILL TREE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-skills {
  background: var(--void2);
  display: flex; flex-direction: column;
  padding-top: var(--sat);
  padding-bottom: var(--sab);
}
.skills-topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 18px; border-bottom: 1px solid var(--border); background: var(--panel); flex-shrink: 0;
}
.skills-topbar-title { font-family:var(--display);font-size:20px;color:var(--text);letter-spacing:2px; }
.skills-body { flex:1;overflow-y:auto;padding:20px 16px; }
.skill-branch { margin-bottom:24px; }
.branch-header { display:flex;align-items:center;gap:10px;margin-bottom:12px; }
.branch-icon { font-size:20px; }
.branch-name { font-family:var(--ui);font-weight:700;font-size:14px;color:var(--text); }
.branch-progress { font-family:var(--mono);font-size:9px;color:var(--text-dim);margin-left:auto; }
.branch-track { display:flex;gap:6px;overflow-x:auto;padding-bottom:4px; }
.skill-node {
  min-width: 130px; padding: 12px; border: 1px solid var(--border);
  background: var(--panel); cursor: pointer; transition: all 0.2s; flex-shrink: 0;
  position: relative;
}
.skill-node.unlocked { border-color: var(--green-dim); background: rgba(61,255,143,0.04); }
.skill-node.active { border-color: var(--green); box-shadow: 0 0 16px rgba(61,255,143,0.15); }
.skill-node.locked { opacity: 0.4; cursor: default; }
.skill-node-name { font-family:var(--mono);font-size:10px;color:var(--text);margin-bottom:4px; }
.skill-node-req { font-size:9px;color:var(--text-dim);line-height:1.5; }
.skill-node-badge { position:absolute;top:6px;right:6px;font-size:12px; }
.skill-connector { width:20px;height:2px;background:var(--border);flex-shrink:0;align-self:center;margin-top:-20px; }
.skill-connector.lit { background:var(--green-dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 3 â€” TEACHER DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-teacher {
  background: var(--void2);
  display: flex; flex-direction: column;
  padding-top: var(--sat);
  padding-bottom: var(--sab);
}
.teacher-topbar {
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  padding: 10px 18px; border-bottom: 1px solid var(--border); background: var(--panel); flex-shrink: 0;
}
.teacher-title { font-family:var(--display);font-size:20px;color:var(--text);letter-spacing:2px; }
.teacher-body { flex:1;overflow-y:auto;padding:16px; }

/* Tab system */
.tab-bar { display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px; }
.tab-btn { font-family:var(--mono);font-size:9px;letter-spacing:2px;color:var(--text-dim);padding:8px 16px;cursor:pointer;border:none;background:none;transition:all 0.2s;border-bottom:2px solid transparent;text-transform:uppercase; }
.tab-btn.active { color:var(--mars-glow);border-bottom-color:var(--mars); }
.tab-content { display:none; }
.tab-content.active { display:block; }

/* Stats row */
.stats-row { display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px; }
.stat-card { background:var(--panel);border:1px solid var(--border);padding:14px;position:relative;overflow:hidden; }
.stat-card::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--mars); }
.stat-card-val { font-family:var(--display);font-size:28px;color:var(--text);letter-spacing:1px;margin-bottom:2px; }
.stat-card-val.green { color:var(--green); }
.stat-card-val.amber { color:var(--amber); }
.stat-card-val.red { color:var(--red); }
.stat-card-lbl { font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase; }

/* Student table */
.student-table { width:100%;border-collapse:collapse; }
.student-table th { font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;text-transform:uppercase; }
.student-table td { font-family:var(--mono);font-size:10px;padding:10px;border-bottom:1px solid var(--border);color:var(--text-mid);vertical-align:middle; }
.student-table tr:hover td { background:rgba(255,255,255,0.02); }
.stu-name { color:var(--text);font-weight:500; }
.stu-bar { width:80px;height:4px;background:#1a1a1a;border:1px solid var(--border);display:inline-block;vertical-align:middle; }
.stu-bar-fill { height:100%;background:var(--mars); }

/* Heatmap */
.heatmap-grid { display:grid;gap:3px;margin-top:8px; }
.heatmap-row { display:flex;gap:3px;align-items:center; }
.heatmap-label { font-family:var(--mono);font-size:8px;color:var(--text-dim);width:180px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.heatmap-cells { display:flex;gap:3px; }
.heatmap-cell { width:28px;height:24px;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:8px;border:1px solid rgba(255,255,255,0.05);transition:transform 0.15s;cursor:default; }
.heatmap-cell:hover { transform:scale(1.1); }
.heatmap-col-labels { display:flex;gap:3px;margin-left:183px;margin-bottom:2px; }
.heatmap-col-lbl { width:28px;text-align:center;font-family:var(--mono);font-size:7px;color:var(--text-dim); }

/* Legend */
.heatmap-legend { display:flex;align-items:center;gap:6px;margin-top:10px;font-family:var(--mono);font-size:8px;color:var(--text-dim); }
.legend-swatch { width:14px;height:14px;border:1px solid rgba(255,255,255,0.1); }

/* Benchmark chart */
.bench-wrap { margin-top:12px; }
.bench-row { display:flex;align-items:center;gap:10px;margin-bottom:8px; }
.bench-name { font-family:var(--mono);font-size:9px;color:var(--text-dim);width:120px;flex-shrink:0; }
.bench-track { flex:1;height:6px;background:#111;border:1px solid var(--border); }
.bench-fill { height:100%;transition:width 0.8s; }
.bench-val { font-family:var(--mono);font-size:9px;color:var(--text-mid);width:35px;text-align:right; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 4 â€” MISSION SELECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-missions {
  background: var(--void2);
  display: flex; flex-direction: column;
  padding-top: var(--sat);
  padding-bottom: var(--sab);
}
.missions-body { flex:1;overflow-y:auto;padding:16px; }
.mission-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px; }
.mission-card {
  background:var(--panel);border:1px solid var(--border);padding:16px;
  cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;
}
.mission-card::before { content:'';position:absolute;inset:0;background:var(--mars);transform:scaleX(0);transform-origin:left;transition:transform 0.2s;opacity:0.05; }
.mission-card:hover::before { transform:scaleX(1); }
.mission-card:hover { border-color:var(--border2);transform:translateY(-2px); }
.mission-card.locked { opacity:0.45;cursor:default; }
.mission-card.locked:hover { transform:none; }
.mission-card.locked::before { display:none; }
.mission-card.completed { border-color:var(--green-dim); }
.mc-num { font-family:var(--display);font-size:32px;color:var(--mars-deep);position:absolute;top:8px;right:12px;line-height:1; }
.mc-name { font-family:var(--ui);font-weight:700;font-size:14px;color:var(--text);margin-bottom:6px; }
.mc-constraint { font-family:var(--mono);font-size:9px;color:var(--text-dim);margin-bottom:10px;line-height:1.5; }
.mc-tags { display:flex;gap:4px;flex-wrap:wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 5 â€” CERTIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-cert {
  background: var(--void2);
  display: flex; flex-direction: column;
  padding-top: var(--sat);
  padding-bottom: var(--sab);
}
.cert-body { flex:1;overflow-y:auto;padding:16px; }
.cert-levels { display:flex;flex-direction:column;gap:12px; }
.cert-card {
  background:var(--panel);border:1px solid var(--border);padding:18px;
  display:flex;gap:14px;align-items:flex-start;position:relative;overflow:hidden;
}
.cert-card.earned { border-color:rgba(255,184,48,0.4); }
.cert-card.earned::before { content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--amber),transparent); }
.cert-level-badge {
  width:56px;height:56px;display:flex;align-items:center;justify-content:center;
  font-family:var(--display);font-size:26px;border:2px solid var(--border);flex-shrink:0;
}
.cert-card.earned .cert-level-badge { border-color:var(--amber);color:var(--amber); }
.cert-info { flex:1; }
.cert-name { font-family:var(--ui);font-weight:700;font-size:15px;color:var(--text);margin-bottom:4px; }
.cert-skills { font-size:11px;color:var(--text-dim);line-height:1.6;margin-bottom:10px; }
.cert-req { font-family:var(--mono);font-size:9px;color:var(--text-dim);line-height:1.7; }
.cert-req .done { color:var(--green); }
.cert-progress-bar { width:100%;height:3px;background:#1a1a1a;border:1px solid var(--border);margin-top:10px; }
.cert-progress-fill { height:100%;background:var(--amber);transition:width 0.8s; }

/* Certificate viewer */
.cert-viewer-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.93);z-index:600;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.3s; }
.cert-viewer-overlay.open { opacity:1;pointer-events:all; }
.cert-doc {
  width:100%;max-width:520px;background:#0A0804;
  border:2px solid var(--amber);padding:32px;text-align:center;position:relative;
}
.cert-doc::before { content:'';position:absolute;inset:6px;border:1px solid rgba(255,184,48,0.2);pointer-events:none; }
.cert-doc-isro { font-family:var(--mono);font-size:8px;letter-spacing:4px;color:var(--dust);margin-bottom:12px; }
.cert-doc-title { font-family:var(--display);font-size:28px;color:var(--amber);letter-spacing:3px;margin-bottom:4px; }
.cert-doc-certifies { font-size:11px;color:var(--text-dim);margin-bottom:12px; }
.cert-doc-name { font-family:var(--ui);font-size:22px;font-weight:700;color:var(--text);border-bottom:1px solid var(--amber);padding-bottom:8px;margin-bottom:12px; }
.cert-doc-for { font-size:11px;color:var(--text-mid);margin-bottom:16px; }
.cert-doc-level { font-family:var(--mono);font-size:9px;color:var(--amber);letter-spacing:3px; }
.cert-doc-seal { font-size:40px;margin:16px 0 8px; }
.cert-doc-meta { display:flex;justify-content:space-between;margin-top:20px;font-family:var(--mono);font-size:8px;color:var(--text-dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN 6 â€” AI DECISION ANALYSIS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#screen-dar {
  background: var(--void2);
  display: flex; flex-direction: column;
  padding-top: var(--sat);
  padding-bottom: var(--sab);
}
.dar-body { flex:1;overflow-y:auto;padding:16px; }
.dar-summary-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px; }
.dar-metric { background:var(--panel);border:1px solid var(--border);padding:14px; }
.dar-metric-val { font-family:var(--display);font-size:26px;color:var(--mars-glow);margin-bottom:2px; }
.dar-metric-lbl { font-family:var(--mono);font-size:7px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase; }
.dar-section { margin-bottom:20px; }
.dar-section-title { font-family:var(--ui);font-weight:700;font-size:13px;color:var(--text);letter-spacing:1px;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border); }
.dar-ai-box { background:rgba(214,64,0,0.04);border:1px solid var(--border2);padding:14px;font-size:11px;color:var(--text-mid);line-height:1.8;position:relative;min-height:60px; }
.dar-ai-box .typing-cursor { display:inline-block;width:8px;height:14px;background:var(--mars);animation:cursor-blink 0.8s infinite;vertical-align:middle; }
@keyframes cursor-blink { 0%,50%{opacity:1} 51%,100%{opacity:0} }
.dar-ai-label { font-family:var(--mono);font-size:7px;color:var(--mars-glow);letter-spacing:3px;margin-bottom:6px; }
.event-timeline { display:flex;flex-direction:column;gap:8px; }
.event-item { display:flex;gap:10px;align-items:flex-start; }
.event-dot { width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:3px; }
.event-dot.good { background:var(--green); }
.event-dot.bad { background:var(--red); }
.event-dot.neutral { background:var(--text-dim); }
.event-text { font-family:var(--mono);font-size:9px;color:var(--text-dim);line-height:1.6; }
.event-text strong { color:var(--text-mid); }

/* Concept gaps */
.concept-gap { display:flex;align-items:center;gap:10px;margin-bottom:8px; }
.concept-name { font-family:var(--mono);font-size:9px;color:var(--text-mid);width:180px;flex-shrink:0; }
.concept-bar { flex:1;height:4px;background:#111;border:1px solid var(--border); }
.concept-fill { height:100%;background:var(--red);transition:width 0.8s; }
.concept-pct { font-family:var(--mono);font-size:9px;color:var(--red);width:30px;text-align:right; }

/* Survival index ring */
.survival-ring-wrap { display:flex;justify-content:center;margin:16px 0; }
.survival-ring { position:relative;width:140px;height:140px; }
.survival-ring svg { width:100%;height:100%;transform:rotate(-90deg); }
.survival-ring .ring-bg { fill:none;stroke:#111;stroke-width:8; }
.survival-ring .ring-fill { fill:none;stroke:var(--mars);stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease; }
.survival-ring-label { position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center; }
.survival-ring-pct { font-family:var(--display);font-size:28px;color:var(--text); }
.survival-ring-sub { font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
   FIX: respect iOS home-indicator area
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav {
  display: flex; border-top: 1px solid var(--border);
  background: var(--panel); flex-shrink: 0; z-index: 200;
  /* FIX: pad for home indicator on iPhone X+ */
  padding-bottom: var(--sab);
}
.nav-btn {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 3px; padding: 8px 4px;
  font-family: var(--mono); font-size: 7px; letter-spacing: 1px;
  color: var(--text-dim); cursor: pointer; border: none; background: none;
  transition: all 0.2s; text-transform: uppercase; border-top: 2px solid transparent;
  touch-action: manipulation;
}
.nav-btn.active { color: var(--mars-glow); border-top-color: var(--mars); }
.nav-btn:hover:not(.active) { color: var(--text-mid); }
.nav-icon { font-size: 18px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED TOPBAR PATTERN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-topbar {
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  padding: 10px 16px; border-bottom: 1px solid var(--border);
  background: var(--panel); flex-shrink: 0;
}
.page-title { font-family:var(--display);font-size:20px;color:var(--text);letter-spacing:2px; }
.page-back { font-family:var(--mono);font-size:9px;color:var(--text-dim);cursor:pointer;letter-spacing:1px;background:none;border:none; }
.page-back:hover { color:var(--text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPANSION TEASER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.expansion-grid { display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:12px; }
.expansion-card {
  background:var(--panel);border:1px solid var(--border);padding:16px;
  text-align:center;opacity:0.6;position:relative;overflow:hidden;
}
.expansion-card::after { content:'COMING SOON';position:absolute;top:8px;right:-20px;background:var(--mars);color:#fff;font-family:var(--mono);font-size:7px;letter-spacing:2px;padding:2px 28px;transform:rotate(45deg);transform-origin:center; }
.exp-icon { font-size:30px;margin-bottom:8px; }
.exp-name { font-family:var(--ui);font-weight:700;font-size:13px;color:var(--text);margin-bottom:4px; }
.exp-desc { font-size:10px;color:var(--text-dim);line-height:1.5; }

/* scrollbar */
::-webkit-scrollbar { width:4px;height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1);border-radius:2px; }

/* mobile-safe */
@media(max-width:400px) {
  .stats-row { grid-template-columns:1fr 1fr; }
  .dar-summary-grid { grid-template-columns:1fr 1fr; }
  /* FIX: make role cards full-width on very narrow screens */
  .role-card { width: calc(min(180px, 90vw)); }
}

  /* ==============================
   DEMO LOGIN OVERLAY (Single-HTML)
============================== */
#demo-login {
  position: fixed; inset: 0;
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  background: rgba(0,0,0,.78);
  backdrop-filter: blur(8px);
}

#demo-login.open { display: flex; }

.demo-card {
  width: min(440px, 100%);
  background: #0d1825;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 20px 70px rgba(0,0,0,.6);
}

.demo-pill {
  display: inline-block;
  font-family: var(--fm);
  font-size: .62rem;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(0,214,143,.35);
  color: var(--go);
  background: rgba(0,214,143,.08);
  margin-bottom: 10px;
}

.demo-title {
  font-family: var(--fn);
  font-weight: 900;
  font-size: 1.4rem;
  margin: 0 0 8px;
  color: var(--saffron);
}

.demo-text {
  color: rgba(232,237,245,.78);
  font-size: .92rem;
  line-height: 1.7;
  margin: 0 0 14px;
}

.demo-input {
  width: 100%;
  background: var(--bg-deep);
  border: 1px solid rgba(255,255,255,.14);
  color: #fff;
  padding: 12px 14px;
  border-radius: 12px;
  outline: none;
  font-size: .95rem;
}

.demo-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

.demo-btn {
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(13,24,37,.9);
  color: #fff;
  border-radius: 12px;
  padding: 11px 12px;
  cursor: pointer;
  font-weight: 800;
  font-family: var(--fm);
  font-size: .72rem;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.demo-btn.primary {
  border-color: rgba(255,153,51,.55);
  background: rgba(255,153,51,.16);
  color: var(--saffron);
}

.demo-err {
  display: none;
  margin-top: 10px;
  color: #f87171;
  font-size: .88rem;
}

.demo-tip {
  margin-top: 12px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px dashed rgba(255,153,51,.30);
  color: rgba(232,237,245,.75);
  font-size: .82rem;
  line-height: 1.6;
}

/* Small top banner inside the app */
#inapp-banner {
  position: fixed;
  top: 6px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  width: min(620px, 94vw);
  display: none;
  background: rgba(13,24,37,.92);
  border: 1px solid rgba(255,153,51,.25);
  border-radius: 14px;
  padding: 10px 12px;
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px rgba(0,0,0,.45);
}

#inapp-banner.show { display: block; }

#inapp-banner .row {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

#inapp-banner .msg {
  font-family: var(--fb);
  font-size: .85rem;
  color: rgba(232,237,245,.80);
  line-height: 1.4;
}

#inapp-banner .msg b { color: var(--saffron); }

#inapp-banner .bbtn {
  border: 1px solid rgba(0,214,143,.35);
  background: rgba(0,214,143,.10);
  color: var(--go);
  padding: 8px 10px;
  border-radius: 12px;
  font-family: var(--fm);
  font-size: .62rem;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  cursor: pointer;
}
#inapp-banner .xbtn {
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.75);
  padding: 8px 10px;
  border-radius: 12px;
  font-family: var(--fm);
  font-size: .62rem;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 0 â€” LANDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-landing" class="screen active">
  <!-- FIX: pointer-events:none on all decorative layers (set via CSS above) -->
  <div class="bg-grid"></div>
  <div class="bg-glow"></div>
  <div class="mars-sphere"></div>
  <div class="landing-content">
    <div class="landing-eyebrow">â—ˆ CONSTRAINT LEARNING ENGINE Â· V2.0</div>
    <div class="landing-title">MARS<br><em>DECISION</em><br>LAB</div>
    <div class="landing-subtitle">Geological Survey Mission HEX-01 Â· Sol 127</div>
    <div class="landing-tagline">
      A structured cognitive training system for STEM education.<br>
      Make real decisions under real constraints. Learn systems thinking through survival.
    </div>
    <div class="role-cards">
      <div class="role-card" onclick="enterAs('student')">
        <span class="role-icon">ğŸš€</span>
        <div class="role-name">Student</div>
        <div class="role-desc">Navigate missions, earn certifications, train your decision architecture</div>
        <div class="role-badge"><span class="pill green">Start Free</span></div>
      </div>
      <div class="role-card" onclick="enterAs('teacher')">
        <span class="role-icon">ğŸ“Š</span>
        <div class="role-name">Teacher</div>
        <div class="role-desc">Dashboard, class analytics, heatmaps, benchmark comparisons</div>
        <div class="role-badge"><span class="pill amber">Dashboard</span></div>
      </div>
      <div class="role-card" onclick="enterAs('demo')">
        <span class="role-icon">âš¡</span>
        <div class="role-name">Quick Demo</div>
        <div class="role-desc">Jump straight into an active mission â€” no setup required</div>
        <div class="role-badge"><span class="pill mars">Try Now</span></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAVIGATION (hidden on landing)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="bottom-nav" id="bottom-nav" style="display:none">
  <button class="nav-btn" id="nav-sim"      onclick="showScreen('sim')">      <span class="nav-icon">ğŸ®</span>MISSION</button>
  <button class="nav-btn" id="nav-missions" onclick="showScreen('missions')"> <span class="nav-icon">ğŸ“‹</span>MISSIONS</button>
  <button class="nav-btn" id="nav-skills"   onclick="showScreen('skills')">   <span class="nav-icon">ğŸŒ¿</span>SKILLS</button>
  <button class="nav-btn" id="nav-cert"     onclick="showScreen('cert')">     <span class="nav-icon">ğŸ†</span>CERTS</button>
  <button class="nav-btn" id="nav-dar"      onclick="showScreen('dar')">      <span class="nav-icon">ğŸ¤–</span>AI DAR</button>
  <button class="nav-btn" id="nav-teacher"  onclick="showScreen('teacher')">  <span class="nav-icon">ğŸ“Š</span>TEACHER</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” SIMULATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-sim" class="screen">
  <div class="sim-topbar">
    <div class="topbar-left">
      <div class="stat-chip">
        <div class="stat-chip-label">Energy</div>
        <div class="energy-bar">
          <div class="ebar-track"><div class="ebar-fill" id="eb" style="width:84%;background:var(--green)"></div></div>
          <span class="stat-chip-val" id="epct">84%</span>
        </div>
      </div>
      <div class="stat-chip">
        <div class="stat-chip-label">Risk Budget</div>
        <div class="energy-bar">
          <div class="ebar-track"><div class="ebar-fill" id="rb" style="width:0%;background:var(--green)"></div></div>
          <span class="stat-chip-val" id="rpct" style="color:var(--red)">0</span>
        </div>
      </div>
    </div>
    <div class="topbar-center">
      <div class="mission-badge" id="missionBadge">HEX-01</div>
      <div class="sol-line" id="solLine">SOL 127 Â· 10:04 Â· 1.2s RTT</div>
    </div>
    <div class="topbar-right">
      <div class="tier-display" id="tierDisplay">
        <span>T1</span><span style="color:var(--text-dim)">CADET</span>
      </div>
      <div class="stat-chip">
        <div class="stat-chip-label">Valid.</div>
        <div id="validPips" style="display:flex;gap:2px;margin-top:2px">
          <div class="val-pip" style="width:8px;height:8px;border:1px solid var(--green-dim);border-radius:1px"></div>
          <div class="val-pip" style="width:8px;height:8px;border:1px solid var(--green-dim);border-radius:1px"></div>
          <div class="val-pip" style="width:8px;height:8px;border:1px solid var(--green-dim);border-radius:1px"></div>
          <div class="val-pip" style="width:8px;height:8px;border:1px solid var(--green-dim);border-radius:1px"></div>
          <div class="val-pip" style="width:8px;height:8px;border:1px solid var(--green-dim);border-radius:1px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="sim-viewport" id="viewport">
    <div class="sky"></div>
    <div class="stars" id="stars-canvas-sim"></div>
    <div class="horizon-glow"></div>
    <div class="ground"></div>
    <div class="rocks" id="rocks" data-offset="0">
      <div class="rock" style="width:64px;height:32px;left:8%;bottom:0"></div>
      <div class="rock" style="width:28px;height:18px;left:22%;bottom:0"></div>
      <div class="rock" style="width:88px;height:38px;left:60%;bottom:0"></div>
      <div class="rock" style="width:44px;height:24px;left:80%;bottom:0"></div>
      <div class="rock" style="width:16px;height:10px;left:44%;bottom:0"></div>
    </div>
    <div class="rover-mast" id="roverMast">
      <div class="cam-head"><div class="cam-lens"></div><div class="cam-eye"></div></div>
      <div class="mast-pole"></div>
    </div>
    <div id="dustWrap"></div>

    <div class="terrain-info" id="terrainInfo">
      <div>TERRAIN: <span class="hi" id="t-name">Basaltic Flats</span></div>
      <div>COMPLEX: <span class="warn" id="t-complex">4.2</span></div>
      <div>QUADRANT: <span id="t-quad">A3-07</span></div>
      <div>DUST IDX: <span class="warn" id="t-dust">0.050</span></div>
      <div>RISK: <span class="crit" id="t-risk">0</span>/100</div>
      <div>PHASE: <span class="ok" id="t-phase">DAY</span></div>
      <div>XP: <span class="hi" id="t-xp">0</span></div>
    </div>

    <div class="risk-wrap">
      <div class="risk-label">RISK BUDGET</div>
      <div class="risk-track"><div class="risk-fill" id="riskFill" style="width:0%;background:var(--green)"></div></div>
      <div class="risk-pct" id="riskPct">0%</div>
    </div>

    <div class="scan-overlay" id="scanOverlay">
      <div class="scan-beam"></div>
      <div class="scan-corners">
        <span class="tl"></span><span class="tr"></span>
        <span class="bl"></span><span class="br"></span>
      </div>
    </div>

    <div class="night-layer" id="nightLayer"></div>
    <div class="storm-layer" id="stormLayer"></div>
    <div class="low-energy-ring" id="lowRing"></div>
    <div class="solar-ring" id="solarRing"></div>
  </div>

  <div class="sim-bottom">
    <div class="cam-panel">
      <div class="panel-lbl">// CAM FEED â€” HEX-01-A</div>
      <div class="cam-telem">
        <div><span class="k">TEMP  </span><span class="v" id="c-temp">-63Â°C</span></div>
        <div><span class="k">PRESS </span><span class="v">0.636 kPa</span></div>
        <div><span class="k">WIND  </span><span class="v" id="c-wind">4.2 m/s NNW</span></div>
        <div><span class="k">RAD   </span><span class="v" id="c-rad">0.18 mGy/d</span></div>
        <div><span class="k">STATE </span><span class="v green" id="c-state">IDLE</span></div>
        <div><span class="k">COOL  </span><span class="v amber" id="c-cool">READY</span></div>
      </div>
      <div class="scan-sweep-line"></div>
    </div>
    <div class="ctrl-panel">
      <div class="panel-lbl" style="align-self:stretch">// MOVEMENT â€” TAP OR SWIPE</div>
      <div class="dir-grid">
        <div class="dir-btn" onclick="move('NW')">â†–</div>
        <div class="dir-btn" onclick="move('N')">â†‘</div>
        <div class="dir-btn" onclick="move('NE')">â†—</div>
        <div class="dir-btn" onclick="move('W')">â†</div>
        <div class="dir-btn scan-btn" onclick="doScan()">SCAN</div>
        <div class="dir-btn" onclick="move('E')">â†’</div>
        <div class="dir-btn" onclick="move('SW')">â†™</div>
        <div class="dir-btn" onclick="move('S')">â†“</div>
        <div class="dir-btn" onclick="move('SE')">â†˜</div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” MISSION SELECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-missions" class="screen">
  <div class="page-topbar">
    <div class="page-title">MISSIONS</div>
    <span class="pill mars" id="missions-tier-badge">CADET Â· T1</span>
  </div>
  <div class="missions-body">
    <div class="mission-grid" id="missionGrid"></div>
    <div style="margin-top:24px">
      <div style="font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-bottom:10px">EXPANSION MODULES â€” CONSTRAINT LEARNING ENGINE</div>
      <div class="expansion-grid">
        <div class="expansion-card"><div class="exp-icon">ğŸŒŠ</div><div class="exp-name">Disaster Response</div><div class="exp-desc">Earthquake search & rescue under cascading failure</div></div>
        <div class="expansion-card"><div class="exp-icon">ğŸŒ</div><div class="exp-name">Climate Policy</div><div class="exp-desc">Carbon neutrality decisions under political constraints</div></div>
        <div class="expansion-card"><div class="exp-icon">ğŸ’¡</div><div class="exp-name">Startup Capital</div><div class="exp-desc">Runway management, hiring, and fundraising under burn rate</div></div>
        <div class="expansion-card"><div class="exp-icon">ğŸ¦ </div><div class="exp-name">Pandemic Response</div><div class="exp-desc">Public health trade-offs under exponential spread</div></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” SKILL TREE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-skills" class="screen">
  <div class="page-topbar">
    <div class="page-title">SKILL TREE</div>
    <span class="pill green" id="skills-xp-badge">0 XP</span>
  </div>
  <div class="skills-body" id="skillsBody"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” CERTIFICATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-cert" class="screen">
  <div class="page-topbar">
    <div class="page-title">CERTIFICATIONS</div>
    <span class="pill amber" id="cert-earned-badge">0 EARNED</span>
  </div>
  <div class="cert-body">
    <div class="cert-levels" id="certLevels"></div>
  </div>
</div>

<!-- Certificate Viewer -->
<div class="cert-viewer-overlay" id="certViewer">
  <div class="cert-doc" id="certDoc"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5 â€” AI DECISION ANALYSIS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-dar" class="screen">
  <div class="page-topbar">
    <div class="page-title">AI ANALYSIS</div>
    <span class="pill mars" id="dar-run-badge">NO RUN YET</span>
  </div>
  <div class="dar-body" id="darBody">
    <div style="text-align:center;padding:40px 20px;color:var(--text-dim);font-family:var(--mono);font-size:10px;letter-spacing:2px">
      COMPLETE A MISSION TO GENERATE<br>YOUR DECISION ANALYSIS REPORT
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 6 â€” TEACHER DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-teacher" class="screen">
  <div class="page-topbar">
    <div class="page-title">TEACHER DASHBOARD</div>
    <div style="display:flex;gap:8px">
      <span class="pill green">LIVE</span>
      <span class="pill amber">CLASS: 9B</span>
    </div>
  </div>
  <div class="teacher-body">
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
      <button class="tab-btn" onclick="switchTab('students')">Students</button>
      <button class="tab-btn" onclick="switchTab('heatmap')">Heatmap</button>
      <button class="tab-btn" onclick="switchTab('benchmarks')">Benchmarks</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="tab-content active" id="tab-overview">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-card-val green" id="tc-avg-si">68</div>
          <div class="stat-card-lbl">Avg Survival Index</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-val" id="tc-acc">72%</div>
          <div class="stat-card-lbl">Decision Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-val amber" id="tc-risks">4</div>
          <div class="stat-card-lbl">Risk Events</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-val red" id="tc-depleted">3</div>
          <div class="stat-card-lbl">Energy Depletions</div>
        </div>
      </div>

      <div style="margin-bottom:14px">
        <div style="font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:8px">STORM DECISION SPLIT â€” CLASS 9B (22 STUDENTS)</div>
        <div style="display:flex;gap:0;height:20px;width:100%;border:1px solid var(--border)">
          <div id="stormHaltBar" style="height:100%;background:var(--green);transition:width 0.8s" title="HALT"></div>
          <div id="stormOverBar" style="height:100%;background:var(--red);transition:width 0.8s" title="OVERRIDE"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:8px;color:var(--text-dim);margin-top:4px">
          <span><span style="color:var(--green)">HALT</span> â€” <span id="stormHaltPct">64%</span></span>
          <span><span style="color:var(--red)">OVERRIDE</span> â€” <span id="stormOverPct">36%</span></span>
        </div>
      </div>

      <div>
        <div style="font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:8px">TOP CONCEPT ERRORS THIS SESSION</div>
        <div id="topErrors"></div>
      </div>
    </div>

    <!-- STUDENTS TAB -->
    <div class="tab-content" id="tab-students">
      <table class="student-table" id="studentTable">
        <thead>
          <tr>
            <th>Student</th><th>Tier</th><th>Survival Index</th>
            <th>Accuracy</th><th>Risk Evts</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="studentBody"></tbody>
      </table>
    </div>

    <!-- HEATMAP TAB -->
    <div class="tab-content" id="tab-heatmap">
      <div style="font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:10px">
        DECISION MISTAKE HEATMAP â€” % WRONG PER CONCEPT PER STUDENT
      </div>
      <div id="heatmapWrap" style="overflow-x:auto"></div>
      <div class="heatmap-legend">
        <div class="legend-swatch" style="background:rgba(61,255,143,0.15)"></div><span>0â€“20%</span>
        <div class="legend-swatch" style="background:rgba(255,184,48,0.3)"></div><span>21â€“60%</span>
        <div class="legend-swatch" style="background:rgba(255,59,59,0.5)"></div><span>61â€“100%</span>
        <div class="legend-swatch" style="background:#111"></div><span>No data</span>
      </div>
    </div>

    <!-- BENCHMARKS TAB -->
    <div class="tab-content" id="tab-benchmarks">
      <div style="font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:10px">
        CLASS 9B vs NATIONAL COHORT (AGE 14â€“15)
      </div>
      <div class="bench-wrap" id="benchmarkWrap"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Node Modal -->
<div class="modal-bg" id="nodeModal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">// GEOLOGICAL NODE DETECTED</div>
      <div class="modal-sub" id="nodeModalSub">SECTOR A3 Â· APXS CONTACT RANGE</div>
    </div>
    <div class="modal-body">
      <div class="node-terrain-card">
        <div class="ntc-name" id="nm-name">Basaltic Flats</div>
        <div class="ntc-stats">
          <div class="ntc-stat"><div class="ntc-stat-lbl">Complexity Index</div><div class="ntc-stat-val" id="nm-complex">4.2</div></div>
          <div class="ntc-stat"><div class="ntc-stat-lbl">Success Rate</div><div class="ntc-stat-val" id="nm-success">72%</div></div>
          <div class="ntc-stat"><div class="ntc-stat-lbl">Energy Cost</div><div class="ntc-stat-val">âˆ’8%</div></div>
          <div class="ntc-stat"><div class="ntc-stat-lbl">Cooldown</div><div class="ntc-stat-val">3 ticks</div></div>
        </div>
      </div>
      <p style="font-size:11px;color:var(--text-dim);line-height:1.7">APXS integration will take approximately 30 minutes Sol time. Instrument reliability may affect scan quality under dust or thermal stress.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="initiateScan()">INITIATE SCAN</button>
      <button class="btn btn-secondary" onclick="closeModal('nodeModal')">WITHDRAW</button>
    </div>
  </div>
</div>

<!-- Challenge Modal -->
<div class="modal-bg" id="challengeModal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="chal-title">// SCAN ANALYSIS</div>
      <div class="modal-sub" id="chal-sub">APXS DATA REQUIRES INTERPRETATION</div>
    </div>
    <div class="modal-body">
      <div class="challenge-q" id="chal-q">Loading...</div>
      <div class="choices" id="chal-choices"></div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal-bg" id="resultModal">
  <div class="modal">
    <div class="modal-body" style="padding-top:20px">
      <div class="result-icon" id="res-icon">âœ“</div>
      <div class="result-title" id="res-title">LOGGED</div>
      <div class="result-deltas" id="res-deltas"></div>
      <div class="explanation-box" id="res-exp" style="display:none">
        <div class="exp-lbl">â—ˆ EXPLANATION</div>
        <p id="res-exp-text"></p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('resultModal')">CONTINUE MISSION</button>
      <button class="btn btn-ghost" onclick="openDAR()">VIEW AI ANALYSIS â†’</button>
    </div>
  </div>
</div>

<!-- Storm Modal -->
<div class="modal-bg" id="stormModal">
  <div class="modal">
    <div class="modal-body" style="padding-top:20px">
      <div class="storm-icon-big">âš¡</div>
      <div style="font-family:var(--display);font-size:20px;color:var(--amber);text-align:center;margin-bottom:12px;letter-spacing:2px">DUST STORM INCOMING</div>
      <div style="font-size:11px;color:var(--text-dim);line-height:1.9;margin-bottom:6px">
        <div>VISIBILITY: <span style="color:var(--red)">DEGRADED</span></div>
        <div>SOLAR EFFICIENCY: <span style="color:var(--amber)">âˆ’40%</span></div>
        <div>SIGNAL LATENCY: <span style="color:var(--amber)">+3.2s</span></div>
        <div>DUST ACCUMULATION: <span style="color:var(--red)">ACCELERATING</span></div>
      </div>
      <p style="font-size:11px;color:var(--text-dim);margin-top:10px">HALT adds +2 risk but preserves energy. OVERRIDE adds +8 risk but maintains momentum.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-green" onclick="pauseForStorm()">HALT & WAIT (+2 RISK)</button>
      <button class="btn btn-secondary" onclick="overrideStorm()">OVERRIDE (+8 RISK)</button>
    </div>
  </div>
</div>

<!-- Energy Fail Modal -->
<div class="modal-bg" id="efailModal">
  <div class="modal">
    <div class="modal-body" style="padding-top:20px">
      <div style="font-size:28px;text-align:center;margin-bottom:8px">ğŸ”‹</div>
      <div class="efail-title" style="text-align:center;margin-bottom:10px">ENERGY DEPLETED</div>
      <p style="font-size:11px;color:var(--text-dim);line-height:2;margin-bottom:8px">HEX-01 has entered power-save mode. Awaiting solar recharge cycle. Est. recovery: 2h 18m [Mars Sol]</p>
    </div>
    <div class="modal-footer" style="flex-direction:column">
      <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="solarRecover()">WAIT FOR SOLAR RECHARGE</button>
      <button class="btn btn-secondary" style="width:100%;justify-content:center;margin-top:4px" onclick="endMission()">END MISSION & REVIEW</button>
    </div>
  </div>
</div>

<!-- Risk Abort Modal -->
<div class="modal-bg" id="riskModal">
  <div class="modal">
    <div class="modal-body" style="padding-top:20px">
      <div style="font-size:28px;text-align:center;margin-bottom:8px">ğŸš¨</div>
      <div class="rabort-title" style="text-align:center;margin-bottom:10px">MISSION ABORT</div>
      <p style="font-size:11px;color:var(--text-dim);line-height:2">Cumulative risk budget exceeded 100. Ground control has placed HEX-01 in emergency safe mode. Mission integrity compromised.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" style="width:100%;justify-content:center" onclick="endMission()">REVIEW MISSION DATA</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-wrap"></div>

<script>

  /* ==============================
   DEMO LOGIN GUARD (Single-HTML)
============================== */
const DEMO_AUTH_KEY = "mars_demo_session_v1";
const DEMO_CODE = "MARS200"; // change anytime

function isInAppBrowser() {
  const ua = navigator.userAgent || "";
  return /Instagram|FBAN|FBAV|FB_IAB|Line|Twitter|Snapchat/i.test(ua);
}

function isDemoAuthed() {
  try { return localStorage.getItem(DEMO_AUTH_KEY) === "1"; }
  catch(e) { return false; }
}

function setDemoAuthed() {
  try { localStorage.setItem(DEMO_AUTH_KEY, "1"); } catch(e) {}
}

function openDemoLogin() {
  const modal = document.getElementById("demo-login");
  if (!modal) return;
  modal.classList.add("open");
  modal.setAttribute("aria-hidden", "false");
  const inp = document.getElementById("demo-code");
  const err = document.getElementById("demo-err");
  if (err) err.style.display = "none";
  setTimeout(() => inp?.focus(), 150);
}

function closeDemoLogin() {
  const modal = document.getElementById("demo-login");
  if (!modal) return;
  modal.classList.remove("open");
  modal.setAttribute("aria-hidden", "true");
}

function demoUnlock() {
  const v = (document.getElementById("demo-code")?.value || "").trim().toUpperCase();
  const err = document.getElementById("demo-err");
  if (v === DEMO_CODE) {
    setDemoAuthed();
    closeDemoLogin();
    // now actually enter the app
    enterApp(true);
  } else {
    if (err) err.style.display = "block";
  }
}

  function enterApp(force = false){
  // âœ… If not authed, show demo login overlay and STOP.
  if (!force && !isDemoAuthed()) {
    openDemoLogin();
    return;
  }

  introGone = true;
  clearInterval(introTimer);

  const iw = document.getElementById('intro-wrapper');
  const aw = document.getElementById('app-wrapper');

  iw.classList.add('exiting');
  aw.classList.add('visible');

  document.body.style.overflowY = 'hidden';

  setTimeout(()=>{ iw.classList.add('hidden'); }, 900);

  if(!appBooted) { appBooted=true; appBoot(); }

  // âœ… show â€œopen in browserâ€ helper if needed
  showInAppBannerIfNeeded();
  }

  
function demoOpenInBrowserTip() {
  alert("Instagram/Facebook: tap â‹¯ (top right) â†’ Open in browser (Chrome) for best experience.");
}

function showInAppBannerIfNeeded() {
  const b = document.getElementById("inapp-banner");
  if (!b) return;
  if (isInAppBrowser()) b.classList.add("show");
}

function hideInAppBanner() {
  const b = document.getElementById("inapp-banner");
  if (b) b.classList.remove("show");
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const GS = {
  energy: 84,
  solNumber: 127, timeFrac: 0.42, dust: 0.05, risk: 0,
  instrumentCooldown: 0, instrumentReliability: 1.0,
  roverState: 'IDLE', stormActive: false, isCharging: false,
  scanningActive: false, stepCount: 0, latencyMs: 1200,
  nodeProximity: 0,
  xp: 0, tier: 1, validation: 0,
  missionsCompleted: [],
  currentMissionId: 1,
  metrics: { moves:0, scans:0, correct:0, wrong:0, slips:0, storms:0, latencyPenalty:0, stormHalt:0, stormOverride:0 },
  log: [],
  runId: null, startTs: null, endedTs: null,
  lastRunSurvivalIndex: null,
  skillNodes: {},
  badges: [],
  role: 'student',
};

const MARS = { SOL_MINUTES:1477, NIGHT_START:0.78, NIGHT_END:0.22, MAX_RISK:100 };

const TERRAINS = [
  {id:1, name:'Basaltic Flats',  complex:4.2, success:72, quadrant:'A3-07'},
  {id:2, name:'Regolith Field',  complex:5.8, success:61, quadrant:'A3-12'},
  {id:3, name:'Basaltic Ridge',  complex:7.4, success:42, quadrant:'A3-19'},
  {id:4, name:'Scoria Outcrop',  complex:6.1, success:55, quadrant:'B1-03'},
  {id:5, name:'Sulfate Layer',   complex:8.9, success:38, quadrant:'B1-08'},
  {id:6, name:'Hematite Sphere', complex:9.2, success:32, quadrant:'C2-11'},
];

const CHALLENGES = [
  {
    id:'fe2o3', category:'Iron Mineralogy',
    q:"Spectral analysis shows Feâ‚‚Oâ‚ƒ concentrations of 18.2%. What does this primarily indicate about the surface mineralogy?",
    options:[
      {t:'A. Active volcanic degassing',                    correct:false},
      {t:'B. Oxidized iron â€” ancient aqueous or atmospheric oxidation', correct:true},
      {t:'C. Presence of subsurface ice deposits',           correct:false},
      {t:'D. Recent meteorite impact event',                 correct:false},
    ],
    exp:"Feâ‚‚Oâ‚ƒ (haematite) forms when iron is oxidised by water or an oxygen-bearing atmosphere over geological time. Mars's red colour is largely due to this iron oxide. It's strong evidence of ancient aqueous processes."
  },
  {
    id:'pressure', category:'Atmospheric Dynamics',
    q:"REMS sensor shows an unexpected pressure spike of +0.8 kPa over 4 minutes. Most probable cause?",
    options:[
      {t:'A. Sensor calibration error',           correct:false},
      {t:'B. Localised dust devil passing rover', correct:true},
      {t:'C. Methane release from subsurface',    correct:false},
      {t:'D. Solar wind interaction',             correct:false},
    ],
    exp:'Dust devils on Mars create localised low-pressure vortices. As one passes a sensor, it causes a transient pressure drop followed by a spike as the vortex exits. The 4-minute duration is characteristic of a small dust devil (~50m diameter) at 4 m/s.'
  },
  {
    id:'lamination', category:'Sedimentary Analysis',
    q:"Rock samples show alternating light/dark layering at 2mm intervals. This lamination pattern most strongly suggests:",
    options:[
      {t:'A. Impact shock metamorphism',             correct:false},
      {t:'B. Cyclic seasonal sediment deposition',   correct:true},
      {t:'C. Lava flow cooling fractures',           correct:false},
      {t:'D. Eolian cross-bedding',                  correct:false},
    ],
    exp:'Regular lamination at millimetre scale is a hallmark of rhythmite â€” sediment deposited in regular cycles. On Mars this likely reflects seasonal variations in wind strength, frost deposition, or dust storm frequency. It is a key indicator of ancient climate cyclicity.'
  },
  {
    id:'felsic', category:'Igneous Petrology',
    q:"ChemCam detects elevated SiOâ‚‚ (62%) with low FeO. In Mars geological context, this suggests:",
    options:[
      {t:'A. Ultramafic mantle extrusion',           correct:false},
      {t:'B. Felsic igneous intrusion â€” rare on Mars', correct:true},
      {t:'C. Evaporitic salt deposit',               correct:false},
      {t:'D. Carbonaceous chondrite inclusion',      correct:false},
    ],
    exp:'Mars is predominantly basaltic (mafic), with SiOâ‚‚ typically below 52%. Finding 62% SiOâ‚‚ suggests a felsic or intermediate intrusive body â€” possibly a product of magmatic differentiation. Such rocks are rare and scientifically significant on Mars.'
  },
  {
    id:'apxs_lockup', category:'Instrument Protocols',
    q:"During APXS integration, the instrument generates artificial counts at the lowest energy channel (lockup anomaly). Required mitigation?",
    options:[
      {t:'A. Increase integration time to 5 hours to override the buffer',   correct:false},
      {t:'B. Power cycle and split long integrations into two shorter sessions', correct:true},
      {t:'C. Deploy arm to calibration slab to reset Curium-244 flux',        correct:false},
    ],
    exp:'The APXS lockup anomaly is a known firmware bug where the ADC gets stuck, flooding the lowest energy channel with artificial counts. The fix is to power cycle the instrument and avoid very long single integrations â€” splitting into 2Ã—3h sessions prevents buffer overflow.'
  },
  {
    id:'energy_storm', category:'Resource Strategy',
    q:"Energy is critically low and a storm approaches. Optimal strategy?",
    options:[
      {t:'A. Sprint to nearest node before storm hits',          correct:false},
      {t:'B. Deploy science instruments immediately',            correct:false},
      {t:'C. Park facing optimal solar angle, power down non-essentials', correct:true},
      {t:'D. Increase signal frequency to Earth',               correct:false},
    ],
    exp:'With low energy and an incoming storm, the priority is survival. Parking with the solar panels at the optimal angle maximises any available solar input. Powering down non-essential systems (heaters for non-critical components, science instruments, high-gain antenna steering) extends the power budget until the storm clears.'
  },
  {
    id:'sulfate', category:'Iron Mineralogy',
    q:"APXS detects high SOâ‚ƒ (>15%) and CaO. This geochemical signature most likely indicates:",
    options:[
      {t:'A. Hydrothermal vent deposit with sulfide minerals',   correct:false},
      {t:'B. Calcium sulfate (gypsum/anhydrite) evaporite layer', correct:true},
      {t:'C. Volcanic tuff with calcium-rich plagioclase',       correct:false},
      {t:'D. Impact melt glass with sulfur contamination',       correct:false},
    ],
    exp:'High SOâ‚ƒ combined with CaO is diagnostic of calcium sulfate minerals â€” gypsum (CaSOâ‚„Â·2Hâ‚‚O) or anhydrite (CaSOâ‚„). These are evaporite minerals that form when sulfate-rich brines evaporate, and are strong indicators of ancient liquid water at the site.'
  },
  {
    id:'hematite_spheres', category:'Sedimentary Analysis',
    q:"Small spherical concretions (~5mm diameter) are observed throughout the rock matrix. Their most likely formation process?",
    options:[
      {t:'A. Aerosol droplet solidification during volcanic eruption', correct:false},
      {t:'B. Authigenic precipitation from iron-rich groundwater',    correct:true},
      {t:'C. Micro-meteorite impacts in soft sediment',               correct:false},
      {t:'D. Frost heave cycling over millions of years',             correct:false},
    ],
    exp:'These are "blueberries" â€” haematite concretions analogous to those found by Opportunity at Meridiani Planum. They form when iron-rich groundwater percolates through porous sediment and precipitates haematite spherically around nucleation points. They are strong evidence of past liquid water.'
  }
];

const MISSIONS = [
  {id:1, name:'First Contact',     unlockTier:1, constraint:'Energy management basics',            objective:'Complete 3 APXS scans without energy depletion', maxRisk:80, completed:false},
  {id:2, name:'Dust Season',       unlockTier:1, constraint:'Dust accumulation + storm decisions', objective:'Navigate a storm event â€” HALT scores bonus points', maxRisk:75, completed:false},
  {id:3, name:'Night Operations',  unlockTier:1, constraint:'Night cycle energy drain',           objective:'Complete 2 scans surviving the night cycle', maxRisk:70, completed:false},
  {id:4, name:'Mineral Survey',    unlockTier:2, constraint:'Multi-terrain APXS analysis',        objective:'Achieve 80%+ challenge accuracy across 4+ scans', maxRisk:65, completed:false},
  {id:5, name:'Cascade Failure',   unlockTier:2, constraint:'Risk budget + instrument reliability', objective:'Complete mission with risk budget below 40/100', maxRisk:100, completed:false},
  {id:6, name:'Extended Survey',   unlockTier:3, constraint:'All constraints active simultaneously', objective:'Achieve Survival Index above 70% across full run', maxRisk:100, completed:false},
];

const SKILL_BRANCHES = [
  {
    id:'energy', icon:'âš¡', name:'Energy Systems',
    nodes:[
      {id:'e1', name:'Solar Basics',       req:'Complete M01',             unlocked:false},
      {id:'e2', name:'Night Planning',     req:'Score >60% in night cycle', unlocked:false},
      {id:'e3', name:'Storm Response',     req:'HALT 3 storms',             unlocked:false},
      {id:'e4', name:'Compound Degradation', req:'Reach T3',               unlocked:false},
    ]
  },
  {
    id:'geology', icon:'ğŸª¨', name:'Geological Analysis',
    nodes:[
      {id:'g1', name:'Rock Identification', req:'Complete 5 scans',          unlocked:false},
      {id:'g2', name:'Mineral Chemistry',   req:'3 correct mineral analyses', unlocked:false},
      {id:'g3', name:'Stratigraphy',        req:'Answer lamination Q correctly', unlocked:false},
      {id:'g4', name:'Comparative Planetology', req:'Complete M04',          unlocked:false},
    ]
  },
  {
    id:'risk', icon:'âš–ï¸', name:'Risk Architecture',
    nodes:[
      {id:'r1', name:'Hazard ID',           req:'First traction slip avoided', unlocked:false},
      {id:'r2', name:'Budget Management',   req:'Complete M05 <40 risk',       unlocked:false},
      {id:'r3', name:'Cascade Prevention',  req:'Complete M05',                unlocked:false},
      {id:'r4', name:'FMEA Fundamentals',   req:'Reach T4',                    unlocked:false},
    ]
  },
  {
    id:'systems', icon:'ğŸ”§', name:'Systems Engineering',
    nodes:[
      {id:'s1', name:'Constraint Mapping',  req:'Complete 3 missions',         unlocked:false},
      {id:'s2', name:'Trade-off Analysis',  req:'5 storm decisions made',       unlocked:false},
      {id:'s3', name:'Multi-var Optimisation', req:'Complete M06',             unlocked:false},
      {id:'s4', name:'Failure Mode Response', req:'Survive instrument anomaly', unlocked:false},
    ]
  },
];

const CERTS = [
  {
    level:1, name:'Mars Systems Explorer',
    req:'Complete 3 Beginner missions',
    skills:'Basic constraint awareness, resource vocabulary, energy system fundamentals',
    progress:()=> Math.min(3, GS.missionsCompleted.length),
    total:3,
    earned:()=> GS.missionsCompleted.length >= 1,
  },
  {
    level:2, name:'Geological Survey Analyst',
    req:'Score 70%+ in 5 Assessment missions',
    skills:'APXS interpretation, risk identification, trade-off analysis, sedimentary reasoning',
    progress:()=> Math.min(5, GS.missionsCompleted.length),
    total:5,
    earned:()=> GS.missionsCompleted.length >= 3 && GS.metrics.correct >= 5,
  },
  {
    level:3, name:'Mars Mission Planner',
    req:'Top 30% cohort in Classroom mode + teacher endorsement',
    skills:'Strategic planning, multi-variable optimisation, team coordination, risk architecture',
    progress:()=> GS.missionsCompleted.length >= 3 ? 1 : 0,
    total:3,
    earned:()=> false,
  },
  {
    level:4, name:'Constraint Systems Engineer',
    req:'Complete all 3 simulators (Mars + 1 expansion)',
    skills:'Cross-domain systems thinking, transferable decision architecture, failure mode engineering',
    progress:()=> 0,
    total:5,
    earned:()=> false,
  },
];

const TEACHER_STUDENTS = [
  {name:'Arjun S.',   tier:2, si:78, acc:82, riskEvts:2, status:'ACTIVE'},
  {name:'Meera R.',   tier:1, si:54, acc:61, riskEvts:5, status:'STORM_WAIT'},
  {name:'Rohan P.',   tier:2, si:71, acc:74, riskEvts:3, status:'SCANNING'},
  {name:'Priya K.',   tier:1, si:48, acc:55, riskEvts:6, status:'LOW_ENERGY'},
  {name:'Dev T.',     tier:3, si:89, acc:91, riskEvts:1, status:'ACTIVE'},
  {name:'Ananya M.',  tier:2, si:66, acc:70, riskEvts:4, status:'ACTIVE'},
  {name:'Karan J.',   tier:1, si:41, acc:48, riskEvts:7, status:'DEPLETED'},
  {name:'Sneha B.',   tier:2, si:73, acc:76, riskEvts:2, status:'ACTIVE'},
];

const HEATMAP_CONCEPTS = ['Iron Mineralogy','Atmospheric Dynamics','Sedimentary Analysis','Igneous Petrology','Instrument Protocols','Resource Strategy'];
const HEATMAP_DATA = [
  [10,55,25,80,60,15],
  [45,70,35,90,50,20],
  [20,40,15,65,45,10],
  [75,85,60,95,70,40],
  [5, 15,10,20,10,5 ],
  [30,60,40,70,55,25],
  [80,90,75,100,80,55],
  [15,35,20,55,30,10],
];

const BENCHMARK_DATA = [
  {name:'Survival Index',       class:68, national:61, district:64},
  {name:'Decision Accuracy',    class:72, national:58, district:65},
  {name:'Risk Management',      class:64, national:52, district:57},
  {name:'Resource Efficiency',  class:70, national:63, district:67},
  {name:'Latency Adaptation',   class:55, national:49, district:51},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTRAINT ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function isNight(){ return GS.timeFrac > MARS.NIGHT_START || GS.timeFrac < MARS.NIGHT_END; }
function solarEff(){ return isNight() ? 0 : (1 - GS.dust); }

function advanceTime(frac){
  GS.timeFrac += frac;
  if(GS.timeFrac >= 1){ GS.timeFrac -= 1; GS.solNumber++; toast('SOL '+GS.solNumber+' â€” NEW MARTIAN DAY'); }
}

function updateThermal(){
  const t = -70 + 40*Math.sin(GS.timeFrac * Math.PI * 2);
  if(t < -60) GS.instrumentReliability = Math.max(0.1, GS.instrumentReliability - 0.005);
  const el = document.getElementById('c-temp'); if(el) el.textContent = t.toFixed(1)+'Â°C';
}

function updateDust(){
  GS.dust += GS.stormActive ? 0.008 : 0.001;
  GS.dust = Math.min(0.9, GS.dust);
}

function updateEnergyPassive(){
  if(GS.isCharging){ GS.energy += solarEff()*0.5; }
  else if(isNight()){ GS.energy -= 0.15; }
  else { GS.energy += solarEff()*0.3; }
  GS.energy = Math.max(0, Math.min(100, GS.energy));
}

function riskCheck(){
  if(GS.risk >= MARS.MAX_RISK){
    GS.endedTs = nowISO();
    logEvent('RUN_END',{reason:'RISK_BUDGET'});
    closeAllModals();
    openModal('riskModal');
  }
}

function constraintTick(){
  if(!document.getElementById('screen-sim').classList.contains('active')) return;
  if(GS.instrumentCooldown > 0){ GS.instrumentCooldown--; }
  advanceTime(0.0006);
  updateThermal();
  updateDust();
  updateEnergyPassive();
  updateAllUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOVEMENT & SCANNING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let moveTimeout = null;
let _ambTimers = [];

function move(dir){
  if(GS.scanningActive){ toast('CANNOT MOVE DURING SCAN'); return; }
  if(GS.energy <= 5){ toast('CRITICAL ENERGY â€” MOVEMENT BLOCKED'); return; }
  if(GS.roverState === 'MOVING') return;

  const fb = document.getElementById('c-state');
  if(fb){ fb.textContent = 'MOVING'; fb.className='v amber'; }
  setState('MOVING');

  clearTimeout(moveTimeout);
  moveTimeout = setTimeout(()=>{
    advanceTime(0.01);
    updateThermal();
    updateDust();

    if(Math.random() < GS.dust * 0.6){
      GS.risk += 5;
      GS.metrics.slips++;
      logEvent('DUST_SLIP',{dust:GS.dust,risk:GS.risk});
      toast('TRACTION LOSS â€” DUST HAZARD');
    }

    riskCheck();
    if(GS.risk >= MARS.MAX_RISK) return;

    const drain = 1.5 + Math.random()*0.5 + (isNight()?0.5:0);
    modEnergy(-drain);
    GS.metrics.moves++;
    GS.stepCount++;
    GS.xp += 2;

    const rocks = document.getElementById('rocks');
    const shifts={N:0,S:0,E:-2,W:2,NE:-1,NW:1,SE:-1,SW:1};
    const offset = parseFloat(rocks.dataset.offset||0)+(shifts[dir]||0);
    rocks.dataset.offset = offset;
    rocks.style.transform = `translateX(${offset}px)`;
    spawnDust();

    if(!GS.stormActive && Math.random() < GS.dust*0.3){
      GS.metrics.storms++;
      triggerStorm();
    }

    GS.nodeProximity += 0.18 + Math.random()*0.08;
    if(GS.nodeProximity >= 1){ GS.nodeProximity=0; openNodeModal(); }

    logEvent('MOVE',{dir,drain,risk:GS.risk});
    setState('IDLE');
    updateAllUI();

    if(GS.energy <= 0){ showEnergyFail(); }
    else if(GS.energy < 15){ document.getElementById('lowRing').classList.add('active'); }
    else { document.getElementById('lowRing').classList.remove('active'); }
  }, GS.latencyMs);

  document.getElementById('roverMast').classList.add('moving');
  setTimeout(()=>document.getElementById('roverMast').classList.remove('moving'), GS.latencyMs+200);
}

function doScan(){
  if(GS.instrumentCooldown > 0){ toast('INSTRUMENT COOLING â€” '+GS.instrumentCooldown+'s'); return; }
  if(GS.energy < 8){ toast('INSUFFICIENT ENERGY FOR SCAN'); return; }
  if(GS.scanningActive) return;
  if(GS.roverState === 'MOVING'){ toast('CEASE MOVEMENT BEFORE SCANNING'); return; }
  openNodeModal();
}

function openNodeModal(){
  const terrain = TERRAINS[Math.floor(Math.random()*TERRAINS.length)];
  GS._currentTerrain = terrain;
  document.getElementById('nm-name').textContent    = terrain.name;
  document.getElementById('nm-complex').textContent = terrain.complex;
  document.getElementById('nm-success').textContent  = terrain.success+'%';
  openModal('nodeModal');
  updateTerrainOverlay(terrain);
}

function initiateScan(){
  closeModal('nodeModal');
  if(GS.energy < 8){ toast('INSUFFICIENT ENERGY'); return; }

  advanceTime(0.02);
  updateThermal(); updateDust();

  modEnergy(-8);
  GS.scanningActive = true;
  GS.metrics.scans++;
  setState('SCANNING');
  document.getElementById('scanOverlay').classList.add('active');
  logEvent('SCAN_START',{terrain:GS._currentTerrain.name});

  setTimeout(()=>{
    document.getElementById('scanOverlay').classList.remove('active');
    GS.scanningActive = false;

    const successChance = GS.instrumentReliability - GS.dust*0.4;
    if(Math.random() > successChance){
      GS.risk += 4;
      GS.metrics.slips++;
      toast('INSTRUMENT ANOMALY â€” SCAN DEGRADED');
      logEvent('SCAN_ANOMALY',{risk:GS.risk});
    }
    GS.instrumentCooldown = 3;
    setState('IDLE');
    openChallenge();
    riskCheck();
    updateAllUI();
  }, 2000);
  updateAllUI();
}

function openChallenge(){
  const c = CHALLENGES[Math.floor(Math.random()*CHALLENGES.length)];
  GS._currentChallenge = c;
  document.getElementById('chal-title').textContent = `// ${(GS._currentTerrain?.name||'SECTOR').toUpperCase()} â€” ANALYSIS`;
  document.getElementById('chal-sub').textContent   = `CATEGORY: ${c.category.toUpperCase()}`;
  document.getElementById('chal-q').textContent     = c.q;
  const choicesEl = document.getElementById('chal-choices');
  choicesEl.innerHTML = '';
  c.options.forEach((opt,i)=>{
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt.t;
    btn.onclick = () => evaluateAnswer(i);
    choicesEl.appendChild(btn);
  });
  openModal('challengeModal');
}

function evaluateAnswer(idx){
  const btns = document.querySelectorAll('.choice-btn');
  btns.forEach(b=>b.onclick=null);
  const correct = GS._currentChallenge.options[idx].correct;
  GS._currentChallenge.options.forEach((o,i)=>{ if(o.correct) btns[i].classList.add('correct'); });
  if(!correct) btns[idx].classList.add('wrong');
  logEvent('ANSWER',{correct, cat:GS._currentChallenge.category});

  setTimeout(()=>{
    closeModal('challengeModal');
    showResult(correct);
  }, 1100);
}

function showResult(correct){
  const ri = document.getElementById('res-icon');
  const rt = document.getElementById('res-title');
  const rd = document.getElementById('res-deltas');
  const rx = document.getElementById('res-exp');
  const rxt = document.getElementById('res-exp-text');

  if(correct){
    ri.textContent='âœ“'; rt.textContent='TRANSMISSION LOGGED'; rt.className='result-title';
    modEnergy(+12);
    GS.validation = Math.min(5, GS.validation+1);
    GS.risk = Math.max(0, GS.risk-3);
    GS.xp += 20;
    GS.metrics.correct++;
    rd.innerHTML = delta('+12%','Energy',true)+delta('+1','Validation',true)+delta('-3','Risk',true)+delta('+20','XP',true);
    checkSkillUnlocks();
    checkBadges();
  } else {
    ri.textContent='âœ—'; rt.textContent='ANALYSIS FAILED'; rt.className='result-title fail';
    modEnergy(-6);
    GS.latencyMs = Math.min(3000, GS.latencyMs+400);
    GS.risk += 4;
    GS.xp = Math.max(0, GS.xp-5);
    GS.metrics.wrong++;
    GS.metrics.latencyPenalty += 400;
    rd.innerHTML = delta('-6%','Energy',false)+delta('+0.4s','Latency',false)+delta('+4','Risk',false);
    riskCheck();
  }

  if(GS._currentChallenge.exp){
    rx.style.display='block';
    rxt.textContent = GS._currentChallenge.exp;
  } else { rx.style.display='none'; }

  openModal('resultModal');
  updateAllUI();
  updateValidationPips();
}

function delta(val, label, pos){
  return `<div class="delta-chip ${pos?'pos':'neg'}">${val} ${label}</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function triggerStorm(){
  GS.stormActive = true;
  document.getElementById('stormLayer').classList.add('active');
  GS.latencyMs = Math.min(3500, GS.latencyMs+800);
  document.getElementById('c-state').textContent='STORM'; document.getElementById('c-state').className='v amber';
  openModal('stormModal');
  logEvent('STORM_START',{dust:GS.dust});
}

function pauseForStorm(){
  closeModal('stormModal');
  GS.risk += 2;
  GS.metrics.stormHalt++;
  GS.isCharging = true;
  document.getElementById('solarRing').classList.add('active');
  toast('HALTED â€” AWAITING STORM PASSAGE');
  setTimeout(()=>{
    GS.stormActive = false;
    GS.isCharging = false;
    document.getElementById('stormLayer').classList.remove('active');
    document.getElementById('solarRing').classList.remove('active');
    GS.latencyMs = Math.max(1200, GS.latencyMs-800);
    toast('STORM CLEARED â€” RESUMING OPERATIONS');
    logEvent('STORM_END',{via:'HALT'});
    checkSkillUnlocks();
    updateAllUI();
  }, 7000);
}

function overrideStorm(){
  GS.risk += 8;
  GS.metrics.stormOverride++;
  closeModal('stormModal');
  GS.stormActive = false;
  document.getElementById('stormLayer').classList.remove('active');
  GS.latencyMs = Math.max(1200, GS.latencyMs-800);
  toast('OVERRIDE ACCEPTED â€” RISK +8');
  logEvent('STORM_OVERRIDE',{risk:GS.risk});
  riskCheck();
  updateAllUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENERGY FAIL / END
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showEnergyFail(){
  GS.endedTs = nowISO();
  logEvent('RUN_END',{reason:'ENERGY_DEPLETED'});
  openModal('efailModal');
}

function solarRecover(){
  closeModal('efailModal');
  GS.isCharging = true;
  document.getElementById('solarRing').classList.add('active');
  toast('SOLAR RECOVERY INITIATED');
  const iv = setInterval(()=>{
    modEnergy(+3); updateAllUI();
    if(GS.energy >= 25){
      clearInterval(iv);
      GS.isCharging = false;
      document.getElementById('solarRing').classList.remove('active');
      document.getElementById('lowRing').classList.remove('active');
      toast('ENERGY RESTORED');
    }
  }, 1200);
  _ambTimers.push(iv);
}

function endMission(){
  closeAllModals();
  if(!GS.endedTs) GS.endedTs = nowISO();
  logEvent('RUN_END',{reason:'MANUAL'});

  if(!GS.missionsCompleted.includes(GS.currentMissionId)){
    GS.missionsCompleted.push(GS.currentMissionId);
  }

  GS.lastRunSurvivalIndex = computeSurvivalIndex();

  if(GS.missionsCompleted.length >= 3 && GS.tier < 2) GS.tier = 2;
  if(GS.missionsCompleted.length >= 5 && GS.tier < 3) GS.tier = 3;

  checkSkillUnlocks();
  checkBadges();
  updateAllUI();
  toast('MISSION COMPLETE â€” SURVIVAL INDEX: '+GS.lastRunSurvivalIndex+'%');
  showScreen('dar');
  buildDAR();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function computeSurvivalIndex(){
  const total = GS.metrics.correct + GS.metrics.wrong;
  const acc = total > 0 ? GS.metrics.correct/total : 0;
  const p1 = Math.min(50, GS.validation * 10);
  const depl = GS.energy <= 0 ? 0.5 : 1;
  const p2 = (GS.energy/100)*50*depl;
  const p3 = (1 - Math.min(1, GS.risk/100))*40;
  const p4 = acc * 30;
  const safeMoves = Math.max(0, GS.metrics.moves - GS.metrics.slips);
  const p5 = GS.metrics.moves > 0 ? (safeMoves/GS.metrics.moves)*20 : 10;
  return Math.round(((p1+p2+p3+p4+p5)/190)*100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKILL TREE UNLOCKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkSkillUnlocks(){
  const m = GS.metrics;
  const n = (id) => { if(!GS.skillNodes[id]){ GS.skillNodes[id]=true; toast('SKILL UNLOCKED: '+id.toUpperCase()); } };
  if(GS.missionsCompleted.includes(1)) n('e1');
  if(m.stormHalt >= 3) n('e3');
  if(GS.missionsCompleted.length >= 5) n('e2');
  if(GS.tier >= 3) n('e4');
  if(m.scans >= 5) n('g1');
  if(m.correct >= 3) n('g2');
  if(GS.skillNodes['g2']) n('g3');
  if(GS.missionsCompleted.includes(4)) n('g4');
  if(m.slips >= 1) n('r1');
  if(GS.missionsCompleted.includes(5)) { n('r2'); n('r3'); }
  if(GS.tier >= 4) n('r4');
  if(GS.missionsCompleted.length >= 3) n('s1');
  if((m.stormHalt+m.stormOverride) >= 5) n('s2');
  if(GS.missionsCompleted.includes(6)) n('s3');
  if(GS.skillNodes['s1']) n('s4');
  updateSkillTree();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkBadges(){
  const add = (b)=>{ if(!GS.badges.includes(b)){ GS.badges.push(b); toast('ğŸ… BADGE EARNED: '+b); } };
  if(GS.energy > 0 && GS.metrics.scans >= 5 && !GS.badges.includes('Solar Strategist')) add('Solar Strategist');
  if(GS.metrics.correct >= 10 && GS.metrics.wrong === 0) add('Iron Geologist');
  if(GS.metrics.stormHalt >= 5) add('Storm Veteran');
  if(GS.missionsCompleted.includes(5) && GS.risk < 40) add('Risk Architect');
  if(GS.metrics.scans >= 1) add('First Contact');
  if((GS.metrics.correct+GS.metrics.wrong) >= 100) add('Centurion');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UPDATES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function modEnergy(d){ GS.energy = Math.max(0, Math.min(100, GS.energy + d)); }
function setState(st){
  GS.roverState = st;
  const el = document.getElementById('c-state');
  if(!el) return;
  el.textContent = st;
  el.className = 'v ' + (st==='IDLE'?'green': st==='SCANNING'?'amber': st==='MOVING'?'amber':'amber');
}

function updateAllUI(){
  const e = Math.round(GS.energy);
  const eb = document.getElementById('eb');
  const epct = document.getElementById('epct');
  if(eb){ eb.style.width = e+'%'; eb.style.background = e<15?'var(--red)':e<35?'var(--amber)':'var(--green)'; }
  if(epct){ epct.textContent = e+'%'; epct.style.color = e<15?'var(--red)':e<35?'var(--amber)':'var(--text)'; }

  const r = Math.round(GS.risk);
  const rb = document.getElementById('rb');
  const rpct = document.getElementById('rpct');
  const riskFill = document.getElementById('riskFill');
  const riskPct = document.getElementById('riskPct');
  if(rb){ rb.style.width = Math.min(100,r)+'%'; rb.style.background = r>=70?'var(--red)':r>=40?'var(--amber)':'var(--green)'; }
  if(rpct) rpct.textContent = r;
  if(riskFill){ riskFill.style.width=Math.min(100,r)+'%'; riskFill.style.background=r>=70?'var(--red)':r>=40?'var(--amber)':'var(--green)'; }
  if(riskPct) riskPct.textContent = Math.min(100,r)+'%';

  const h = Math.floor(GS.timeFrac*24), m2 = Math.floor((GS.timeFrac*24-h)*60);
  const sl = document.getElementById('solLine');
  if(sl) sl.textContent = `SOL ${GS.solNumber} Â· ${h}:${String(m2).padStart(2,'0')} Â· ${(GS.latencyMs/1000).toFixed(1)}s RTT`;

  const td = document.getElementById('tierDisplay');
  const tNames=['','CADET','TECHNICIAN','ANALYST','SYS ENG','COMMANDER'];
  if(td) td.innerHTML = `<span>T${GS.tier}</span><span style="color:var(--text-dim)">${tNames[GS.tier]||''}</span>`;

  const txp = document.getElementById('t-xp');
  if(txp) txp.textContent = GS.xp;

  const coolEl = document.getElementById('c-cool');
  if(coolEl){ coolEl.textContent = GS.instrumentCooldown > 0 ? GS.instrumentCooldown+'s' : 'READY'; }

  const nl = document.getElementById('nightLayer');
  if(nl) nl.classList.toggle('active', isNight() && !GS.stormActive);

  const tphase = document.getElementById('t-phase');
  if(tphase){ tphase.textContent = isNight()?'NIGHT':'DAY'; tphase.className = isNight()?'warn':'ok'; }

  const tdust = document.getElementById('t-dust');
  if(tdust) tdust.textContent = GS.dust.toFixed(3);

  const trisk = document.getElementById('t-risk');
  if(trisk) trisk.textContent = Math.round(GS.risk);

  const xpb = document.getElementById('skills-xp-badge');
  if(xpb) xpb.textContent = GS.xp+' XP';
}

function updateValidationPips(){
  document.querySelectorAll('.val-pip').forEach((p,i)=>{
    p.style.background = i < GS.validation ? 'var(--green)' : 'transparent';
    p.style.borderColor = i < GS.validation ? 'var(--green)' : 'var(--green-dim)';
  });
}

function updateTerrainOverlay(terrain){
  if(!terrain) return;
  const tn = document.getElementById('t-name'); if(tn) tn.textContent = terrain.name;
  const tc = document.getElementById('t-complex'); if(tc) tc.textContent = terrain.complex;
  const tq = document.getElementById('t-quad'); if(tq) tq.textContent = terrain.quadrant;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCREENS = ['landing','sim','missions','skills','cert','dar','teacher'];
let currentScreen = 'landing';

function showScreen(id){
  SCREENS.forEach(s=>{
    document.getElementById('screen-'+s)?.classList.remove('active');
    const nb = document.getElementById('nav-'+s);
    if(nb) nb.classList.remove('active');
  });
  document.getElementById('screen-'+id)?.classList.add('active');
  const nb = document.getElementById('nav-'+id);
  if(nb) nb.classList.add('active');
  currentScreen = id;

  if(id==='skills') updateSkillTree();
  if(id==='cert') buildCerts();
  if(id==='teacher') buildTeacherDash();
  if(id==='missions') buildMissions();
}

function enterAs(role){
  GS.role = role;
  document.getElementById('bottom-nav').style.display = 'flex';

  GS.runId = mkRunId();
  GS.startTs = nowISO();
  logEvent('SESSION_START',{role});
  startConstraintLoop();
  startAmbient();

  if(role==='teacher'){
    showScreen('teacher');
  } else {
    showScreen('sim');
    toast('HEX-01 ONLINE â€” MISSION ACTIVE');
  }
}

function openDAR(){
  closeAllModals();
  showScreen('dar');
  buildDAR();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKILL TREE BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateSkillTree(){
  const body = document.getElementById('skillsBody');
  if(!body) return;
  body.innerHTML = '';

  SKILL_BRANCHES.forEach(branch=>{
    const unlocked = branch.nodes.filter(n=>GS.skillNodes[n.id]).length;
    const div = document.createElement('div');
    div.className = 'skill-branch';
    div.innerHTML = `
      <div class="branch-header">
        <span class="branch-icon">${branch.icon}</span>
        <span class="branch-name">${branch.name}</span>
        <span class="branch-progress">${unlocked}/${branch.nodes.length} UNLOCKED</span>
      </div>
      <div class="branch-track" id="branch-${branch.id}"></div>
    `;
    body.appendChild(div);

    const track = div.querySelector('.branch-track');
    branch.nodes.forEach((node,i)=>{
      if(i>0){
        const conn = document.createElement('div');
        conn.className = 'skill-connector'+(GS.skillNodes[node.id]?' lit':'');
        track.appendChild(conn);
      }
      const isActive = GS.skillNodes[node.id];
      const prevUnlocked = i===0 || GS.skillNodes[branch.nodes[i-1].id];
      const nodeDiv = document.createElement('div');
      nodeDiv.className = `skill-node ${isActive?'active':prevUnlocked?'unlocked':'locked'}`;
      nodeDiv.innerHTML = `
        <div class="skill-node-badge">${isActive?'âœ…':prevUnlocked?'ğŸ”“':'ğŸ”’'}</div>
        <div class="skill-node-name">${node.name}</div>
        <div class="skill-node-req">${node.req}</div>
      `;
      track.appendChild(nodeDiv);
    });
  });

  const badgeDiv = document.createElement('div');
  badgeDiv.style.cssText='margin-top:20px;padding-top:16px;border-top:1px solid var(--border)';
  badgeDiv.innerHTML=`
    <div style="font-family:var(--mono);font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:10px">BADGES EARNED (${GS.badges.length})</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px" id="badgeWrap"></div>
  `;
  body.appendChild(badgeDiv);

  const bw = badgeDiv.querySelector('#badgeWrap');
  if(GS.badges.length===0){
    bw.innerHTML='<div style="font-family:var(--mono);font-size:9px;color:var(--text-dim)">No badges earned yet. Complete missions to earn badges.</div>';
  } else {
    GS.badges.forEach(b=>{
      const bEl = document.createElement('span');
      bEl.className='pill amber';
      bEl.textContent='ğŸ… '+b;
      bw.appendChild(bEl);
    });
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CERTIFICATION BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildCerts(){
  const el = document.getElementById('certLevels');
  if(!el) return;
  el.innerHTML='';
  let earned=0;

  CERTS.forEach(cert=>{
    const isEarned = cert.earned();
    if(isEarned) earned++;
    const prog = cert.progress();
    const pct = Math.round((prog/cert.total)*100);
    const card = document.createElement('div');
    card.className = 'cert-card'+(isEarned?' earned':'');
    card.innerHTML=`
      <div class="cert-level-badge">${cert.level}</div>
      <div class="cert-info">
        <div class="cert-name">${cert.name}</div>
        <div class="cert-skills">${cert.skills}</div>
        <div class="cert-req">Requirement: <span class="${isEarned?'done':''}">${cert.req}</span></div>
        <div class="cert-progress-bar"><div class="cert-progress-fill" style="width:${pct}%"></div></div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <span style="font-family:var(--mono);font-size:8px;color:var(--text-dim)">${prog}/${cert.total} Â· ${pct}%</span>
          ${isEarned?`<button class="btn btn-secondary" style="padding:5px 12px;font-size:9px" onclick="viewCert(${cert.level})">VIEW CERTIFICATE</button>`:''}
        </div>
      </div>
    `;
    el.appendChild(card);
  });

  const badge = document.getElementById('cert-earned-badge');
  if(badge) badge.textContent = earned+' EARNED';
}

function viewCert(level){
  const cert = CERTS.find(c=>c.level===level);
  if(!cert||!cert.earned()) return;
  const now = new Date();
  const doc = document.getElementById('certDoc');
  doc.innerHTML=`
    <div class="cert-doc-isro">â—ˆ INDIAN SPACE RESEARCH ORGANISATION Â· MARS DECISION LAB</div>
    <div class="cert-doc-seal">ğŸª</div>
    <div class="cert-doc-title">CERTIFICATE</div>
    <div class="cert-doc-certifies">This certifies that</div>
    <div class="cert-doc-name">Mission Operator</div>
    <div class="cert-doc-for">has demonstrated competency in</div>
    <div style="font-family:var(--ui);font-size:17px;font-weight:700;color:var(--amber);margin-bottom:12px">${cert.name}</div>
    <div style="font-size:10px;color:var(--text-dim);line-height:1.8;margin-bottom:14px;max-width:380px;margin-left:auto;margin-right:auto">${cert.skills}</div>
    <div class="cert-doc-level">LEVEL ${level} Â· CONSTRAINT LEARNING ENGINE</div>
    <div class="cert-doc-meta">
      <span>ID: ${mkRunId()}</span>
      <span>${now.toLocaleDateString('en-IN',{year:'numeric',month:'short',day:'numeric'})}</span>
    </div>
  `;
  document.getElementById('certViewer').classList.add('open');
}

document.getElementById('certViewer').addEventListener('click',function(e){ if(e.target===this) this.classList.remove('open'); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI DECISION ANALYSIS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildDAR(){
  const body = document.getElementById('darBody');
  if(!body) return;

  if(!GS.endedTs && GS.metrics.moves === 0){
    body.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-dim);font-family:var(--mono);font-size:10px;letter-spacing:2px">COMPLETE A MISSION TO GENERATE YOUR DECISION ANALYSIS REPORT</div>';
    return;
  }

  const si = GS.lastRunSurvivalIndex ?? computeSurvivalIndex();
  const total = GS.metrics.correct + GS.metrics.wrong;
  const acc = total>0?Math.round((GS.metrics.correct/total)*100):0;
  const badge = document.getElementById('dar-run-badge');
  if(badge) badge.textContent = GS.runId ? GS.runId.slice(-8) : 'LATEST RUN';

  const circ = 2*Math.PI*52;
  const offset = circ - (circ * si/100);

  body.innerHTML=`
    <div class="dar-summary-grid">
      <div class="dar-metric"><div class="dar-metric-val">${si}%</div><div class="dar-metric-lbl">Survival Index</div></div>
      <div class="dar-metric"><div class="dar-metric-val" style="color:var(--${acc>=70?'green':acc>=45?'amber':'red'})">${acc}%</div><div class="dar-metric-lbl">Decision Accuracy</div></div>
      <div class="dar-metric"><div class="dar-metric-val" style="color:var(--amber)">${Math.round(GS.risk)}</div><div class="dar-metric-lbl">Risk Budget Used</div></div>
    </div>

    <div class="survival-ring-wrap">
      <div class="survival-ring">
        <svg viewBox="0 0 120 120">
          <circle class="ring-bg" cx="60" cy="60" r="52"/>
          <circle class="ring-fill" cx="60" cy="60" r="52" stroke-dasharray="${circ}" stroke-dashoffset="${circ}" id="ringFillEl"/>
        </svg>
        <div class="survival-ring-label">
          <div class="survival-ring-pct" id="ringSI">0%</div>
          <div class="survival-ring-sub">SURVIVAL</div>
        </div>
      </div>
    </div>

    <div class="dar-section">
      <div class="dar-section-title">ğŸ¤– AI DECISION ANALYSIS</div>
      <div class="dar-ai-label">â—ˆ ANTHROPIC-POWERED Â· BEHAVIOURAL ANALYSIS</div>
      <div class="dar-ai-box" id="aiAnalysisBox">
        <span class="typing-cursor"></span>
      </div>
    </div>

    <div class="dar-section">
      <div class="dar-section-title">ğŸ“ KEY DECISION EVENTS</div>
      <div class="event-timeline" id="eventTimeline"></div>
    </div>

    <div class="dar-section">
      <div class="dar-section-title">ğŸ“š CONCEPT GAPS</div>
      <div id="conceptGaps"></div>
    </div>

    <div class="dar-section">
      <div class="dar-section-title">ğŸ… SESSION BADGES</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px" id="darBadges"></div>
    </div>
  `;

  setTimeout(()=>{
    const el = document.getElementById('ringFillEl');
    if(el) el.style.strokeDashoffset = offset;
    const siEl = document.getElementById('ringSI');
    if(siEl){
      let v=0; const iv=setInterval(()=>{ v+=2; siEl.textContent=Math.min(si,v)+'%'; if(v>=si) clearInterval(iv); },20);
    }
  },200);

  const eventsEl = document.getElementById('eventTimeline');
  const keyEvents = GS.log.filter(e=>['MOVE','ANSWER','STORM_START','STORM_END','STORM_OVERRIDE','SCAN_ANOMALY','DUST_SLIP','RUN_END'].includes(e.type)).slice(-12);
  keyEvents.forEach(ev=>{
    const dot = ev.type==='ANSWER'?(ev.correct?'good':'bad') : ev.type==='STORM_OVERRIDE'?'bad' : 'neutral';
    const text = formatEventText(ev);
    const d = document.createElement('div');
    d.className='event-item';
    d.innerHTML=`<div class="event-dot ${dot}"></div><div class="event-text">${text}</div>`;
    eventsEl.appendChild(d);
  });
  if(keyEvents.length===0) eventsEl.innerHTML='<div style="font-family:var(--mono);font-size:9px;color:var(--text-dim)">No events logged yet.</div>';

  const gapsEl = document.getElementById('conceptGaps');
  const wrong = GS.log.filter(e=>e.type==='ANSWER'&&!e.correct);
  const cats = {};
  wrong.forEach(e=>{ cats[e.cat]=(cats[e.cat]||0)+1; });
  const total2 = GS.log.filter(e=>e.type==='ANSWER').length;
  if(Object.keys(cats).length===0){
    gapsEl.innerHTML='<div style="font-family:var(--mono);font-size:9px;color:var(--green)">No concept gaps identified â€” excellent analytical accuracy!</div>';
  } else {
    Object.entries(cats).sort((a,b)=>b[1]-a[1]).forEach(([cat,cnt])=>{
      const pct = Math.round((cnt/Math.max(1,total2))*100);
      const d=document.createElement('div');
      d.className='concept-gap';
      d.innerHTML=`<div class="concept-name">${cat}</div><div class="concept-bar"><div class="concept-fill" style="width:${pct}%"></div></div><div class="concept-pct">${pct}%</div>`;
      gapsEl.appendChild(d);
    });
  }

  const db=document.getElementById('darBadges');
  if(GS.badges.length===0) db.innerHTML='<span style="font-family:var(--mono);font-size:9px;color:var(--text-dim)">No badges this session.</span>';
  else GS.badges.forEach(b=>{ const s=document.createElement('span'); s.className='pill amber'; s.textContent='ğŸ… '+b; db.appendChild(s); });

  generateAIAnalysis();
}

function formatEventText(ev){
  const t = ev.t ? new Date(ev.t).toISOString().slice(11,19) : '';
  switch(ev.type){
    case 'MOVE': return `<strong>${t}</strong> Rover moved â€” energy drained ${ev.drain?.toFixed(1)||'?'}%`;
    case 'ANSWER': return `<strong>${t}</strong> Challenge ${ev.correct?'CORRECT âœ“':'WRONG âœ—'} â€” Category: ${ev.cat||'?'}`;
    case 'STORM_START': return `<strong>${t}</strong> Dust storm detected â€” dust index ${ev.dust?.toFixed(2)||'?'}`;
    case 'STORM_END': return `<strong>${t}</strong> Storm cleared via ${ev.via||'?'}`;
    case 'STORM_OVERRIDE': return `<strong>${t}</strong> Storm overridden â€” risk +8 (now ${ev.risk})`;
    case 'DUST_SLIP': return `<strong>${t}</strong> Traction loss â€” risk +5 (now ${ev.riskNow})`;
    case 'SCAN_ANOMALY': return `<strong>${t}</strong> Instrument anomaly â€” scan degraded â€” risk +4`;
    case 'RUN_END': return `<strong>${t}</strong> Mission ended â€” reason: ${ev.reason||'?'}`;
    default: return `<strong>${t}</strong> ${ev.type}`;
  }
}

/*
  FIX: generateAIAnalysis now calls the secure Next.js API route /api/anthropic
  instead of hitting api.anthropic.com directly from the browser.
  The API key never leaves the server.

  NOTE: When mars.html is served as a standalone file (without Next.js),
  the /api/anthropic route won't exist â€” the catch block shows the fallback.
*/
async function generateAIAnalysis(){
  const box = document.getElementById('aiAnalysisBox');
  if(!box) return;

  const total = GS.metrics.correct + GS.metrics.wrong;
  const acc = total > 0 ? Math.round((GS.metrics.correct/total)*100) : 0;
  const si = GS.lastRunSurvivalIndex ?? computeSurvivalIndex();

  const prompt = `You are an AI decision analyst for the Mars Survival Decision Lab, an EdTech cognitive training system. Analyze this student's mission run and provide a concise, educational, actionable analysis in 3-4 sentences.

Mission data:
- Survival Index: ${si}%
- Decision Accuracy: ${acc}% (${GS.metrics.correct} correct / ${total} total)
- Energy at end: ${Math.round(GS.energy)}%
- Risk budget used: ${Math.round(GS.risk)}/100
- Moves: ${GS.metrics.moves}, Scans: ${GS.metrics.scans}
- Dust slips: ${GS.metrics.slips}, Storms: ${GS.metrics.storms}
- Storm decisions â€” HALT: ${GS.metrics.stormHalt}, OVERRIDE: ${GS.metrics.stormOverride}
- Latency penalty accumulated: +${GS.metrics.latencyPenalty}ms

Identify: (1) the single strongest decision pattern, (2) the primary improvement area, (3) one specific STEM concept they should review. Keep it under 100 words, direct, non-patronising. Speak as a mission debrief officer.`;

  try {
    // FIX: POST to our secure server-side route instead of api.anthropic.com
    const resp = await fetch('/api/anthropic', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt }),
    });

    // FIX: handle non-2xx responses gracefully
    if (!resp.ok) {
      throw new Error(`API route returned ${resp.status}`);
    }

    const data = await resp.json();

    if (data.error) {
      throw new Error(data.error);
    }

    const text = data.text || '';
    if(text){
      box.innerHTML = '';
      let i = 0;
      const iv = setInterval(()=>{
        if(i >= text.length){ clearInterval(iv); return; }
        // FIX: escape < so HTML tags in AI output don't break the DOM
        const ch = text[i];
        box.innerHTML += ch === '<' ? '&lt;' : ch === '>' ? '&gt;' : ch;
        i++;
      }, 18);
    } else {
      box.innerHTML = getFallbackAnalysis(si, acc);
    }
  } catch(e) {
    console.warn('[DAR] AI analysis unavailable:', e.message);
    box.innerHTML = getFallbackAnalysis(si, acc);
  }
}

function getFallbackAnalysis(si, acc){
  const patterns = [
    si >= 70 ? 'Strong overall mission control with above-average survival index.' :
    si >= 45 ? 'Moderate performance with clear areas for optimisation.' :
    'Mission struggled with fundamental resource management â€” review energy budgeting.',
    acc >= 70 ? 'Analytical accuracy is solid.' : acc >= 45 ? 'Analytical accuracy needs improvement.' : 'Geological analysis accuracy is critically low â€” review Feâ‚‚Oâ‚ƒ chemistry and APXS protocols.',
    GS.metrics.stormOverride > GS.metrics.stormHalt ? 'Risk-seeking storm decisions (+8 risk overrides) are accumulating unnecessary budget. Recommend HALT protocol study.' : 'Conservative storm response is protecting mission integrity.',
    'Review: '+( acc < 60 ? 'iron oxidation chemistry and APXS instrument protocols' : GS.risk > 60 ? 'risk budget management and cascading failure prevention' : 'energy optimisation for the night cycle' )+'.'
  ];
  return patterns.join(' ');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISSION SELECT BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildMissions(){
  const grid = document.getElementById('missionGrid');
  if(!grid) return;
  grid.innerHTML='';

  const badge = document.getElementById('missions-tier-badge');
  const tNames=['','CADET','TECHNICIAN','ANALYST','SYS ENG'];
  if(badge) badge.textContent = `${tNames[GS.tier]||'CADET'} Â· T${GS.tier}`;

  MISSIONS.forEach(m=>{
    const locked = GS.tier < m.unlockTier;
    const done = GS.missionsCompleted.includes(m.id);
    const card = document.createElement('div');
    card.className='mission-card'+(locked?' locked':'')+(done?' completed':'');
    card.innerHTML=`
      <div class="mc-num">M0${m.id}</div>
      <div class="mc-name">${m.name}</div>
      <div class="mc-constraint">${m.constraint}</div>
      <div class="mc-tags">
        <span class="pill ${locked?'red':done?'green':'amber'}">${locked?'LOCKED T'+m.unlockTier:done?'COMPLETE':'AVAILABLE'}</span>
      </div>
    `;
    if(!locked){
      card.onclick=()=>{
        GS.currentMissionId = m.id;
        toast('LOADING: '+m.name.toUpperCase());
        showScreen('sim');
      };
    }
    grid.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEACHER DASHBOARD BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildTeacherDash(){
  buildStudentTable();
  buildHeatmap();
  buildBenchmarks();
  buildTopErrors();
  animateStormBars();
}

function buildStudentTable(){
  const body = document.getElementById('studentBody');
  if(!body) return;
  body.innerHTML='';
  TEACHER_STUDENTS.forEach(s=>{
    const tr = document.createElement('tr');
    const siColor = s.si>=75?'var(--green)':s.si>=55?'var(--amber)':'var(--red)';
    const statusColor = s.status==='ACTIVE'?'green':s.status==='DEPLETED'||s.status==='LOW_ENERGY'?'red':'amber';
    tr.innerHTML=`
      <td class="stu-name">${s.name}</td>
      <td><span class="pill amber">T${s.tier}</span></td>
      <td>
        <span style="color:${siColor};font-size:11px">${s.si}%</span>
        <div class="stu-bar" style="margin-left:4px"><div class="stu-bar-fill" style="width:${s.si}%;background:${siColor}"></div></div>
      </td>
      <td>${s.acc}%</td>
      <td><span style="color:${s.riskEvts>5?'var(--red)':s.riskEvts>3?'var(--amber)':'var(--text-mid)'}">${s.riskEvts}</span></td>
      <td><span class="pill ${statusColor}">${s.status.replace('_',' ')}</span></td>
    `;
    body.appendChild(tr);
  });
}

function buildHeatmap(){
  const wrap = document.getElementById('heatmapWrap');
  if(!wrap) return;
  wrap.innerHTML='';

  const wrapInner = document.createElement('div');
  wrapInner.style.cssText='display:flex;flex-direction:column;gap:2px';
  const hdr = document.createElement('div');
  hdr.style.cssText='display:flex;gap:3px;margin-left:183px';
  TEACHER_STUDENTS.forEach(s=>{
    const lbl=document.createElement('div');
    lbl.style.cssText='width:28px;text-align:center;font-family:var(--mono);font-size:7px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis';
    lbl.textContent=s.name.split(' ')[0];
    hdr.appendChild(lbl);
  });
  wrapInner.appendChild(hdr);

  HEATMAP_CONCEPTS.forEach((concept,ci)=>{
    const row=document.createElement('div');
    row.className='heatmap-row';
    const lbl=document.createElement('div');
    lbl.className='heatmap-label';
    lbl.textContent=concept;
    row.appendChild(lbl);
    const cells=document.createElement('div');
    cells.className='heatmap-cells';
    HEATMAP_DATA.forEach((sRow,si)=>{
      const v=sRow[ci];
      const cell=document.createElement('div');
      cell.className='heatmap-cell';
      cell.title=`${TEACHER_STUDENTS[si].name} Â· ${concept}: ${v}%`;
      cell.textContent=v>0?v+'':'â€”';
      if(v===0||v===undefined){ cell.style.background='#111'; cell.style.color='var(--text-dim)'; }
      else if(v<=20){ cell.style.background='rgba(61,255,143,0.15)'; cell.style.color='var(--green)'; }
      else if(v<=60){ cell.style.background='rgba(255,184,48,0.3)'; cell.style.color='var(--amber)'; }
      else { cell.style.background='rgba(255,59,59,0.5)'; cell.style.color='var(--red)'; }
      cells.appendChild(cell);
    });
    row.appendChild(cells);
    wrapInner.appendChild(row);
  });
  wrap.appendChild(wrapInner);
}

function buildBenchmarks(){
  const wrap=document.getElementById('benchmarkWrap');
  if(!wrap) return;
  wrap.innerHTML='';
  const legend = document.createElement('div');
  legend.style.cssText='display:flex;gap:14px;margin-bottom:10px;font-family:var(--mono);font-size:8px;color:var(--text-dim)';
  legend.innerHTML=`<span><span style="color:var(--mars)">â”</span> Class 9B</span><span><span style="color:var(--cyan)">â”</span> District Avg</span><span><span style="color:var(--text-dim)">â”</span> National Avg</span>`;
  wrap.appendChild(legend);

  BENCHMARK_DATA.forEach(b=>{
    const row=document.createElement('div');
    row.className='bench-row';
    row.innerHTML=`
      <div class="bench-name">${b.name}</div>
      <div style="flex:1;display:flex;flex-direction:column;gap:3px">
        <div class="bench-track"><div class="bench-fill" style="width:${b.class}%;background:var(--mars)"></div></div>
        <div class="bench-track"><div class="bench-fill" style="width:${b.district}%;background:var(--cyan);opacity:0.6"></div></div>
        <div class="bench-track"><div class="bench-fill" style="width:${b.national}%;background:var(--text-dim);opacity:0.5"></div></div>
      </div>
      <div style="font-family:var(--mono);font-size:9px;color:var(--${b.class>b.national?'green':'amber'});width:35px;text-align:right">${b.class}%</div>
    `;
    wrap.appendChild(row);
  });
}

function buildTopErrors(){
  const el=document.getElementById('topErrors');
  if(!el) return;
  const errors=[
    {concept:'Igneous Petrology (SiOâ‚‚)', pct:68},
    {concept:'Atmospheric Dynamics', pct:55},
    {concept:'Instrument Protocols', pct:52},
  ];
  el.innerHTML='';
  errors.forEach(e=>{
    const d=document.createElement('div');
    d.className='concept-gap';
    d.innerHTML=`<div class="concept-name">${e.concept}</div><div class="concept-bar"><div class="concept-fill" style="width:${e.pct}%;background:var(--red)"></div></div><div class="concept-pct">${e.pct}%</div>`;
    el.appendChild(d);
  });
}

function animateStormBars(){
  const hPct=64, oPct=36;
  const hb=document.getElementById('stormHaltBar');
  const ob=document.getElementById('stormOverBar');
  if(hb) hb.style.width=hPct+'%';
  if(ob) ob.style.width=oPct+'%';
  const hp=document.getElementById('stormHaltPct');
  const op=document.getElementById('stormOverPct');
  if(hp) hp.textContent=hPct+'%';
  if(op) op.textContent=oPct+'%';
}

function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.getAttribute('onclick')?.includes("'"+tab+"'")) b.classList.add('active'); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function closeAllModals(){ document.querySelectorAll('.modal-bg').forEach(m=>m.classList.remove('open')); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg){
  const wrap = document.getElementById('toast-wrap');
  const el = document.createElement('div');
  el.className='toast-item';
  el.textContent=msg;
  wrap.appendChild(el);
  setTimeout(()=>el.remove(),3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMBIENT LOOPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startConstraintLoop(){
  const iv=setInterval(constraintTick, 1000);
  _ambTimers.push(iv);
}

function startAmbient(){
  const iv=setInterval(()=>{
    const windEl = document.getElementById('c-wind');
    const radEl = document.getElementById('c-rad');
    if(windEl) windEl.textContent=(2+Math.random()*6).toFixed(1)+' m/s '+['N','NNW','NW','NE','E'][Math.floor(Math.random()*5)];
    if(radEl) radEl.textContent=(0.15+Math.random()*0.08).toFixed(2)+' mGy/d';
  },5000);
  _ambTimers.push(iv);

  const iv2=setInterval(()=>{
    if(GS.roverState==='IDLE'&&GS.stepCount>0&&GS.nodeProximity<0.5&&Math.random()<0.06){
      GS.nodeProximity+=0.1;
    }
  },2000);
  _ambTimers.push(iv2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOUCH / KEYBOARD
   FIX: viewport touch listeners must not be on the landing screen â€”
   they only attach to the sim viewport element, so swipes on the
   landing page won't be swallowed.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _touchStart=null;
const vp=document.getElementById('viewport');
vp.addEventListener('touchstart',e=>{_touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};},{passive:true});
vp.addEventListener('touchend',e=>{
  if(!_touchStart) return;
  const dx=e.changedTouches[0].clientX-_touchStart.x, dy=e.changedTouches[0].clientY-_touchStart.y;
  if(Math.abs(dx)<28&&Math.abs(dy)<28){ doScan(); _touchStart=null; return; }
  const ang=Math.atan2(-dy,dx)*180/Math.PI;
  let dir;
  if(ang>-22.5&&ang<=22.5)dir='E';else if(ang>22.5&&ang<=67.5)dir='NE';else if(ang>67.5&&ang<=112.5)dir='N';else if(ang>112.5&&ang<=157.5)dir='NW';else if(ang>157.5||ang<=-157.5)dir='W';else if(ang>-157.5&&ang<=-112.5)dir='SW';else if(ang>-112.5&&ang<=-67.5)dir='S';else dir='SE';
  move(dir); _touchStart=null;
},{passive:true});
document.querySelectorAll('.dir-btn').forEach(btn=>{
  btn.addEventListener('touchstart',()=>btn.classList.add('pressed'),{passive:true});
  btn.addEventListener('touchend',()=>setTimeout(()=>btn.classList.remove('pressed'),200),{passive:true});
  btn.addEventListener('mouseleave',()=>btn.classList.remove('pressed'));
});
document.addEventListener('keydown',e=>{
  if(currentScreen!=='sim') return;
  const map={ArrowUp:'N',ArrowDown:'S',ArrowLeft:'W',ArrowRight:'E',w:'N',s:'S',a:'W',d:'E',q:'NW',e:'NE',z:'SW',c:'SE'};
  if(e.key===' '){ e.preventDefault(); doScan(); return; }
  if(map[e.key]){ e.preventDefault(); move(map[e.key]); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUST PARTICLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function spawnDust(){
  const wrap=document.getElementById('dustWrap');
  for(let i=0;i<5;i++){
    const d=document.createElement('div');
    d.className='dust-p';
    d.style.cssText=`left:${42+Math.random()*16}%;bottom:36%;--dx:${(Math.random()*22-11)}px;animation-delay:${Math.random()*0.3}s`;
    wrap.appendChild(d);
    setTimeout(()=>d.remove(),2000);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STARS (SVG dots)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function(){
  const el=document.getElementById('stars-canvas-sim');
  let svg='<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">';
  for(let i=0;i<120;i++){
    const x=Math.random()*100, y=Math.random()*100, r=Math.random()*0.8+0.2, a=Math.random()*0.7+0.1;
    svg+=`<circle cx="${x}%" cy="${y}%" r="${r}" fill="rgba(230,220,210,${a})"/>`;
  }
  svg+='</svg>';
  el.innerHTML=svg;
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function nowISO(){ return new Date().toISOString(); }
function mkRunId(){ return `HEX01-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).slice(2,7).toUpperCase()}`; }
function logEvent(type,data={}){ GS.log.push({t:nowISO(),type,...data}); if(GS.log.length>200) GS.log.splice(0,50); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
updateAllUI();
buildMissions();
updateSkillTree();
buildCerts();

    <!-- ==============================
     DEMO LOGIN OVERLAY (Single-HTML)
============================== -->
<div id="demo-login" aria-hidden="true">
  <div class="demo-card">
    <div class="demo-pill">DEMO ACCESS</div>
    <div class="demo-title">Unlock the Demo</div>
    <div class="demo-text">
      This is a prototype build. <b>No real payments.</b> No real accounts.<br>
      Enter the demo code to proceed.
    </div>

    <input id="demo-code" class="demo-input" placeholder="Demo code (example: MARS200)" autocomplete="off" />
    <div class="demo-actions">
      <button class="demo-btn" onclick="demoOpenInBrowserTip()">Open in Browser</button>
      <button class="demo-btn primary" onclick="demoUnlock()">Unlock â†’</button>
    </div>

    <div id="demo-err" class="demo-err">Wrong code. Try again.</div>

    <div class="demo-tip">
      If you opened from Instagram/Facebook: tap <b>â‹¯</b> â†’ <b>Open in browser</b> for best performance.
    </div>
  </div>
</div>

<!-- Small banner that shows inside app when in in-app browser -->
<div id="inapp-banner">
  <div class="row">
    <div class="msg">
      Youâ€™re in an in-app browser. For the best experience, <b>open in Chrome</b>.
    </div>
    <div style="display:flex;gap:8px;">
      <button class="bbtn" onclick="demoOpenInBrowserTip()">How to open</button>
      <button class="xbtn" onclick="hideInAppBanner()">Close</button>
    </div>
  </div>
</div>
        </script>
</body>
</html>
