<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>HEX-01 · Mars Geological Survey</title>

<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<!-- THREE r128 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<!-- GLTFLoader for r128 -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
:root {
  --bg:#03050a; --surface:#070d14; --panel:#080e17;
  --border:#12202e; --border-hi:#1e3348;
  --text:#9ab4cc; --text-dim:#334d63; --text-hi:#c8dcea;
  --accent:#00c8ff; --accent-dk:#004e66;
  --amber:#ffaa00; --amber-dk:#5a3a00;
  --red:#ff3a3a; --red-dk:#5a0a0a;
  --green:#00e87a;
  --mono:'Share Tech Mono', monospace;
  --display:'Orbitron', sans-serif;
  --r:2px;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; user-select:none; -webkit-tap-highlight-color:transparent; }
html,body{ width:100%; height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:var(--mono); font-size:11px; }

#overlay-scanlines{ position:fixed; inset:0; z-index:999; pointer-events:none;
  background:repeating-linear-gradient(0deg, rgba(0,0,0,0.13) 0px, rgba(0,0,0,0.13) 1px, transparent 1px, transparent 3px);
}
#overlay-vignette{ position:fixed; inset:0; z-index:998; pointer-events:none;
  background:radial-gradient(ellipse at 50% 50%, transparent 40%, rgba(0,0,0,0.72) 100%);
}
#overlay-grain{ position:fixed; inset:0; z-index:997; pointer-events:none; opacity:0.035;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size:120px 120px;
}

.screen{ position:fixed; inset:0; display:flex; flex-direction:column; opacity:0; pointer-events:none; transition:opacity 0.5s ease; }
.screen.active{ opacity:1; pointer-events:all; }

#boot-screen{ justify-content:center; align-items:flex-start; padding:0 8% 0 10%; background:var(--bg); }
.boot-header{ font-family:var(--display); font-size:10px; letter-spacing:6px; color:var(--text-dim); margin-bottom:44px; text-transform:uppercase; }
.boot-log{ display:flex; flex-direction:column; margin-bottom:40px; min-height:180px; }
.boot-line{ font-size:12px; line-height:2.4; color:var(--text-dim); opacity:0; animation:lineFadeIn 0.08s forwards; display:flex; gap:12px; align-items:baseline; }
.boot-line .bl-key{ color:var(--text); } .boot-line .bl-val{ color:var(--accent); }
.boot-line .bl-ok{ color:var(--green); font-size:9px; } .boot-line .bl-warn{ color:var(--amber); }
@keyframes lineFadeIn{ to{ opacity:1; } }
.boot-progress{ width:220px; height:2px; background:var(--border); margin-bottom:36px; overflow:hidden; }
.boot-progress-fill{ height:100%; background:var(--accent); width:0%; transition:width 0.3s ease; }
.boot-cta{ display:inline-flex; align-items:center; gap:10px; background:none; border:1px solid var(--accent); color:var(--accent);
  font-family:var(--mono); font-size:12px; letter-spacing:3px; padding:13px 28px; cursor:pointer; text-transform:uppercase; position:relative; overflow:hidden;
  opacity:0; transition:opacity 0.4s, color 0.2s, background 0.2s;
}
.boot-cta.visible{ opacity:1; }
.boot-cta::after{ content:''; position:absolute; inset:0; background:var(--accent); opacity:0; transition:opacity 0.2s; }
.boot-cta:hover::after{ opacity:0.08; } .boot-cta:active{ background:var(--accent); color:var(--bg); }
.boot-cta-dot{ width:6px; height:6px; border-radius:50%; background:var(--accent); animation:dotPulse 1.2s ease-in-out infinite; }
@keyframes dotPulse{ 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.3;transform:scale(0.7)} }

#sim-screen{ background:var(--bg); }

.top-bar{ height:46px; flex-shrink:0; display:flex; align-items:stretch; border-bottom:1px solid var(--border); background:var(--surface); z-index:10; }
.tb-cell{ display:flex; flex-direction:column; justify-content:center; padding:0 11px; border-right:1px solid var(--border); gap:3px; min-width:0; }
.tb-cell:last-child{ border-right:none; margin-left:auto; }
.tb-label{ font-size:7px; letter-spacing:2.5px; color:var(--text-dim); text-transform:uppercase; }
.tb-value{ font-size:11px; color:var(--text-hi); white-space:nowrap; }
.eb-row{ display:flex; align-items:center; gap:7px; }
.eb-track{ width:68px; height:4px; background:var(--border); overflow:hidden; }
.eb-fill{ height:100%; background:var(--accent); transition:width 0.4s, background 0.4s; }
.eb-pct{ font-size:11px; color:var(--text-hi); min-width:30px; }

.sig-dot{ display:inline-block; width:5px; height:5px; border-radius:50%; background:var(--accent); margin-right:5px; animation:sigPulse 2.4s ease-in-out infinite; }
@keyframes sigPulse{ 0%,100%{opacity:1} 50%{opacity:0.25} }

.storm-badge{ display:none; align-items:center; gap:6px; font-size:9px; letter-spacing:2px; color:var(--amber);
  border:1px solid var(--amber-dk); padding:2px 8px; margin:auto 10px; animation:stormFlash 0.9s step-end infinite;
}
.storm-badge.visible{ display:flex; }
@keyframes stormFlash{ 0%,100%{opacity:1} 50%{opacity:0.4} }

.viewport{ flex:1; position:relative; overflow:hidden; background:#030609; min-height:0; }
#threejs-canvas{ position:absolute; inset:0; width:100%; height:100%; display:none; }
#terrain-canvas{ position:absolute; inset:0; width:100%; height:100%; }

.terrain-overlay{ position:absolute; top:12px; left:12px; display:flex; flex-direction:column; gap:3px; z-index:5; }
.to-name{ font-size:11px; letter-spacing:1.5px; color:var(--text-hi); }
.to-row{ font-size:9px; color:var(--text-dim); display:flex; gap:6px; }
.to-row span{ color:var(--amber); }

.node-pill{ position:absolute; top:12px; left:50%; transform:translateX(-50%); font-size:9px; letter-spacing:2.5px; color:var(--accent);
  border:1px solid var(--accent-dk); background:rgba(0,20,30,0.85); padding:5px 14px; white-space:nowrap;
  opacity:0; transition:opacity 0.35s; pointer-events:none; z-index:5;
}
.node-pill.visible{ opacity:1; }

.lat-banner{ position:absolute; bottom:12px; left:50%; transform:translateX(-50%); font-size:9px; letter-spacing:3px; color:var(--accent);
  background:rgba(3,5,10,0.9); border:1px solid var(--border-hi); padding:5px 16px; white-space:nowrap;
  opacity:0; transition:opacity 0.2s; pointer-events:none; z-index:5;
}
.lat-banner.visible{ opacity:1; }

.toast-log{ position:absolute; bottom:12px; left:12px; font-size:9px; color:var(--text-dim); letter-spacing:1px; max-width:60%; z-index:5; }
.val-chip{ position:absolute; bottom:12px; right:12px; font-size:9px; letter-spacing:1.5px; color:var(--text-dim); z-index:5; }
.val-chip span{ color:var(--green); }

.storm-veil{ position:absolute; inset:0; background:rgba(100,50,0,0.0); pointer-events:none; transition:background 1.5s; z-index:4; }
.storm-veil.active{ background:rgba(100,50,0,0.12); }

.hb-veil{ position:absolute; inset:0; pointer-events:none; box-shadow:inset 0 0 80px rgba(255,58,58,0); transition:box-shadow 0.5s; z-index:4; }
.hb-veil.pulse{ animation:hbPulse 1.3s ease-in-out infinite; }
@keyframes hbPulse{ 0%,100%{ box-shadow:inset 0 0 80px rgba(255,58,58,0); } 50%{ box-shadow:inset 0 0 80px rgba(255,58,58,0.18); } }

.solar-glow{ position:fixed; inset:0; pointer-events:none; z-index:50;
  box-shadow:inset 0 0 80px rgba(255,170,0,0); transition:box-shadow 2s;
}
.solar-glow.active{ box-shadow:inset 0 0 80px rgba(255,170,0,0.07); }

.rover-wrap{ position:absolute; bottom:-8px; left:50%; transform:translateX(-50%); width:130px; animation:mastSway 3.5s ease-in-out infinite; z-index:6; pointer-events:none; }
@keyframes mastSway{ 0%,100%{ transform:translateX(-50%) rotate(-0.25deg); } 50%{ transform:translateX(-50%) rotate(0.25deg); } }

.controls-wrap{ height:38%; flex-shrink:0; display:flex; border-top:1px solid var(--border); min-height:155px; max-height:220px; }

.cam-panel{ width:50%; background:var(--panel); border-right:1px solid var(--border);
  display:flex; flex-direction:column; padding:10px; gap:7px;
}
.panel-label{ font-size:7px; letter-spacing:2.5px; color:var(--text-dim); text-transform:uppercase; display:flex; align-items:center; gap:5px; }

.cam-screen{ flex:1; background:#020408; border:1px solid var(--border); position:relative; overflow:hidden;
  display:flex; align-items:center; justify-content:center; min-height:0;
}
.cam-screen::before,.cam-screen::after{ content:''; position:absolute; background:rgba(0,200,255,0.12); pointer-events:none; }
.cam-screen::before{ width:1px; height:100%; left:50%; }
.cam-screen::after{ height:1px; width:100%; top:50%; }

.cam-data{ font-size:8px; color:rgba(0,200,255,0.35); line-height:1.9; text-align:center; z-index:1; }

.scan-sweep{ position:absolute; inset:0;
  background:linear-gradient(to bottom, transparent, rgba(0,200,255,0.07) 50%, transparent);
  transform:translateY(-100%); opacity:0; pointer-events:none;
}
.scan-sweep.active{ opacity:1; animation:sweepDown 1.6s linear infinite; }
@keyframes sweepDown{ from{ transform:translateY(-100%);} to{ transform:translateY(100%);} }

.sys-rows{ display:flex; flex-direction:column; gap:2px; }
.sys-row{ display:flex; justify-content:space-between; align-items:center; font-size:8.5px; border-bottom:1px solid var(--border); padding-bottom:2px; }
.sys-key{ color:var(--text-dim); }
.sys-val{ color:var(--text-hi); }
.sys-val.warn{ color:var(--amber); }
.sys-val.ok{ color:var(--green); }
.sys-val.bad{ color:var(--red); }

.scan-btn{
  display:flex; align-items:center; justify-content:center; gap:6px;
  background:none; border:1px solid var(--border-hi);
  color:var(--text-dim); font-family:var(--mono); font-size:9px; letter-spacing:2px;
  padding:8px; text-transform:uppercase;
  cursor:not-allowed;
  transition:all 0.2s;
}
.scan-btn.ready{
  border-color:var(--accent);
  color:var(--accent);
  cursor:pointer;
  animation:scanReady 1.8s ease-in-out infinite;
}
.scan-btn.ready:active{ background:rgba(0,200,255,0.1); }
@keyframes scanReady{ 0%,100%{ box-shadow:0 0 0 rgba(0,200,255,0);} 50%{ box-shadow:0 0 12px rgba(0,200,255,0.2);} }

.move-panel{ width:50%; background:var(--panel); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; padding:10px; position:relative; }
.move-panel-label{ position:absolute; top:10px; left:10px; font-size:7px; letter-spacing:2.5px; color:var(--text-dim); }
.dpad-wrap{ display:flex; flex-direction:column; align-items:center; gap:4px; }
.dpad-row{ display:flex; gap:4px; }

.dir-btn{
  width:44px; height:38px;
  background:var(--surface);
  border:1px solid var(--border-hi);
  color:var(--text-dim);
  font-family:var(--mono);
  font-size:9px;
  letter-spacing:1px;
  cursor:pointer;
  transition:all 0.12s;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}
.dir-btn::after{ content:''; position:absolute; inset:0; background:var(--accent); opacity:0; transition:opacity 0.12s; }
.dir-btn:not(.ghost):hover{ border-color:var(--text-dim); color:var(--text); }
.dir-btn:not(.ghost):active::after{ opacity:0.15; }
.dir-btn:not(.ghost):active{ border-color:var(--accent); color:var(--accent); }
.dir-btn.ghost{ background:transparent; border-color:transparent; cursor:default; pointer-events:none; }
.dir-btn.lit{ border-color:var(--accent); color:var(--accent); }

.rover-state-badge{ font-size:8px; letter-spacing:2px; color:var(--text-dim); border:1px solid var(--border); padding:3px 10px; }
.rover-state-badge.moving{ color:var(--accent); border-color:var(--accent-dk); }
.rover-state-badge.scanning{ color:var(--amber); border-color:var(--amber-dk); }

.modal-bg{ position:fixed; inset:0; z-index:500; background:rgba(0,0,0,0.88); display:flex; align-items:flex-end; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.modal-bg.open{ opacity:1; pointer-events:all; }
.modal-card{ width:100%; background:var(--panel); border-top:1px solid var(--border-hi); padding:20px 16px 28px; max-height:82vh; overflow-y:auto; transform:translateY(16px); transition:transform 0.3s; }
.modal-bg.open .modal-card{ transform:translateY(0); }

.modal-tag{ font-size:7px; letter-spacing:3px; color:var(--text-dim); text-transform:uppercase; margin-bottom:10px; }
.modal-title{ font-family:var(--display); font-size:14px; font-weight:400; letter-spacing:1px; color:var(--text-hi); margin-bottom:6px; }
.modal-sub{ font-size:9px; color:var(--amber); margin-bottom:16px; line-height:1.8; }
.modal-divider{ height:1px; background:var(--border); margin:14px 0; }

.q-text{ font-size:12px; color:var(--text); line-height:1.7; margin-bottom:14px; }
.choices{ display:flex; flex-direction:column; gap:7px; }
.c-btn{
  background:var(--surface); border:1px solid var(--border-hi);
  color:var(--text-dim); font-family:var(--mono); font-size:10px;
  padding:11px 14px; text-align:left; cursor:pointer; transition:all 0.15s; position:relative; line-height:1.5;
}
.c-btn::before{ content:''; position:absolute; left:0; top:0; bottom:0; width:2px; background:var(--accent); transform:scaleY(0); transition:transform 0.15s; }
.c-btn:hover{ border-color:var(--border-hi); color:var(--text); }
.c-btn:hover::before{ transform:scaleY(0.4); }
.c-btn.selected{ border-color:var(--accent); color:var(--accent); }
.c-btn.selected::before{ transform:scaleY(1); }
.c-btn.correct{ border-color:var(--green); color:var(--green); background:rgba(0,232,122,0.04); }
.c-btn.wrong{ border-color:var(--red); color:var(--red); background:rgba(255,58,58,0.04); }

.submit-btn{
  margin-top:14px; width:100%; background:none; border:1px solid var(--accent);
  color:var(--accent); font-family:var(--mono); font-size:10px; letter-spacing:3px;
  padding:13px; cursor:pointer; text-transform:uppercase; transition:background 0.2s; display:none;
}
.submit-btn:hover{ background:rgba(0,200,255,0.06); }
.submit-btn:active{ background:rgba(0,200,255,0.15); }

.result-stats{ display:flex; gap:8px; margin:14px 0; }
.r-stat{ flex:1; border:1px solid var(--border); padding:10px 6px; text-align:center; }
.r-stat-val{ display:block; font-size:16px; color:var(--accent); margin-bottom:3px; font-family:var(--display); font-weight:400; }
.r-stat-val.neg{ color:var(--red); } .r-stat-val.amber{ color:var(--amber); }
.r-stat-label{ font-size:7px; letter-spacing:1.5px; color:var(--text-dim); }

.continue-btn{ margin-top:12px; width:100%; background:none; border:1px solid var(--border-hi); color:var(--text);
  font-family:var(--mono); font-size:10px; letter-spacing:2px; padding:13px; cursor:pointer; transition:background 0.2s;
}
.continue-btn:hover{ background:rgba(255,255,255,0.03); }

.modal-top-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.difficulty-badge{ font-size:7px; letter-spacing:2px; padding:3px 8px; flex-shrink:0; border:1px solid var(--border-hi); color:var(--text-dim); text-transform:uppercase; }
.diff-critical{ border-color:#5a0a0a; color:var(--red); }
.diff-precision{ border-color:var(--accent-dk); color:var(--accent); }
.diff-discovery{ border-color:#1a3a10; color:var(--green); }

.explanation-box{ margin-top:12px; border:1px solid var(--border-hi); background:rgba(0,200,255,0.025); padding:10px 12px; }
.exp-label{ font-size:7px; letter-spacing:2.5px; color:var(--accent); margin-bottom:6px; }
.exp-text{ font-size:10px; color:var(--text); line-height:1.8; }

#research-modal .modal-card{ border-top-color:var(--accent); }
.research-title{ font-family:var(--display); font-size:16px; font-weight:400; color:var(--accent); letter-spacing:1.5px; margin:6px 0 6px; }
.research-sub{ font-size:9px; color:var(--text-dim); line-height:1.8; margin-bottom:12px; }
.research-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.r-card{ border:1px solid var(--border); background:rgba(0,200,255,0.02); padding:10px 10px; }
.r-k{ font-size:7px; letter-spacing:2px; color:var(--text-dim); text-transform:uppercase; margin-bottom:6px; }
.r-v{ font-family:var(--display); font-size:15px; letter-spacing:1px; color:var(--text-hi); }
.r-v.good{ color:var(--green); } .r-v.warn{ color:var(--amber); } .r-v.bad{ color:var(--red); }
.r-mini{ margin-top:6px; font-size:9px; color:var(--text-dim); line-height:1.6; }

.packet-box{ margin-top:12px; border:1px solid var(--border-hi); background:rgba(0,0,0,0.2); padding:10px 10px; }
.packet-label{ font-size:7px; letter-spacing:2.5px; color:var(--accent); margin-bottom:6px; text-transform:uppercase; }
.packet-pre{ white-space:pre-wrap; word-break:break-word; font-size:9px; line-height:1.6; color:var(--text); opacity:0.92; }

.form-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
.inp{ width:100%; background:rgba(2,4,8,0.9); border:1px solid var(--border-hi); color:var(--text); font-family:var(--mono); font-size:10px; padding:10px 10px; outline:none; }
.inp:focus{ border-color:var(--accent); }
textarea.inp{ min-height:78px; resize:none; grid-column:1 / -1; }

.research-cta-row{ display:flex; gap:8px; margin-top:12px; }
.research-btn{ flex:1; background:none; border:1px solid var(--border-hi); color:var(--text); font-family:var(--mono);
  font-size:10px; letter-spacing:2px; padding:12px 10px; cursor:pointer; transition:background 0.2s, border-color 0.2s, color 0.2s; text-transform:uppercase;
}
.research-btn.primary{ border-color:var(--accent); color:var(--accent); }
.research-btn.primary:hover{ background:rgba(0,200,255,0.06); }
.research-btn:hover{ background:rgba(255,255,255,0.03); }
.research-btn.danger{ border-color:var(--red); color:var(--red); }
.research-btn.danger:hover{ background:rgba(255,58,58,0.08); }

.status-pill{ margin-top:10px; border:1px solid var(--border); padding:8px 10px; font-size:9px; letter-spacing:1px; color:var(--text-dim); }
.status-pill.ok{ border-color:#1a3a10; color:#80c860; }
.status-pill.warn{ border-color:var(--amber-dk); color:var(--amber); }
.status-pill.bad{ border-color:var(--red-dk); color:var(--red); }
</style>
</head>

<body>
<div id="overlay-scanlines"></div>
<div id="overlay-vignette"></div>
<div id="overlay-grain"></div>
<div class="solar-glow" id="solar-glow"></div>

<!-- BOOT -->
<div class="screen active" id="boot-screen">
  <div class="boot-header">ISRO · DSN RELAY · HEX-01</div>
  <div class="boot-log" id="boot-log"></div>
  <div class="boot-progress"><div class="boot-progress-fill" id="boot-progress-fill"></div></div>
  <button class="boot-cta" id="boot-cta" onclick="initiateControl()">
    <span class="boot-cta-dot"></span> INITIATE CONTROL
  </button>
</div>

<!-- SIM -->
<div class="screen" id="sim-screen">
  <div class="top-bar">
    <div class="tb-cell">
      <div class="tb-label">Energy Reserve</div>
      <div class="eb-row">
        <div class="eb-track"><div class="eb-fill" id="eb-fill" style="width:84%"></div></div>
        <span class="eb-pct" id="energy-text">84%</span>
      </div>
    </div>
    <div class="tb-cell">
      <div class="tb-label">Signal Latency</div>
      <div class="tb-value" id="latency-text"><span class="sig-dot"></span>12m 30s</div>
    </div>
    <div class="tb-cell">
      <div class="tb-label">Sol / State</div>
      <div class="tb-value" id="sol-text">SOL 127</div>
    </div>
    <div class="storm-badge" id="storm-badge"><span>⚡</span> DUST STORM</div>
    <div class="tb-cell">
      <div class="tb-label">Validation</div>
      <div class="tb-value" id="val-text" style="color:var(--green)">0 pts</div>
    </div>
  </div>

  <div class="viewport" id="viewport">
    <canvas id="threejs-canvas"></canvas>
    <canvas id="terrain-canvas"></canvas>

    <div class="rover-wrap" id="rover-hud">
      <svg viewBox="0 0 130 210" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="59" y="65" width="12" height="130" fill="#0e1e2c"/>
        <rect x="61" y="65" width="8" height="130" fill="#0f2030"/>
        <rect x="59" y="85"  width="12" height="2" fill="#162838"/>
        <rect x="59" y="110" width="12" height="2" fill="#162838"/>
        <rect x="59" y="135" width="12" height="2" fill="#162838"/>
        <rect x="59" y="160" width="12" height="2" fill="#162838"/>
        <rect x="36" y="48" width="58" height="30" rx="3" fill="#0d1c2a"/>
        <rect x="38" y="50" width="54" height="26" rx="2" fill="#091422"/>
        <circle cx="52" cy="63" r="9"  fill="#070f1a"/>
        <circle cx="52" cy="63" r="7"  fill="#080e16"/>
        <circle cx="52" cy="63" r="4.5" fill="#040a10"/>
        <circle cx="50" cy="61" r="1.5" fill="#1a3050" opacity="0.7"/>
        <circle cx="78" cy="63" r="9"  fill="#070f1a"/>
        <circle cx="78" cy="63" r="7"  fill="#080e16"/>
        <circle cx="78" cy="63" r="4.5" fill="#040a10"/>
        <circle cx="76" cy="61" r="1.5" fill="#1a3050" opacity="0.7"/>
        <line x1="65" y1="48" x2="65" y2="26" stroke="#162838" stroke-width="1.5"/>
        <circle cx="65" cy="24" r="3.5" fill="#0d1c2a" stroke="#00c8ff" stroke-width="0.6" opacity="0.6"/>
        <rect x="94" y="53" width="22" height="4" rx="1" fill="#0e1e2c"/>
        <circle cx="117" cy="55" r="4.5" fill="#0d1c2a" stroke="#162838" stroke-width="1"/>
        <circle cx="90" cy="55" r="2.2" fill="#00c8ff" opacity="0.5" id="status-led"/>
      </svg>
    </div>

    <div class="terrain-overlay">
      <div class="to-name" id="to-name">BASALTIC FLATS</div>
      <div class="to-row">CMPLX <span id="to-cmplx">2.1</span></div>
      <div class="to-row">SLIP  <span id="to-slip">2%</span></div>
    </div>

    <div class="node-pill" id="node-pill">◈ GEO-NODE IN PROXIMITY · SCAN ENABLED</div>
    <div class="lat-banner" id="lat-banner">TRANSMITTING COMMAND…</div>
    <div class="toast-log" id="toast-log">SYS: AWAITING COMMAND</div>
    <div class="val-chip">TILES <span id="val-chip-val">0</span></div>
    <div class="storm-veil" id="storm-veil"></div>
    <div class="hb-veil" id="hb-veil"></div>
  </div>

  <div class="controls-wrap">
    <div class="cam-panel">
      <div class="panel-label"><span class="sig-dot" style="width:4px;height:4px"></span>NAVCAM_L · FEED</div>
      <div class="cam-screen">
        <div class="cam-data" id="cam-data">FOCAL 50mm<br>ISO 800<br>EXP 1/250</div>
        <div class="scan-sweep" id="scan-sweep"></div>
      </div>
      <div class="sys-rows">
        <div class="sys-row"><span class="sys-key">ROVER</span><span class="sys-val ok" id="sr-state">IDLE</span></div>
        <div class="sys-row"><span class="sys-key">TEMP</span><span class="sys-val" id="sr-temp">-54.2°C</span></div>
        <div class="sys-row"><span class="sys-key">SOLAR</span><span class="sys-val ok" id="sr-solar">OPTIMAL</span></div>
      </div>

      <!-- Scan is enabled only when GEO-NODE is nearby (scan logic enabled) -->
      <button class="scan-btn" id="scan-btn" onclick="startScan()">◈ INITIATE APXS SCAN</button>
    </div>

    <div class="move-panel">
      <div class="move-panel-label">MOVE CONTROL · 8-DIR</div>
      <div class="dpad-wrap">
        <div class="dpad-row">
          <button class="dir-btn" id="d-NW" onclick="move('NW')">NW</button>
          <button class="dir-btn" id="d-N"  onclick="move('N')"> N </button>
          <button class="dir-btn" id="d-NE" onclick="move('NE')">NE</button>
        </div>
        <div class="dpad-row">
          <button class="dir-btn" id="d-W"  onclick="move('W')"> W </button>
          <button class="dir-btn" id="d-scan" onclick="startScan()" style="font-size:7px;letter-spacing:1px;color:var(--text-dim)">SCN</button>
          <button class="dir-btn" id="d-E"  onclick="move('E')"> E </button>
        </div>
        <div class="dpad-row">
          <button class="dir-btn" id="d-SW" onclick="move('SW')">SW</button>
          <button class="dir-btn" id="d-S"  onclick="move('S')"> S </button>
          <button class="dir-btn" id="d-SE" onclick="move('SE')">SE</button>
        </div>
      </div>
      <div class="rover-state-badge" id="rsb">IDLE</div>
    </div>
  </div>
</div>

<!-- CHALLENGE MODAL -->
<div class="modal-bg" id="challenge-modal">
  <div class="modal-card">
    <div class="modal-top-row">
      <div class="modal-tag" id="c-qid">◈ Q_001 · APXS</div>
      <div class="difficulty-badge diff-critical" id="c-diff">CRITICAL</div>
    </div>
    <div class="modal-title" id="c-title">Surface Spectral Analysis</div>
    <div class="modal-sub" id="c-sub">Spectrometer data indicates high Fe₂O₃ concentration.</div>
    <div class="modal-divider"></div>
    <div class="q-text" id="q-text">Select analysis hypothesis:</div>
    <div class="choices" id="choices-div"></div>
    <div class="explanation-box" id="explanation-box" style="display:none">
      <div class="exp-label">◈ SCIENTIFIC BASIS</div>
      <div class="exp-text" id="exp-text"></div>
    </div>
    <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">TRANSMIT ANALYSIS</button>
  </div>
</div>

<!-- RESULT MODAL -->
<div class="modal-bg" id="result-modal">
  <div class="modal-card">
    <div class="modal-tag" id="r-tag">◈ TRANSMISSION LOGGED</div>
    <div class="modal-title" id="r-title">Analysis Confirmed</div>
    <div class="modal-sub" id="r-sub"></div>
    <div class="result-stats">
      <div class="r-stat">
        <span class="r-stat-val" id="r-energy">+8%</span>
        <div class="r-stat-label">ENERGY DELTA</div>
      </div>
      <div class="r-stat">
        <span class="r-stat-val" id="r-val">+10pts</span>
        <div class="r-stat-label">VALIDATION</div>
      </div>
      <div class="r-stat">
        <span class="r-stat-val" id="r-lat">—</span>
        <div class="r-stat-label">LATENCY DELTA</div>
      </div>
    </div>
    <button class="continue-btn" onclick="closeResult()">CONTINUE MISSION</button>
  </div>
</div>

<!-- RESEARCH MODAL -->
<div class="modal-bg" id="research-modal">
  <div class="modal-card">
    <div class="modal-tag">◈ RESEARCH MODE · OPERATOR DECISION PACKET</div>
    <div class="research-title">ENERGY DEPLETED · SUBMIT FOR DEV REVIEW</div>
    <div class="research-sub">
      Send this packet to the dev team. They will analyze your mission run and forward to ISRO if feasible.
    </div>

    <div class="modal-divider"></div>

    <div class="research-grid">
      <div class="r-card">
        <div class="r-k">Validation Score</div>
        <div class="r-v good" id="rg-val">0</div>
        <div class="r-mini" id="rg-val-mini">Correct interpretations logged.</div>
      </div>
      <div class="r-card">
        <div class="r-k">Decision Accuracy</div>
        <div class="r-v" id="rg-acc">—</div>
        <div class="r-mini" id="rg-acc-mini">Correct / total analyses.</div>
      </div>
      <div class="r-card">
        <div class="r-k">Mobility Risk Events</div>
        <div class="r-v warn" id="rg-risk">0</div>
        <div class="r-mini" id="rg-risk-mini">Slip + storm count.</div>
      </div>
      <div class="r-card">
        <div class="r-k">Latency Penalty</div>
        <div class="r-v" id="rg-lat">—</div>
        <div class="r-mini" id="rg-lat-mini">Operator penalties accumulated.</div>
      </div>
    </div>

    <div class="packet-box">
      <div class="packet-label">◈ PACKET (SHORT PREVIEW)</div>
      <div class="packet-pre" id="packet-preview">—</div>

      <div class="form-row">
        <input class="inp" id="op-name" placeholder="Operator name (optional)" />
        <input class="inp" id="op-email" placeholder="Email (optional)" />
        <textarea class="inp" id="op-notes" placeholder="Notes for dev team (optional): goals, constraints, new feature request…"></textarea>
      </div>

      <div class="status-pill" id="submit-status">STATUS: READY · NOT SENT</div>
    </div>

    <div class="research-cta-row">
      <button class="research-btn primary" onclick="sendToDev()">SEND TO DEV REVIEW</button>
      <button class="research-btn" onclick="copyPacket()">COPY PACKET</button>
      <button class="research-btn danger" onclick="endSim()">END SIMULATION</button>
    </div>
  </div>
</div>

<script>
/* =============================
   IMPORTANT: SCAN LOGIC ENABLED
   ============================= */
/**
 * Scan is enabled only when:
 *  - Rover is IDLE
 *  - Energy >= scan cost
 *  - GEO-NODE is nearby (nodeNearby === true)
 *
 * This matches a “real mission” flow: you scan only on targets.
 */
const REQUIRE_NODE_FOR_SCAN = true;

/* ============================================================
   PATHS / CTA CONFIG
   ============================================================ */
const GLB_MODEL_URL = "24881_Mars_1_6792.glb";

const DEV_WEBHOOK_URL = "";              // e.g. "https://yourdomain.com/api/hex01-submit"
const DEV_FALLBACK_EMAIL = "dharam@viadecide.com";

/* ============================================================
   ENGINE CONFIG
   ============================================================ */
const MISSION_CONFIG = {
  communications: { latency: { minMs: 240000, maxMs: 1440000, averageMs: 750000 } },
  locomotion: { baseEnergyDrainPerMove: 1.5 },
  instruments: { apxs_spectrometer: { energyCostPct: 12.0 } }
};

const TERRAIN_DATABASE = [
  { id:"T_BASALTIC_FLATS",  name:"Basaltic Flats",  complexityIndex:2.1, hazards:{ slipProbability:0.02, costMult:1.0 } },
  { id:"T_REGOLITH_FIELD",  name:"Regolith Field",  complexityIndex:4.5, hazards:{ slipProbability:0.15, costMult:1.2 } },
  { id:"T_SCORIA_OUTCROP",  name:"Scoria Outcrop",  complexityIndex:6.8, hazards:{ slipProbability:0.40, costMult:1.8 } },
  { id:"T_SOFT_DUST_DRIFT", name:"Soft Dust Drift", complexityIndex:8.5, hazards:{ slipProbability:0.85, costMult:2.5 } }
];

const S = {
  energy: 84,
  validation: 0,
  roverState: 'IDLE',
  stormActive: false,
  currentTerrain: TERRAIN_DATABASE[0],
  playableLatencyMs: 1200,
  simLatencySeconds: MISSION_CONFIG.communications.latency.averageMs / 1000,
  nodeNearby: false,
  _lastDir: null,

  runId: null,
  startTs: null,
  endedTs: null,
  isOffline: false,
  metrics: {
    moves: 0, scans: 0, challenges: 0, correct: 0, wrong: 0,
    slips: 0, storms: 0, latencyPenaltySeconds: 0,
    energySpentMoves: 0, energySpentScans: 0, energyPenaltyWrong: 0
  },
  log: []
};

let loops = { solar: null, nodes: null };
let use3D = false;
let rAF2d = null;

const CHALLENGES = [
  {
    id:"Q_001", instrument:"APXS · MSL", difficulty:"CRITICAL",
    title:"APXS Lockup Anomaly — Tactical Mitigation",
    sub:"Telemetry shows instrument generating artificial counts at lowest energy channel only.",
    question:"During a long-duration APXS integration on Curiosity, the instrument has stopped recording real X-ray events and is only generating artificial counts at the lowest detectable energy channel — the \"lockup\" anomaly. What is the required tactical mitigation?",
    choices:[
      { text:"A) Increase the integration time to 5 hours to override the internal software buffer.", correct:false },
      { text:"B) Initiate a power cycle and split subsequent long integrations into two shorter sessions.", correct:true },
      { text:"C) Deploy the robotic arm to the basaltic calibration slab to reset the Curium-244 flux.", correct:false }
    ],
    explanation:"Power cycling clears the lockup state. Splitting subsequent integrations into shorter sessions prevents recurrence."
  },
  {
    id:"Q_002", instrument:"NavCam · MSL RSM", difficulty:"PRECISION",
    title:"NavCam Stereo Baseline — RSM Geometric Engine",
    sub:"Stereo pair used for ChemCam target distance calculation.",
    question:"A NavCam stereo pair on the MSL Remote Sensing Mast (RSM) is being used to calculate the distance to a rock target for ChemCam targeting. What is the fixed stereo baseline distance used by the simulator's geometric engine for this calculation?",
    choices:[
      { text:"A) 20.0 cm", correct:false },
      { text:"B) 42.4 cm", correct:true },
      { text:"C) 1.97 m", correct:false }
    ],
    explanation:"The MSL RSM NavCam stereo baseline is 42.4 cm."
  },
  {
    id:"Q_003", instrument:"APXS · MSL", difficulty:"DISCOVERY",
    title:"APXS Contact Analysis — Surprise Detection",
    sub:"Spectra show never-before-seen element in pure form on Mars.",
    question:"Curiosity's APXS performed contact analysis on a fractured rock. What was detected in pure form?",
    choices:[
      { text:"A) Pure Magnesium", correct:false },
      { text:"B) Pure Sulfur crystals", correct:true },
      { text:"C) Pure Hematite", correct:false }
    ],
    explanation:"The fractured rock exposed pure sulfur crystals."
  }
];

let challengeIdx = 0;
let selectedChoiceIdx = null;

const DIR_VECTORS = { N:[0,-1], NE:[1,-1], E:[1,0], SE:[1,1], S:[0,1], SW:[-1,1], W:[-1,0], NW:[-1,-1] };

/* ============================================================
   2D TERRAIN FALLBACK
   ============================================================ */
let canvas2d, ctx2d;
function initCanvas2d() {
  canvas2d = document.getElementById('terrain-canvas');
  const vp = document.getElementById('viewport');
  canvas2d.width = vp.offsetWidth;
  canvas2d.height = vp.offsetHeight;
  window.addEventListener('resize', () => {
    canvas2d.width = vp.offsetWidth;
    canvas2d.height = vp.offsetHeight;
  });
}
function drawTerrain2d() {
  if (!ctx2d) ctx2d = canvas2d.getContext('2d');
  const w = canvas2d.width, h = canvas2d.height;
  ctx2d.clearRect(0,0,w,h);
  const sky = ctx2d.createLinearGradient(0,0,0,h*0.48);
  sky.addColorStop(0,'#060204'); sky.addColorStop(1,'#180a06');
  ctx2d.fillStyle = sky; ctx2d.fillRect(0,0,w,h*0.48);
  const grd = ctx2d.createLinearGradient(0,h*0.46,0,h);
  grd.addColorStop(0,'#1c0e07'); grd.addColorStop(0.4,'#160b06'); grd.addColorStop(1,'#0e0704');
  ctx2d.fillStyle = grd; ctx2d.fillRect(0,h*0.46,w,h*0.54);
}
function renderLoop2d() { drawTerrain2d(); rAF2d = requestAnimationFrame(renderLoop2d); }

/* ============================================================
   3D RENDERER
   ============================================================ */
const Renderer3D = (() => {
  let ready = false;
  let scene, camera, renderer, clock;
  let root = null;
  let loaded = false;
  let vpEl = null;

  let terrainX = 0;
  let terrainZ = 0;

  let fog = null;
  let sun = null;

  function setStatusLED(ok) {
    const led = document.getElementById('status-led');
    if (!led) return;
    led.setAttribute('opacity', ok ? '0.7' : '0.25');
  }

  function init(){ ready = !!(window.THREE && window.THREE.GLTFLoader); return ready; }

  function resize() {
    if (!renderer || !camera || !vpEl) return;
    const w = vpEl.clientWidth;
    const h = vpEl.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }

  function buildFallbackGround() {
    const g = new THREE.PlaneGeometry(120, 120, 1, 1);
    const m = new THREE.MeshStandardMaterial({ color: 0x2a140b, roughness: 1.0, metalness: 0.0 });
    const p = new THREE.Mesh(g, m);
    p.rotation.x = -Math.PI/2;
    p.position.y = 0;
    scene.add(p);
  }

  function loadGLB(url) {
    return new Promise((resolve, reject) => {
      const loader = new THREE.GLTFLoader();
      loader.load(url, resolve, undefined, reject);
    });
  }

  let raf = null;

  async function start() {
    vpEl = document.getElementById('viewport');
    const canvasEl = document.getElementById('threejs-canvas');

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x05080c);
    fog = new THREE.Fog(0x05080c, 6, 28);
    scene.fog = fog;

    const w = vpEl.clientWidth, h = vpEl.clientHeight;
    camera = new THREE.PerspectiveCamera(50, w/h, 0.1, 200);
    camera.position.set(0, 4.0, 10.5);
    camera.lookAt(0, 0.6, 0);

    renderer = new THREE.WebGLRenderer({ canvas: canvasEl, antialias: true, alpha: false });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(w, h, false);
    renderer.outputEncoding = THREE.sRGBEncoding;

    sun = new THREE.DirectionalLight(0xffb37a, 1.4);
    sun.position.set(6, 10, 6);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0x4b2a18, 0.55));

    root = new THREE.Group();
    scene.add(root);

    setStatusLED(false);
    try {
      const gltf = await loadGLB(GLB_MODEL_URL);
      loaded = true;
      setStatusLED(true);

      root.add(gltf.scene);
      gltf.scene.scale.setScalar(1.0);
      gltf.scene.position.set(0, 0, 0);

      gltf.scene.traverse((obj) => {
        if (obj.isMesh) {
          obj.receiveShadow = true;
          if (obj.material) obj.material.side = THREE.FrontSide;
        }
      });
    } catch (e) {
      loaded = false;
      setStatusLED(false);
      // still render fallback ground in 3D mode
    }

    buildFallbackGround();

    clock = new THREE.Clock();
    window.addEventListener('resize', resize);
    animate();
  }

  function animate() {
    raf = requestAnimationFrame(animate);
    const dt = clock ? clock.getDelta() : 0.016;
    const t = performance.now() * 0.0002;
    camera.position.x = Math.sin(t) * 0.15;
    camera.position.y = 4.0 + Math.sin(t * 1.6) * 0.05;

    if (root) {
      root.position.x += (terrainX - root.position.x) * Math.min(1, dt * 6);
      root.position.z += (terrainZ - root.position.z) * Math.min(1, dt * 6);
    }
    renderer.render(scene, camera);
  }

  function stop() {
    if (raf) cancelAnimationFrame(raf);
    raf = null;
    window.removeEventListener('resize', resize);
    renderer?.dispose?.();
    scene = null; camera = null; renderer = null; root = null; loaded = false;
    terrainX = 0; terrainZ = 0;
  }

  function applySnapshot(snap) {
    if (!scene || !fog || !sun) return;
    if (snap.stormActive) {
      fog.near = 3; fog.far = 16;
      scene.fog.color.setHex(0x2a1508);
      sun.color.setHex(0xffa35d);
      sun.intensity = 1.05;
    } else {
      fog.near = 6; fog.far = 28;
      scene.fog.color.setHex(0x05080c);
      sun.color.setHex(0xffb37a);
      sun.intensity = 1.4;
    }
  }

  function nudgeTerrain(dx, dz) { terrainX -= dx; terrainZ -= dz; }

  function isReady(){ return ready; }
  function isLoaded(){ return loaded; }

  return { init, start, stop, applySnapshot, nudgeTerrain, isReady, isLoaded };
})();

/* ============================================================
   EVENT BUS
   ============================================================ */
const HEX01_Bus = (() => {
  const target = new EventTarget();
  return {
    dispatch(type, detail) { target.dispatchEvent(new CustomEvent(type, { detail })); },
    on(type, fn) { target.addEventListener(type, e => fn(e.detail)); }
  };
})();

function HEX01_Snapshot() {
  return {
    energy: S.energy,
    roverState: S.roverState,
    stormActive: S.stormActive,
    nodeNearby: S.nodeNearby,
    currentTerrain: {
      name: S.currentTerrain.name,
      complexityIndex: S.currentTerrain.complexityIndex,
      hazards: { ...S.currentTerrain.hazards }
    },
    lastDir: S._lastDir
  };
}

HEX01_Bus.on('stateChange', snap => {
  if (Renderer3D.isReady()) Renderer3D.applySnapshot(snap);
});

/* ============================================================
   RESEARCH HELPERS
   ============================================================ */
function nowISO(){ return new Date().toISOString(); }
function mkRunId(){
  const t = Date.now().toString(36);
  const r = Math.random().toString(36).slice(2,8);
  return `HEX01-${t}-${r}`.toUpperCase();
}
function logEvent(type, data = {}){
  S.log.push({ t: nowISO(), type, ...data });
  if (S.log.length > 150) S.log.splice(0, S.log.length - 150);
}
function setSubmitStatus(text, cls){
  const el = document.getElementById('submit-status');
  if (!el) return;
  el.textContent = text;
  el.className = 'status-pill ' + (cls || '');
}
function buildResearchPacket(){
  const total = S.metrics.correct + S.metrics.wrong;
  const acc = total > 0 ? (S.metrics.correct / total) : null;
  return {
    schema: "HEX01_REVIEW_PACKET_V1",
    runId: S.runId,
    startedAt: S.startTs,
    endedAt: S.endedTs,
    operator: {
      name: (document.getElementById('op-name')?.value || "").trim() || null,
      email: (document.getElementById('op-email')?.value || "").trim() || null,
      notes: (document.getElementById('op-notes')?.value || "").trim() || null
    },
    finalState: {
      energy: Math.max(0, Math.floor(S.energy)),
      validation: S.validation,
      latencySeconds: Math.floor(S.simLatencySeconds),
      playableLatencyMs: Math.floor(S.playableLatencyMs),
      lastDir: S._lastDir,
      terrain: S.currentTerrain?.id || null,
      stormActive: !!S.stormActive
    },
    metrics: { ...S.metrics, decisionAccuracy: acc === null ? null : Math.round(acc * 1000) / 10 },
    eventLog: S.log
  };
}

async function sendToDev(){
  const packet = buildResearchPacket();
  setSubmitStatus('STATUS: SENDING…', 'warn');

  if (DEV_WEBHOOK_URL && DEV_WEBHOOK_URL.trim()) {
    try {
      const res = await fetch(DEV_WEBHOOK_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(packet)
      });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      setSubmitStatus('STATUS: SENT ✓ DEV REVIEW QUEUED', 'ok');
      logToast('PACKET SENT TO DEV TEAM');
      logEvent('DEV_SUBMIT', { via:'webhook', ok:true });
      return;
    } catch (e) {
      setSubmitStatus('STATUS: WEBHOOK FAILED · FALLBACK', 'bad');
      logEvent('DEV_SUBMIT', { via:'webhook', ok:false, err:String(e) });
    }
  }

  try {
    const subject = encodeURIComponent(`HEX-01 Review Packet · ${packet.runId}`);
    const bodyObj = {
      runId: packet.runId,
      summary: {
        validation: packet.finalState.validation,
        energy: packet.finalState.energy,
        decisionAccuracy: packet.metrics.decisionAccuracy,
        riskIndex: packet.metrics.slips + packet.metrics.storms,
        latencyPenaltySeconds: packet.metrics.latencyPenaltySeconds
      },
      note: "If feasible, please forward consolidated review to ISRO."
    };
    const body = encodeURIComponent(
      "HEX-01 DEV REVIEW REQUEST\n\n" +
      JSON.stringify(bodyObj, null, 2) +
      "\n\n(Use COPY PACKET for full JSON.)"
    );
    window.location.href = `mailto:${DEV_FALLBACK_EMAIL}?subject=${subject}&body=${body}`;
    setSubmitStatus('STATUS: EMAIL DRAFT OPENED · SEND MANUALLY', 'ok');
    logToast('EMAIL DRAFT GENERATED');
    logEvent('DEV_SUBMIT', { via:'mailto', ok:true });
  } catch (e) {
    setSubmitStatus('STATUS: SEND FAILED · USE COPY PACKET', 'bad');
    logToast('ERROR: UNABLE TO OPEN EMAIL CLIENT');
    logEvent('DEV_SUBMIT', { via:'mailto', ok:false, err:String(e) });
  }
}

async function copyPacket(){
  const txt = JSON.stringify(buildResearchPacket(), null, 2);
  try {
    await navigator.clipboard.writeText(txt);
    setSubmitStatus('STATUS: COPIED ✓ (PASTE TO DEV)', 'ok');
    logToast('PACKET COPIED');
    logEvent('PACKET_COPY', {});
  } catch {
    prompt('Copy this packet:', txt);
    setSubmitStatus('STATUS: MANUAL COPY (PROMPT)', 'warn');
    logEvent('PACKET_COPY', { fallback:true });
  }
}

/* ============================================================
   UI + CORE
   ============================================================ */
function logToast(msg){ document.getElementById('toast-log').textContent = 'SYS: ' + msg; }

function canScanNow() {
  const energyOk = S.energy >= MISSION_CONFIG.instruments.apxs_spectrometer.energyCostPct;
  const stateOk = S.roverState === 'IDLE' && !S.isOffline;
  const nodeOk  = REQUIRE_NODE_FOR_SCAN ? S.nodeNearby : true;
  return stateOk && energyOk && nodeOk;
}

function updateUI(){
  const pct = Math.max(0, Math.floor(S.energy));
  document.getElementById('eb-fill').style.width = pct + '%';
  document.getElementById('energy-text').textContent = pct + '%';

  const fill = document.getElementById('eb-fill');
  fill.style.background = pct < 15 ? 'var(--red)' : pct < 30 ? 'var(--amber)' : 'var(--accent)';

  const mins = Math.floor(S.simLatencySeconds / 60);
  const secs = Math.floor(S.simLatencySeconds % 60);
  document.getElementById('latency-text').innerHTML = `<span class="sig-dot"></span>${mins}m ${secs}s`;

  document.getElementById('val-text').textContent = S.validation + ' pts';
  document.getElementById('val-chip-val').textContent = S.validation;

  document.getElementById('to-name').textContent = S.currentTerrain.name.toUpperCase();
  document.getElementById('to-cmplx').textContent = S.currentTerrain.complexityIndex;
  document.getElementById('to-slip').textContent = (S.currentTerrain.hazards.slipProbability * 100).toFixed(0) + '%';

  const stateEl = document.getElementById('sr-state');
  stateEl.textContent = S.roverState;
  stateEl.className = 'sys-val ' + (S.roverState === 'IDLE' ? 'ok' : S.roverState === 'SCANNING' ? 'warn' : (S.roverState === 'OFFLINE' ? 'bad' : ''));

  document.getElementById('sr-temp').textContent = S.stormActive ? '-85.4°C' : '-54.2°C';
  const solarEl = document.getElementById('sr-solar');
  solarEl.textContent = S.stormActive ? 'COMPROMISED' : 'OPTIMAL';
  solarEl.className = 'sys-val ' + (S.stormActive ? 'warn' : 'ok');

  const rsb = document.getElementById('rsb');
  rsb.textContent = S.roverState;
  rsb.className = 'rover-state-badge ' + (String(S.roverState).includes('MOVING') ? 'moving' : S.roverState === 'SCANNING' ? 'scanning' : '');

  // SCAN BUTTONS + LOGIC (ENABLED)
  const scanBtn = document.getElementById('scan-btn');
  const can = canScanNow();
  scanBtn.className = 'scan-btn' + (can ? ' ready' : '');

  const scnBtn = document.getElementById('d-scan');
  if (scnBtn) {
    scnBtn.style.borderColor = can ? 'var(--accent)' : '';
    scnBtn.style.color = can ? 'var(--accent)' : 'var(--text-dim)';
    scnBtn.style.boxShadow = can ? '0 0 8px rgba(0,200,255,0.3)' : '';
    scnBtn.style.cursor = can ? 'pointer' : 'not-allowed';
  }

  document.getElementById('node-pill').classList.toggle('visible', S.nodeNearby);
  document.getElementById('storm-badge').classList.toggle('visible', S.stormActive);
  document.getElementById('storm-veil').classList.toggle('active', S.stormActive);
  document.getElementById('hb-veil').classList.toggle('pulse', S.energy < 15);

  if (S.energy <= 0 && !S.isOffline) {
    S.energy = 0;
    S.isOffline = true;
    S.roverState = 'OFFLINE';
    S.endedTs = nowISO();
    logEvent('RUN_END', { reason:'ENERGY_DEPLETED' });

    clearInterval(loops.solar);
    clearInterval(loops.nodes);

    document.getElementById('result-modal').classList.remove('open');
    document.getElementById('challenge-modal').classList.remove('open');

    logToast('OFFLINE · ENTERING RESEARCH MODE');
    openResearchModal();
  }

  HEX01_Bus.dispatch('stateChange', HEX01_Snapshot());
}

function openResearchModal(){
  const packet = buildResearchPacket();
  const total = S.metrics.correct + S.metrics.wrong;
  const accPct = total ? Math.round((S.metrics.correct / total) * 100) : null;

  document.getElementById('rg-val').textContent = `${S.validation} pts`;
  document.getElementById('rg-val-mini').textContent = `${Math.floor(S.validation/10)} validated tiles unlocked`;

  const accEl = document.getElementById('rg-acc');
  accEl.textContent = (accPct === null) ? '—' : `${accPct}%`;
  accEl.className = 'r-v ' + (accPct === null ? '' : (accPct >= 70 ? 'good' : accPct >= 45 ? 'warn' : 'bad'));
  document.getElementById('rg-acc-mini').textContent = `${S.metrics.correct} correct / ${total} total analyses`;

  const risk = S.metrics.slips + S.metrics.storms;
  const riskEl = document.getElementById('rg-risk');
  riskEl.textContent = `${risk}`;
  riskEl.className = 'r-v ' + (risk <= 2 ? 'good' : risk <= 5 ? 'warn' : 'bad');
  document.getElementById('rg-risk-mini').textContent = `${S.metrics.slips} slips · ${S.metrics.storms} storms`;

  const latEl = document.getElementById('rg-lat');
  latEl.textContent = `+${S.metrics.latencyPenaltySeconds}s`;
  latEl.className = 'r-v ' + (S.metrics.latencyPenaltySeconds <= 120 ? 'good' : S.metrics.latencyPenaltySeconds <= 360 ? 'warn' : 'bad');
  document.getElementById('rg-lat-mini').textContent = `playable latency now ${Math.floor(S.playableLatencyMs)}ms`;

  const previewObj = {
    runId: packet.runId,
    validation: packet.finalState.validation,
    energy: packet.finalState.energy,
    accuracy: packet.metrics.decisionAccuracy,
    riskIndex: risk,
    latencyPenaltySeconds: packet.metrics.latencyPenaltySeconds
  };
  document.getElementById('packet-preview').textContent = JSON.stringify(previewObj, null, 2);

  setSubmitStatus('STATUS: READY · NOT SENT', '');
  document.getElementById('research-modal').classList.add('open');
}

function initiateControl(){
  document.getElementById('boot-screen').classList.remove('active');
  document.getElementById('sim-screen').classList.add('active');

  S.runId = mkRunId();
  S.startTs = nowISO();
  S.endedTs = null;
  S.isOffline = false;
  S.log = [];
  logEvent('RUN_START', { runId:S.runId });

  const ok3d = Renderer3D.init();
  if (ok3d) {
    use3D = true;
    document.getElementById('terrain-canvas').style.display = 'none';
    document.getElementById('threejs-canvas').style.display = 'block';
    Renderer3D.start().catch(() => {
      use3D = false;
      document.getElementById('terrain-canvas').style.display = 'block';
      document.getElementById('threejs-canvas').style.display = 'none';
      initCanvas2d(); renderLoop2d();
      logToast('3D LOAD FAILED · FALLBACK 2D');
    });
  } else {
    use3D = false;
    document.getElementById('terrain-canvas').style.display = 'block';
    document.getElementById('threejs-canvas').style.display = 'none';
    initCanvas2d(); renderLoop2d();
  }

  updateUI();
  startLoops();
}

function endSim(){
  document.getElementById('research-modal').classList.remove('open');
  document.getElementById('result-modal').classList.remove('open');
  document.getElementById('challenge-modal').classList.remove('open');

  document.getElementById('sim-screen').classList.remove('active');
  document.getElementById('boot-screen').classList.add('active');

  clearInterval(loops.solar);
  clearInterval(loops.nodes);

  if (use3D) Renderer3D.stop();
  if (rAF2d) { cancelAnimationFrame(rAF2d); rAF2d = null; }

  S.energy = 84; S.validation = 0; S.roverState = 'IDLE'; S.stormActive = false;
  S.playableLatencyMs = 1200;
  S.simLatencySeconds = MISSION_CONFIG.communications.latency.averageMs / 1000;
  S.nodeNearby = false; S._lastDir = null; S.currentTerrain = TERRAIN_DATABASE[0];

  S.runId=null; S.startTs=null; S.endedTs=null; S.isOffline=false;
  S.metrics = { moves:0, scans:0, challenges:0, correct:0, wrong:0, slips:0, storms:0, latencyPenaltySeconds:0, energySpentMoves:0, energySpentScans:0, energyPenaltyWrong:0 };
  S.log = [];
  challengeIdx = 0;
  selectedChoiceIdx = null;

  updateUI();
}

/* ============================================================
   LOOPS
   ============================================================ */
function startLoops(){
  // solar recharge (kept simple)
  loops.solar = setInterval(() => {
    if (S.isOffline) return;
    if (S.roverState === 'IDLE' && S.energy < 100) {
      S.energy = Math.min(100, S.energy + 0.5);
      const sg = document.getElementById('solar-glow');
      sg.classList.add('active');
      setTimeout(() => sg.classList.remove('active'), 1000);
      updateUI();
    }
  }, 2000);

  // node discovery: if moving, chance to find node; node persists 12s
  loops.nodes = setInterval(() => {
    if (S.isOffline) return;

    // optional dust storm toggles (rare) - also counts as risk
    if (!S.stormActive && Math.random() < 0.03) {
      S.stormActive = true;
      S.metrics.storms += 1;
      logEvent('STORM_START', {});
      logToast('DUST STORM · VISIBILITY REDUCED');
      updateUI();
      setTimeout(() => {
        if (S.isOffline) return;
        S.stormActive = false;
        logEvent('STORM_END', {});
        logToast('STORM CLEARED · SOLAR RESTORED');
        updateUI();
      }, 12000);
    }

    if (S.roverState === 'MOVING' && !S.nodeNearby && Math.random() < 0.35) {
      S.nodeNearby = true;
      logEvent('NODE_NEARBY', {});
      logToast('GEO-NODE PROXIMITY ALERT — SCAN ENABLED');
      updateUI();

      setTimeout(() => {
        if (S.isOffline) return;
        S.nodeNearby = false;
        logToast('GEO-NODE WINDOW CLOSED');
        updateUI();
      }, 12000);
    }
  }, 2500);
}

/* ============================================================
   MOVE
   ============================================================ */
function move(dir){
  if (S.isOffline) return;
  if (S.roverState !== 'IDLE' || S.energy <= 0) return;

  S._lastDir = dir;
  S.roverState = 'MOVING_QUEUED';
  logToast(`CMD [MOVE ${dir}] TRANSMITTING…`);
  logEvent('MOVE_QUEUED', { dir });

  const btn = document.getElementById('d-' + dir);
  if (btn) btn.classList.add('lit');

  document.getElementById('lat-banner').classList.add('visible');
  updateUI();

  setTimeout(() => {
    if (S.isOffline) return;
    if (btn) btn.classList.remove('lit');
    document.getElementById('lat-banner').classList.remove('visible');
    executeMove(dir);
  }, S.playableLatencyMs);
}

function executeMove(dir){
  if (S.isOffline) return;

  S.roverState = 'MOVING';
  S.currentTerrain = TERRAIN_DATABASE[Math.floor(Math.random() * TERRAIN_DATABASE.length)];
  S.metrics.moves += 1;

  const drain = MISSION_CONFIG.locomotion.baseEnergyDrainPerMove * S.currentTerrain.hazards.costMult;
  S.energy -= drain;
  S.metrics.energySpentMoves += drain;

  const v = DIR_VECTORS[dir] || [0,0];
  if (use3D) Renderer3D.nudgeTerrain(v[0] * 0.55, v[1] * 0.55);

  if (Math.random() < S.currentTerrain.hazards.slipProbability) {
    logToast('HAZARD: WHEEL SLIP — EXTRA POWER DRAWN');
    S.energy -= 2.5;
    S.metrics.slips += 1;
    S.metrics.energySpentMoves += 2.5;
    logEvent('SLIP', { terrain:S.currentTerrain.id, extraDrain:2.5 });
  } else {
    logToast(`MOVED ${dir} · TERRAIN: ${S.currentTerrain.name.toUpperCase()}`);
  }

  logEvent('MOVE_EXEC', { dir, terrain:S.currentTerrain.id, drain });

  setTimeout(() => {
    if (S.isOffline) return;
    S.roverState = 'IDLE';
    updateUI();
  }, 900);

  updateUI();
}

/* ============================================================
   SCAN (ENABLED + STRICT LOGIC)
   ============================================================ */
function startScan(){
  if (S.isOffline) return;

  // main gate
  if (!canScanNow()) {
    if (S.roverState !== 'IDLE') { logToast('BUSY: WAIT FOR ROVER IDLE'); return; }
    if (S.energy < MISSION_CONFIG.instruments.apxs_spectrometer.energyCostPct) { logToast('ERROR: INSUFFICIENT ENERGY'); updateUI(); return; }
    if (REQUIRE_NODE_FOR_SCAN && !S.nodeNearby) { logToast('NO TARGET: MOVE TO GEO-NODE TO SCAN'); updateUI(); return; }
    return;
  }

  S.roverState = 'SCANNING';
  S.metrics.scans += 1;
  logToast('APXS SCAN INITIATED — PROCESSING…');
  logEvent('SCAN_START', { nodeNearby: S.nodeNearby });

  document.getElementById('cam-data').textContent = 'SCANNING…\nANALYSING…\nPROCESSING…';
  document.getElementById('scan-sweep').classList.add('active');
  updateUI();

  setTimeout(() => {
    if (S.isOffline) return;

    const cost = MISSION_CONFIG.instruments.apxs_spectrometer.energyCostPct;
    S.energy -= cost;
    S.metrics.energySpentScans += cost;

    document.getElementById('scan-sweep').classList.remove('active');
    document.getElementById('cam-data').innerHTML = 'FOCAL 50mm<br>ISO 800<br>EXP 1/250';

    // consume node window (target used)
    S.nodeNearby = false;
    S.roverState = 'IDLE';

    logEvent('SCAN_END', { energyCostPct: cost });
    updateUI();
    showChallenge();
  }, S.playableLatencyMs);
}

/* ============================================================
   CHALLENGE + RESULT
   ============================================================ */
function showChallenge(){
  if (S.isOffline) return;

  const ch = CHALLENGES[challengeIdx % CHALLENGES.length];
  selectedChoiceIdx = null;
  S.metrics.challenges += 1;
  logEvent('CHALLENGE_OPEN', { id: ch.id });

  document.getElementById('c-qid').textContent = '◈ ' + ch.id + ' · ' + ch.instrument;

  const diffEl = document.getElementById('c-diff');
  diffEl.textContent = ch.difficulty;
  diffEl.className = 'difficulty-badge ' + (ch.difficulty === 'CRITICAL' ? 'diff-critical' :
                                           ch.difficulty === 'PRECISION' ? 'diff-precision' : 'diff-discovery');

  document.getElementById('c-title').textContent = ch.title;
  document.getElementById('c-sub').textContent = ch.sub;
  document.getElementById('q-text').textContent = ch.question;

  document.getElementById('explanation-box').style.display = 'none';
  document.getElementById('exp-text').textContent = '';

  const div = document.getElementById('choices-div');
  div.innerHTML = '';
  ch.choices.forEach((c, i) => {
    const btn = document.createElement('button');
    btn.className = 'c-btn';
    btn.textContent = c.text;
    btn.onclick = () => selectChoice(i);
    div.appendChild(btn);
  });

  const sb = document.getElementById('submit-btn');
  sb.style.display = 'none';
  sb.textContent = 'TRANSMIT ANALYSIS';
  sb.onclick = submitAnswer;

  document.getElementById('challenge-modal').classList.add('open');
}

function selectChoice(idx){
  selectedChoiceIdx = idx;
  document.querySelectorAll('.c-btn').forEach((b,i)=>b.classList.toggle('selected', i===idx));
  document.getElementById('submit-btn').style.display = 'block';
}

function submitAnswer(){
  if (S.isOffline) return;
  if (selectedChoiceIdx === null) return;

  const ch = CHALLENGES[challengeIdx % CHALLENGES.length];
  const correct = ch.choices[selectedChoiceIdx].correct;

  document.querySelectorAll('.c-btn').forEach((b,i)=>{
    b.onclick = null;
    if (ch.choices[i].correct) b.classList.add('correct');
    else if (i === selectedChoiceIdx && !correct) b.classList.add('wrong');
  });

  document.getElementById('exp-text').textContent = ch.explanation || '';
  document.getElementById('explanation-box').style.display = 'block';

  logEvent('CHALLENGE_SUBMIT', { id: ch.id, selectedIdx: selectedChoiceIdx, correct });

  const sb = document.getElementById('submit-btn');
  sb.textContent = correct ? 'CONFIRMED · CONTINUE MISSION' : 'ACKNOWLEDGED · CONTINUE';
  sb.style.display = 'block';
  sb.onclick = () => {
    document.getElementById('challenge-modal').classList.remove('open');
    applyResult(correct);
  };
}

function applyResult(correct){
  if (S.isOffline) return;

  let energyDelta, valDelta, latDelta;

  if (correct) {
    S.validation += 10;
    S.metrics.correct += 1;
    energyDelta = +8;
    valDelta = '+10 pts';
    latDelta = '—';
    logToast('VALIDATION SUCCESS · DATA PACKET LOGGED');
    challengeIdx++;
    S.energy = Math.min(100, S.energy + 8);
  } else {
    S.energy -= 5;
    S.metrics.wrong += 1;
    S.metrics.energyPenaltyWrong += 5;
    S.simLatencySeconds += 120;
    S.metrics.latencyPenaltySeconds += 120;
    S.playableLatencyMs += 300;
    energyDelta = -5;
    valDelta = '0 pts';
    latDelta = '+120s';
    logToast('ERROR: DATA INCONCLUSIVE · PENALTY APPLIED');
  }

  const _ch = CHALLENGES[(correct ? challengeIdx - 1 : challengeIdx) % CHALLENGES.length];
  document.getElementById('r-tag').textContent = correct ? '◈ LOGGED · ' + _ch.id : '✕ REJECTED · ' + _ch.id;
  document.getElementById('r-title').textContent = correct ? 'Sample Integrity Confirmed' : 'Analysis Inconclusive';
  document.getElementById('r-sub').textContent = _ch.instrument + ' · ' + (correct
    ? 'Data validated. Survey region unlocked.'
    : 'Incorrect interpretation. Energy & latency penalty applied.');

  const rE = document.getElementById('r-energy');
  rE.textContent = (energyDelta >= 0 ? '+' : '') + energyDelta + '%';
  rE.className = 'r-stat-val' + (energyDelta < 0 ? ' neg' : '');

  const rV = document.getElementById('r-val');
  rV.textContent = valDelta;
  rV.className = 'r-stat-val' + (valDelta === '0 pts' ? ' amber' : '');

  const rL = document.getElementById('r-lat');
  rL.textContent = latDelta;
  rL.className = 'r-stat-val' + (latDelta !== '—' ? ' neg' : '');

  document.getElementById('result-modal').classList.add('open');
  updateUI();
}

function closeResult(){ document.getElementById('result-modal').classList.remove('open'); }

/* ============================================================
   BOOT SEQUENCE
   ============================================================ */
const BOOT_LINES = [
  { text:'DSN Relay Node 7 …', key:null, val:'CONNECTING', cls:'' },
  { text:'Signal established.', key:null, val:'OK', cls:'bl-ok' },
  { text:'Rover ID:', key:'HEX-01', val:null, cls:'' },
  { text:'Mission:', key:'Geological Survey · Quadrant A3', val:null, cls:'' },
  { text:'Solar charge:', key:'84%', val:null, cls:'' },
  { text:'Scan protocol:', key: REQUIRE_NODE_FOR_SCAN ? 'NODE-LOCKED' : 'OPEN', val:null, cls:'' },
  { text:'All systems nominal.', key:null, val:'READY', cls:'bl-ok' }
];

(function runBoot(){
  const log = document.getElementById('boot-log');
  const fill = document.getElementById('boot-progress-fill');
  const cta = document.getElementById('boot-cta');

  BOOT_LINES.forEach((line,i)=>{
    setTimeout(()=>{
      const el = document.createElement('div');
      el.className = 'boot-line';
      let html = `<span>${line.text}</span>`;
      if (line.key) html += ` <span class="bl-key">${line.key}</span>`;
      if (line.val) html += ` <span class="${line.cls || 'bl-val'}">${line.val}</span>`;
      el.innerHTML = html;
      log.appendChild(el);
      fill.style.width = ((i+1)/BOOT_LINES.length*100) + '%';
    }, 320*(i+1));
  });

  setTimeout(()=>cta.classList.add('visible'), 320*(BOOT_LINES.length+1)+200);
})();
</script>
</body>
</html>
