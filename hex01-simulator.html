<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>HEX-01 · Mars Geological Survey</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>

/* ============================================================
   DESIGN TOKENS
   ============================================================ */
:root {
  --bg:        #03050a;
  --surface:   #070d14;
  --panel:     #080e17;
  --border:    #12202e;
  --border-hi: #1e3348;
  --text:      #9ab4cc;
  --text-dim:  #334d63;
  --text-hi:   #c8dcea;
  --accent:    #00c8ff;
  --accent-dk: #004e66;
  --amber:     #ffaa00;
  --amber-dk:  #5a3a00;
  --red:       #ff3a3a;
  --red-dk:    #5a0a0a;
  --green:     #00e87a;
  --mono:      'Share Tech Mono', monospace;
  --display:   'Orbitron', sans-serif;
  --r:         2px;
}

/* ============================================================
   RESET
   ============================================================ */
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0; padding: 0;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-size: 11px;
}

/* ============================================================
   FULL-SCREEN SCANLINE + NOISE OVERLAYS
   ============================================================ */
#overlay-scanlines {
  position: fixed; inset: 0; z-index: 999; pointer-events: none;
  background: repeating-linear-gradient(
    0deg,
    rgba(0,0,0,0.13) 0px,
    rgba(0,0,0,0.13) 1px,
    transparent 1px,
    transparent 3px
  );
}
#overlay-vignette {
  position: fixed; inset: 0; z-index: 998; pointer-events: none;
  background: radial-gradient(ellipse at 50% 50%, transparent 40%, rgba(0,0,0,0.72) 100%);
}
#overlay-grain {
  position: fixed; inset: 0; z-index: 997; pointer-events: none;
  opacity: 0.035;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 120px 120px;
}

/* ============================================================
   SCREENS
   ============================================================ */
.screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  opacity: 0; pointer-events: none;
  transition: opacity 0.5s ease;
}
.screen.active {
  opacity: 1; pointer-events: all;
}

/* ============================================================
   BOOT SCREEN
   ============================================================ */
#boot-screen {
  justify-content: center;
  align-items: flex-start;
  padding: 0 8% 0 10%;
  background: var(--bg);
}

.boot-header {
  font-family: var(--display);
  font-size: 10px;
  letter-spacing: 6px;
  color: var(--text-dim);
  margin-bottom: 44px;
  text-transform: uppercase;
}

.boot-log {
  display: flex;
  flex-direction: column;
  gap: 0;
  margin-bottom: 40px;
  min-height: 180px;
}

.boot-line {
  font-size: 12px;
  line-height: 2.4;
  color: var(--text-dim);
  opacity: 0;
  animation: lineFadeIn 0.08s forwards;
  display: flex;
  gap: 12px;
  align-items: baseline;
}
.boot-line .bl-key   { color: var(--text); }
.boot-line .bl-val   { color: var(--accent); }
.boot-line .bl-ok    { color: var(--green); font-size: 9px; }
.boot-line .bl-warn  { color: var(--amber); }

@keyframes lineFadeIn { to { opacity: 1; } }

.boot-progress {
  width: 220px;
  height: 2px;
  background: var(--border);
  margin-bottom: 36px;
  overflow: hidden;
}
.boot-progress-fill {
  height: 100%;
  background: var(--accent);
  width: 0%;
  transition: width 0.3s ease;
}

.boot-cta {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  background: none;
  border: 1px solid var(--accent);
  color: var(--accent);
  font-family: var(--mono);
  font-size: 12px;
  letter-spacing: 3px;
  padding: 13px 28px;
  cursor: pointer;
  text-transform: uppercase;
  position: relative;
  overflow: hidden;
  opacity: 0;
  transition: opacity 0.4s, color 0.2s, background 0.2s;
}
.boot-cta.visible { opacity: 1; }
.boot-cta::after {
  content: '';
  position: absolute; inset: 0;
  background: var(--accent);
  opacity: 0;
  transition: opacity 0.2s;
}
.boot-cta:hover::after { opacity: 0.08; }
.boot-cta:active { background: var(--accent); color: var(--bg); }

.boot-cta-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--accent);
  animation: dotPulse 1.2s ease-in-out infinite;
}
@keyframes dotPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.3;transform:scale(0.7)} }

/* ============================================================
   SIM SCREEN LAYOUT
   ============================================================ */
#sim-screen {
  background: var(--bg);
}

/* TOP BAR --------------------------------------------------- */
.top-bar {
  height: 46px;
  flex-shrink: 0;
  display: flex;
  align-items: stretch;
  border-bottom: 1px solid var(--border);
  background: var(--surface);
  z-index: 10;
}

.tb-cell {
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 0 11px;
  border-right: 1px solid var(--border);
  gap: 3px;
  min-width: 0;
}
.tb-cell:last-child { border-right: none; margin-left: auto; }

.tb-label {
  font-size: 7px;
  letter-spacing: 2.5px;
  color: var(--text-dim);
  text-transform: uppercase;
}
.tb-value {
  font-size: 11px;
  color: var(--text-hi);
  white-space: nowrap;
}

/* Energy bar */
.eb-row { display: flex; align-items: center; gap: 7px; }
.eb-track {
  width: 68px; height: 4px;
  background: var(--border);
  position: relative;
  overflow: hidden;
}
.eb-fill {
  height: 100%;
  background: var(--accent);
  transition: width 0.4s, background 0.4s;
}
.eb-pct {
  font-size: 11px;
  color: var(--text-hi);
  min-width: 30px;
}

/* Signal dot */
.sig-dot {
  display: inline-block;
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--accent);
  margin-right: 5px;
  animation: sigPulse 2.4s ease-in-out infinite;
}
@keyframes sigPulse { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* Storm badge */
.storm-badge {
  display: none;
  align-items: center;
  gap: 6px;
  font-size: 9px;
  letter-spacing: 2px;
  color: var(--amber);
  border: 1px solid var(--amber-dk);
  padding: 2px 8px;
  margin: auto 10px;
  animation: stormFlash 0.9s step-end infinite;
}
.storm-badge.visible { display: flex; }
@keyframes stormFlash { 0%,100%{opacity:1} 50%{opacity:0.4} }

/* VIEWPORT -------------------------------------------------- */
.viewport {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: #030609;
  min-height: 0;
}

canvas#terrain-canvas {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
}

/* Terrain data overlay */
.terrain-overlay {
  position: absolute;
  top: 12px; left: 12px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.to-name {
  font-size: 11px;
  letter-spacing: 1.5px;
  color: var(--text-hi);
}
.to-row {
  font-size: 9px;
  color: var(--text-dim);
  display: flex;
  gap: 6px;
}
.to-row span { color: var(--amber); }

/* Node proximity pill */
.node-pill {
  position: absolute;
  top: 12px;
  left: 50%; transform: translateX(-50%);
  font-size: 9px;
  letter-spacing: 2.5px;
  color: var(--accent);
  border: 1px solid var(--accent-dk);
  background: rgba(0,20,30,0.85);
  padding: 5px 14px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.35s;
  pointer-events: none;
}
.node-pill.visible { opacity: 1; }

/* Latency transmit banner */
.lat-banner {
  position: absolute;
  bottom: 12px; left: 50%; transform: translateX(-50%);
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--accent);
  background: rgba(3,5,10,0.9);
  border: 1px solid var(--border-hi);
  padding: 5px 16px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
}
.lat-banner.visible { opacity: 1; }

/* Toast log */
.toast-log {
  position: absolute;
  bottom: 12px; left: 12px;
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 1px;
  max-width: 60%;
}

/* Validation counter */
.val-chip {
  position: absolute;
  bottom: 12px; right: 12px;
  font-size: 9px;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}
.val-chip span { color: var(--green); }

/* Dust storm veil */
.storm-veil {
  position: absolute; inset: 0;
  background: rgba(100,50,0,0.0);
  pointer-events: none;
  transition: background 1.5s;
}
.storm-veil.active { background: rgba(100,50,0,0.12); }

/* Heartbeat veil */
.hb-veil {
  position: absolute; inset: 0;
  pointer-events: none;
  box-shadow: inset 0 0 80px rgba(255,58,58,0);
  transition: box-shadow 0.5s;
}
.hb-veil.pulse {
  animation: hbPulse 1.3s ease-in-out infinite;
}
@keyframes hbPulse {
  0%,100% { box-shadow: inset 0 0 80px rgba(255,58,58,0); }
  50%      { box-shadow: inset 0 0 80px rgba(255,58,58,0.18); }
}

/* Solar glow */
.solar-glow {
  position: fixed; inset: 0; pointer-events: none; z-index: 50;
  box-shadow: inset 0 0 80px rgba(255,170,0,0);
  transition: box-shadow 2s;
}
.solar-glow.active {
  box-shadow: inset 0 0 80px rgba(255,170,0,0.07);
}

/* Rover mast SVG */
.rover-wrap {
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 130px;
  animation: mastSway 3.5s ease-in-out infinite;
}
@keyframes mastSway {
  0%,100% { transform: translateX(-50%) rotate(-0.25deg); }
  50%      { transform: translateX(-50%) rotate(0.25deg); }
}

/* CONTROLS AREA --------------------------------------------- */
.controls-wrap {
  height: 38%;
  flex-shrink: 0;
  display: flex;
  border-top: 1px solid var(--border);
  min-height: 155px;
  max-height: 220px;
}

/* CAM FEED PANEL */
.cam-panel {
  width: 50%;
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 10px;
  gap: 7px;
}
.panel-label {
  font-size: 7px;
  letter-spacing: 2.5px;
  color: var(--text-dim);
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 5px;
}

.cam-screen {
  flex: 1;
  background: #020408;
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0;
}
/* crosshair */
.cam-screen::before,
.cam-screen::after {
  content: '';
  position: absolute;
  background: rgba(0,200,255,0.12);
  pointer-events: none;
}
.cam-screen::before { width: 1px; height: 100%; left: 50%; }
.cam-screen::after  { height: 1px; width: 100%;  top: 50%; }

.cam-data {
  font-size: 8px;
  color: rgba(0,200,255,0.35);
  line-height: 1.9;
  text-align: center;
  z-index: 1;
}

.scan-sweep {
  position: absolute; inset: 0;
  background: linear-gradient(to bottom, transparent, rgba(0,200,255,0.07) 50%, transparent);
  transform: translateY(-100%);
  opacity: 0;
  pointer-events: none;
}
.scan-sweep.active {
  opacity: 1;
  animation: sweepDown 1.6s linear infinite;
}
@keyframes sweepDown {
  from { transform: translateY(-100%); }
  to   { transform: translateY(100%); }
}

/* Sys status rows */
.sys-rows {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.sys-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 8.5px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 2px;
}
.sys-key { color: var(--text-dim); }
.sys-val { color: var(--text-hi); }
.sys-val.warn { color: var(--amber); }
.sys-val.ok   { color: var(--green); }
.sys-val.bad  { color: var(--red); }

/* SCAN BUTTON */
.scan-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: none;
  border: 1px solid var(--border-hi);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  padding: 8px;
  text-transform: uppercase;
  cursor: not-allowed;
  transition: all 0.2s;
}
.scan-btn.ready {
  border-color: var(--accent);
  color: var(--accent);
  cursor: pointer;
  animation: scanReady 1.8s ease-in-out infinite;
}
.scan-btn.ready:active { background: rgba(0,200,255,0.1); }
@keyframes scanReady {
  0%,100%{ box-shadow: 0 0 0 rgba(0,200,255,0); }
  50%    { box-shadow: 0 0 12px rgba(0,200,255,0.2); }
}

/* MOVE PAD PANEL */
.move-panel {
  width: 50%;
  background: var(--panel);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px;
  position: relative;
}
.move-panel-label {
  position: absolute;
  top: 10px; left: 10px;
  font-size: 7px;
  letter-spacing: 2.5px;
  color: var(--text-dim);
}

/* D-PAD */
.dpad-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.dpad-row {
  display: flex;
  gap: 4px;
}
.dir-btn {
  width: 44px; height: 38px;
  background: var(--surface);
  border: 1px solid var(--border-hi);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.12s;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}
.dir-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: var(--accent);
  opacity: 0;
  transition: opacity 0.12s;
}
.dir-btn:not(.ghost):hover { border-color: var(--text-dim); color: var(--text); }
.dir-btn:not(.ghost):active::after { opacity: 0.15; }
.dir-btn:not(.ghost):active { border-color: var(--accent); color: var(--accent); }
.dir-btn.ghost { background: transparent; border-color: transparent; cursor: default; pointer-events: none; }
.dir-btn.lit { border-color: var(--accent); color: var(--accent); }

/* Rover state badge inside move panel */
.rover-state-badge {
  font-size: 8px;
  letter-spacing: 2px;
  color: var(--text-dim);
  border: 1px solid var(--border);
  padding: 3px 10px;
}
.rover-state-badge.moving { color: var(--accent); border-color: var(--accent-dk); }
.rover-state-badge.scanning { color: var(--amber); border-color: var(--amber-dk); }


/* ============================================================
   MODAL SYSTEM
   ============================================================ */
.modal-bg {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.88);
  display: flex;
  align-items: flex-end;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s;
}
.modal-bg.open {
  opacity: 1; pointer-events: all;
}
.modal-card {
  width: 100%;
  background: var(--panel);
  border-top: 1px solid var(--border-hi);
  padding: 20px 16px 28px;
  max-height: 80vh;
  overflow-y: auto;
  transform: translateY(16px);
  transition: transform 0.3s;
}
.modal-bg.open .modal-card { transform: translateY(0); }

.modal-tag {
  font-size: 7px;
  letter-spacing: 3px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-bottom: 10px;
}
.modal-title {
  font-family: var(--display);
  font-size: 14px;
  font-weight: 400;
  letter-spacing: 1px;
  color: var(--text-hi);
  margin-bottom: 6px;
}
.modal-sub {
  font-size: 9px;
  color: var(--amber);
  margin-bottom: 16px;
  line-height: 1.8;
}
.modal-divider { height: 1px; background: var(--border); margin: 14px 0; }

.q-text {
  font-size: 12px;
  color: var(--text);
  line-height: 1.7;
  margin-bottom: 14px;
}

.choices { display: flex; flex-direction: column; gap: 7px; }
.c-btn {
  background: var(--surface);
  border: 1px solid var(--border-hi);
  color: var(--text-dim);
  font-family: var(--mono);
  font-size: 10px;
  padding: 11px 14px;
  text-align: left;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  line-height: 1.5;
}
.c-btn::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 2px;
  background: var(--accent);
  transform: scaleY(0);
  transition: transform 0.15s;
}
.c-btn:hover { border-color: var(--border-hi); color: var(--text); }
.c-btn:hover::before { transform: scaleY(0.4); }
.c-btn.selected { border-color: var(--accent); color: var(--accent); }
.c-btn.selected::before { transform: scaleY(1); }
.c-btn.correct { border-color: var(--green); color: var(--green); background: rgba(0,232,122,0.04); }
.c-btn.wrong   { border-color: var(--red);   color: var(--red);   background: rgba(255,58,58,0.04); }

.submit-btn {
  margin-top: 14px;
  width: 100%;
  background: none;
  border: 1px solid var(--accent);
  color: var(--accent);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  padding: 13px;
  cursor: pointer;
  text-transform: uppercase;
  transition: background 0.2s;
  display: none;
}
.submit-btn:hover { background: rgba(0,200,255,0.06); }
.submit-btn:active { background: rgba(0,200,255,0.15); }

/* RESULT MODAL */
.result-stats {
  display: flex;
  gap: 8px;
  margin: 14px 0;
}
.r-stat {
  flex: 1;
  border: 1px solid var(--border);
  padding: 10px 6px;
  text-align: center;
}
.r-stat-val {
  display: block;
  font-size: 16px;
  color: var(--accent);
  margin-bottom: 3px;
  font-family: var(--display);
  font-weight: 400;
}
.r-stat-val.neg { color: var(--red); }
.r-stat-val.amber { color: var(--amber); }
.r-stat-label {
  font-size: 7px;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}

.continue-btn {
  margin-top: 12px;
  width: 100%;
  background: none;
  border: 1px solid var(--border-hi);
  color: var(--text);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  padding: 13px;
  cursor: pointer;
  transition: background 0.2s;
}
.continue-btn:hover { background: rgba(255,255,255,0.03); }

/* FAIL MODAL */
#fail-modal .modal-card { border-top-color: var(--red); }
.fail-title {
  font-family: var(--display);
  font-size: 18px;
  font-weight: 700;
  color: var(--red);
  letter-spacing: 3px;
  text-align: center;
  margin: 10px 0 6px;
  animation: failFlicker 0.15s step-end infinite;
}
@keyframes failFlicker { 0%,100%{opacity:1} 50%{opacity:0.8} }
.fail-sub {
  text-align: center;
  font-size: 9px;
  color: var(--text-dim);
  letter-spacing: 1.5px;
  margin-bottom: 20px;
}
.fail-btn {
  width: 100%;
  background: none;
  border: 1px solid var(--red);
  color: var(--red);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 3px;
  padding: 13px;
  cursor: pointer;
  transition: background 0.2s;
}
.fail-btn:hover { background: rgba(255,58,58,0.08); }


/* ── DIFFICULTY BADGES + EXPLANATION BOX ──────────────── */
.modal-top-row {
  display: flex; align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}
.difficulty-badge {
  font-size: 7px; letter-spacing: 2px;
  padding: 3px 8px; flex-shrink: 0;
  border: 1px solid var(--border-hi);
  color: var(--text-dim); text-transform: uppercase;
}
.diff-critical    { border-color: #5a0a0a; color: var(--red); }
.diff-precision   { border-color: var(--accent-dk); color: var(--accent); }
.diff-discovery   { border-color: #1a3a10; color: var(--green); }
.diff-engineering { border-color: var(--amber-dk); color: var(--amber); }
.diff-calibration { border-color: var(--accent-dk); color: var(--accent); }
.diff-telemetry   { border-color: #203020; color: #80c860; }
.diff-mobility    { border-color: var(--amber-dk); color: var(--amber); }
.diff-methodology { border-color: var(--accent-dk); color: var(--accent); }
.diff-navigation  { border-color: #1a3a10; color: var(--green); }
.explanation-box {
  margin-top: 12px;
  border: 1px solid var(--border-hi);
  background: rgba(0,200,255,0.025);
  padding: 10px 12px;
}
.exp-label {
  font-size: 7px; letter-spacing: 2.5px;
  color: var(--accent); margin-bottom: 6px;
}
.exp-text {
  font-size: 10px; color: var(--text); line-height: 1.8;
}
/* ============================================================
   UTILITY
   ============================================================ */
.hidden { display: none !important; }

</style>
</head>
<body>

<!-- ── ATMOSPHERE LAYERS ───────────────────────────── -->
<div id="overlay-scanlines"></div>
<div id="overlay-vignette"></div>
<div id="overlay-grain"></div>
<div class="solar-glow" id="solar-glow"></div>

<!-- ============================================================
     BOOT SCREEN
     ============================================================ -->
<div class="screen active" id="boot-screen">
  <div class="boot-header">ISRO · DSN RELAY · HEX-01</div>

  <div class="boot-log" id="boot-log"></div>

  <div class="boot-progress">
    <div class="boot-progress-fill" id="boot-progress-fill"></div>
  </div>

  <button class="boot-cta" id="boot-cta" onclick="initiateControl()">
    <span class="boot-cta-dot"></span>
    INITIATE CONTROL
  </button>
</div>

<!-- ============================================================
     SIM SCREEN
     ============================================================ -->
<div class="screen" id="sim-screen">

  <!-- TOP BAR -->
  <div class="top-bar">
    <!-- Energy -->
    <div class="tb-cell">
      <div class="tb-label">Energy Reserve</div>
      <div class="eb-row">
        <div class="eb-track"><div class="eb-fill" id="eb-fill" style="width:84%"></div></div>
        <span class="eb-pct" id="energy-text">84%</span>
      </div>
    </div>

    <!-- Latency -->
    <div class="tb-cell">
      <div class="tb-label">Signal Latency</div>
      <div class="tb-value" id="latency-text"><span class="sig-dot"></span>12m 30s</div>
    </div>

    <!-- Sol -->
    <div class="tb-cell">
      <div class="tb-label">Sol / State</div>
      <div class="tb-value" id="sol-text">SOL 127</div>
    </div>

    <!-- Storm badge (shows when storm active) -->
    <div class="storm-badge" id="storm-badge">
      <span>⚡</span> DUST STORM
    </div>

    <!-- Validation -->
    <div class="tb-cell">
      <div class="tb-label">Validation</div>
      <div class="tb-value" id="val-text" style="color:var(--green)">0 pts</div>
    </div>
  </div>

  <!-- VIEWPORT -->
  <div class="viewport" id="viewport">
    <canvas id="terrain-canvas"></canvas>

    <!-- Rover mast -->
    <div class="rover-wrap">
      <svg viewBox="0 0 130 210" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- mast -->
        <rect x="59" y="65" width="12" height="130" fill="#0e1e2c"/>
        <rect x="61" y="65" width="8" height="130" fill="#0f2030"/>
        <rect x="59" y="85"  width="12" height="2" fill="#162838"/>
        <rect x="59" y="110" width="12" height="2" fill="#162838"/>
        <rect x="59" y="135" width="12" height="2" fill="#162838"/>
        <rect x="59" y="160" width="12" height="2" fill="#162838"/>
        <!-- camera head -->
        <rect x="36" y="48" width="58" height="30" rx="3" fill="#0d1c2a"/>
        <rect x="38" y="50" width="54" height="26" rx="2" fill="#091422"/>
        <!-- left lens -->
        <circle cx="52" cy="63" r="9"  fill="#070f1a"/>
        <circle cx="52" cy="63" r="7"  fill="#080e16"/>
        <circle cx="52" cy="63" r="4.5" fill="#040a10"/>
        <circle cx="50" cy="61" r="1.5" fill="#1a3050" opacity="0.7"/>
        <!-- right lens -->
        <circle cx="78" cy="63" r="9"  fill="#070f1a"/>
        <circle cx="78" cy="63" r="7"  fill="#080e16"/>
        <circle cx="78" cy="63" r="4.5" fill="#040a10"/>
        <circle cx="76" cy="61" r="1.5" fill="#1a3050" opacity="0.7"/>
        <!-- antenna -->
        <line x1="65" y1="48" x2="65" y2="26" stroke="#162838" stroke-width="1.5"/>
        <circle cx="65" cy="24" r="3.5" fill="#0d1c2a" stroke="#00c8ff" stroke-width="0.6" opacity="0.6"/>
        <!-- side arm -->
        <rect x="94" y="53" width="22" height="4" rx="1" fill="#0e1e2c"/>
        <circle cx="117" cy="55" r="4.5" fill="#0d1c2a" stroke="#162838" stroke-width="1"/>
        <!-- status LED -->
        <circle cx="90" cy="55" r="2.2" fill="#00c8ff" opacity="0.5" id="status-led"/>
      </svg>
    </div>

    <!-- Terrain data -->
    <div class="terrain-overlay">
      <div class="to-name" id="to-name">BASALTIC FLATS</div>
      <div class="to-row">CMPLX <span id="to-cmplx">2.1</span></div>
      <div class="to-row">SLIP  <span id="to-slip">2%</span></div>
    </div>

    <!-- Node pill -->
    <div class="node-pill" id="node-pill">◈ GEO-NODE IN PROXIMITY</div>

    <!-- Latency banner -->
    <div class="lat-banner" id="lat-banner">TRANSMITTING COMMAND…</div>

    <!-- Toast -->
    <div class="toast-log" id="toast-log">SYS: AWAITING COMMAND</div>

    <!-- Validation chip -->
    <div class="val-chip">TILES <span id="val-chip-val">0</span></div>

    <!-- Storm veil -->
    <div class="storm-veil" id="storm-veil"></div>

    <!-- Heartbeat veil -->
    <div class="hb-veil" id="hb-veil"></div>
  </div>

  <!-- CONTROLS -->
  <div class="controls-wrap">

    <!-- CAM FEED -->
    <div class="cam-panel">
      <div class="panel-label"><span class="sig-dot" style="width:4px;height:4px"></span>NAVCAM_L · FEED</div>

      <div class="cam-screen">
        <div class="cam-data" id="cam-data">FOCAL 50mm<br>ISO 800<br>EXP 1/250</div>
        <div class="scan-sweep" id="scan-sweep"></div>
      </div>

      <div class="sys-rows" id="sys-rows">
        <div class="sys-row"><span class="sys-key">ROVER</span><span class="sys-val ok" id="sr-state">IDLE</span></div>
        <div class="sys-row"><span class="sys-key">TEMP</span> <span class="sys-val" id="sr-temp">-54.2°C</span></div>
        <div class="sys-row"><span class="sys-key">SOLAR</span><span class="sys-val ok" id="sr-solar">OPTIMAL</span></div>
      </div>

      <button class="scan-btn" id="scan-btn" onclick="startScan()">
        ◈ INITIATE APXS SCAN
      </button>
    </div>

    <!-- MOVE PAD -->
    <div class="move-panel">
      <div class="move-panel-label">MOVE CONTROL · 8-DIR</div>

      <div class="dpad-wrap">
        <div class="dpad-row">
          <button class="dir-btn" id="d-NW" onclick="move('NW')">NW</button>
          <button class="dir-btn" id="d-N"  onclick="move('N')"> N </button>
          <button class="dir-btn" id="d-NE" onclick="move('NE')">NE</button>
        </div>
        <div class="dpad-row">
          <button class="dir-btn" id="d-W"  onclick="move('W')"> W </button>
          <button class="dir-btn" id="d-scan" onclick="startScan()" style="font-size:7px;letter-spacing:1px;color:var(--text-dim)">SCN</button>
          <button class="dir-btn" id="d-E"  onclick="move('E')"> E </button>
        </div>
        <div class="dpad-row">
          <button class="dir-btn" id="d-SW" onclick="move('SW')">SW</button>
          <button class="dir-btn" id="d-S"  onclick="move('S')"> S </button>
          <button class="dir-btn" id="d-SE" onclick="move('SE')">SE</button>
        </div>
      </div>

      <div class="rover-state-badge" id="rsb">IDLE</div>
    </div>

  </div>
</div>

<!-- ============================================================
     CHALLENGE MODAL
     ============================================================ -->
<div class="modal-bg" id="challenge-modal">
  <div class="modal-card">
    <div class="modal-top-row">
      <div class="modal-tag" id="c-qid">◈ Q_001 · APXS · MSL</div>
      <div class="difficulty-badge" id="c-diff">CRITICAL</div>
    </div>
    <div class="modal-title" id="c-title">Surface Spectral Analysis</div>
    <div class="modal-sub" id="c-sub">Spectrometer data indicates high Fe₂O₃ concentration.</div>
    <div class="modal-divider"></div>
    <div class="q-text" id="q-text">Select analysis hypothesis:</div>
    <div class="choices" id="choices-div"></div>
    <div class="explanation-box" id="explanation-box" style="display:none">
      <div class="exp-label">◈ SCIENTIFIC BASIS</div>
      <div class="exp-text" id="exp-text"></div>
    </div>
    <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">TRANSMIT ANALYSIS</button>
  </div>
</div>

<!-- ============================================================
     RESULT MODAL
     ============================================================ -->
<div class="modal-bg" id="result-modal">
  <div class="modal-card">
    <div class="modal-tag" id="r-tag">◈ TRANSMISSION LOGGED</div>
    <div class="modal-title" id="r-title">Analysis Confirmed</div>
    <div class="modal-sub" id="r-sub"></div>
    <div class="result-stats">
      <div class="r-stat">
        <span class="r-stat-val" id="r-energy">+8%</span>
        <div class="r-stat-label">ENERGY DELTA</div>
      </div>
      <div class="r-stat">
        <span class="r-stat-val" id="r-val">+10pts</span>
        <div class="r-stat-label">VALIDATION</div>
      </div>
      <div class="r-stat">
        <span class="r-stat-val" id="r-lat">—</span>
        <div class="r-stat-label">LATENCY DELTA</div>
      </div>
    </div>
    <button class="continue-btn" onclick="closeResult()">CONTINUE MISSION</button>
  </div>
</div>

<!-- ============================================================
     ENERGY FAIL MODAL
     ============================================================ -->
<div class="modal-bg" id="fail-modal">
  <div class="modal-card">
    <div class="modal-tag">✕ CRITICAL SYSTEM ALERT</div>
    <div class="fail-title">ENERGY DEPLETED</div>
    <div class="fail-sub">ROVER HEX-01 OFFLINE · SOLAR RECOVERY REQUIRED</div>
    <button class="fail-btn" onclick="endSim()">END SIMULATION</button>
  </div>
</div>


<script>
/* ============================================================
   ENGINE — ALL ORIGINAL LOGIC PRESERVED VERBATIM
   ============================================================ */

const MISSION_CONFIG = {
  communications: {
    latency: { minMs: 240000, maxMs: 1440000, averageMs: 750000 },
    bandwidthKbps: { directToEarth: 0.5, orbiterRelay: 2000.0 }
  },
  powerSystems: {
    solar: { optimalGenerationWhPerSol: 900.0, dustStormMultiplier: 0.05, nightHeaterDrainWh: -150.0 }
  },
  locomotion: {
    maxSpeedCmPerSec: 4.16, maxSafeInclineDegrees: 30.0, baseEnergyDrainPerMove: 1.5
  },
  instruments: {
    apxs_spectrometer: { energyCostPct: 12.0, timeCostMinutes: 180.0 }
  }
};

const TERRAIN_DATABASE = [
  { id: "T_BASALTIC_FLATS",  name: "Basaltic Flats",  complexityIndex: 2.1, hazards: { slipProbability: 0.02, costMult: 1.0 } },
  { id: "T_REGOLITH_FIELD",  name: "Regolith Field",  complexityIndex: 4.5, hazards: { slipProbability: 0.15, costMult: 1.2 } },
  { id: "T_SCORIA_OUTCROP",  name: "Scoria Outcrop",  complexityIndex: 6.8, hazards: { slipProbability: 0.40, costMult: 1.8 } },
  { id: "T_SOFT_DUST_DRIFT", name: "Soft Dust Drift", complexityIndex: 8.5, hazards: { slipProbability: 0.85, costMult: 2.5 } }
];

const S = {
  energy: 84,
  validation: 0,
  roverState: 'IDLE',
  stormActive: false,
  currentTerrain: TERRAIN_DATABASE[0],
  playableLatencyMs: 1200,
  simLatencySeconds: MISSION_CONFIG.communications.latency.averageMs / 1000,
  nodeNearby: false
};

let loops = { ambient: null, solar: null, nodes: null };

/* ── MSL / CHANDRAYAAN-3 MISSION SCIENCE FLASHCARD DATABASE ─
   Source: Lead Mission Scientist · MSL + Chandrayaan-3 Reports
   ─────────────────────────────────────────────────────────── */
const CHALLENGES = [
  {
    id: "Q_001",
    instrument: "APXS · MSL",
    difficulty: "CRITICAL",
    title: "APXS Lockup Anomaly — Tactical Mitigation",
    sub: "Telemetry shows instrument generating artificial counts at lowest energy channel only.",
    question: "During a long-duration APXS integration on Curiosity, the instrument has stopped recording real X-ray events and is only generating artificial counts at the lowest detectable energy channel — the \"lockup\" anomaly. What is the required tactical mitigation?",
    choices: [
      { text: "A) Increase the integration time to 5 hours to override the internal software buffer.", correct: false },
      { text: "B) Initiate a power cycle and split subsequent long integrations into two shorter sessions.", correct: true },
      { text: "C) Deploy the robotic arm to the basaltic calibration slab to reset the Curium-244 flux.", correct: false },
    ],
    explanation: "Power cycling clears the lockup state. Splitting subsequent integrations into shorter sessions prevents recurrence of the buffer overflow condition."
  },
  {
    id: "Q_002",
    instrument: "NavCam · MSL RSM",
    difficulty: "PRECISION",
    title: "NavCam Stereo Baseline — RSM Geometric Engine",
    sub: "Stereo pair used for ChemCam target distance calculation.",
    question: "A NavCam stereo pair on the MSL Remote Sensing Mast (RSM) is being used to calculate the distance to a rock target for ChemCam targeting. What is the fixed stereo baseline distance used by the simulator's geometric engine for this calculation?",
    choices: [
      { text: "A) 20.0 cm", correct: false },
      { text: "B) 42.4 cm", correct: true },
      { text: "C) 1.97 m", correct: false },
    ],
    explanation: "The MSL RSM NavCam stereo baseline is 42.4 cm. This fixed separation between the two camera eyes enables triangulation for accurate distance estimation to surface targets."
  },
  {
    id: "Q_003",
    instrument: "APXS · MSL",
    difficulty: "DISCOVERY",
    title: "2024 APXS Contact Analysis — Surprise Detection",
    sub: "Analysis on rock fractured by rover wheels. Spectra show never-before-seen element.",
    question: "In 2024, Curiosity's APXS performed a contact analysis on a rock recently fractured by the rover's wheels. The resulting spectra revealed a \"surprise discovery\" never before seen in pure form on Mars. What was the element detected?",
    choices: [
      { text: "A) Pure Magnesium", correct: false },
      { text: "B) Pure Sulfur crystals", correct: true },
      { text: "C) Pure Hematite", correct: false },
    ],
    explanation: "The fractured rock exposed pure sulfur crystals — the first time elemental sulfur had been detected in pure form on Mars. This was a significant discovery with implications for Mars geochemical history."
  },
  {
    id: "Q_004",
    instrument: "NavCam · MSL",
    difficulty: "ENGINEERING",
    title: "NavCam Mounting Height — MSL Engineering Spec",
    sub: "Configuring boresight for high-resolution terrain context mosaic.",
    question: "You are configuring the NavCam boresight for a high-resolution terrain context mosaic. According to MSL engineering specifications, at what height is the upper primary NavCam pair mounted above the base of the rover wheels?",
    choices: [
      { text: "A) 1.10 m", correct: false },
      { text: "B) 1.99 m", correct: true },
      { text: "C) 0.85 m", correct: false },
    ],
    explanation: "The upper primary NavCam pair on MSL's Remote Sensing Mast is mounted at 1.99 m above the rover wheel base — providing the elevated perspective needed for terrain context mosaics."
  },
  {
    id: "Q_005",
    instrument: "APXS · Chandrayaan-3 / PRL",
    difficulty: "CALIBRATION",
    title: "Pragyan APXS — Primary Calibration Target Elements",
    sub: "Characteristic X-ray emission analysis on lunar regolith.",
    question: "The Pragyan rover (Chandrayaan-3) APXS, developed by the Physical Research Laboratory (PRL), uses \"characteristic X-rays\" to identify elements. Which specific group of elements is the instrument primarily calibrated to quantify in the lunar soil?",
    choices: [
      { text: "A) Noble gases including Neon and Argon", correct: false },
      { text: "B) Major and minor elements such as Si, Mg, Al, Fe, Ca, and Ti", correct: true },
      { text: "C) Heavy radioactive isotopes only", correct: false },
    ],
    explanation: "The Pragyan APXS (PRL) is calibrated for major rock-forming elements: Silicon, Magnesium, Aluminum, Iron, Calcium, and Titanium — the standard suite for planetary surface geochemistry."
  },
  {
    id: "Q_006",
    instrument: "APXS · MSL",
    difficulty: "TELEMETRY",
    title: "APXS Science Data Packet — Standard Size",
    sub: "Instrument prepares packet for retrieval by rover's main computer.",
    question: "At the conclusion of a successful APXS measurement cycle on the Martian surface, the instrument prepares a science data packet for retrieval by the rover's main computer. What is the standard size of this data packet?",
    choices: [
      { text: "A) 32 kilobytes", correct: true },
      { text: "B) 512 kilobytes", correct: false },
      { text: "C) 2 megabytes", correct: false },
    ],
    explanation: "The standard APXS science data packet is 32 kilobytes. This compact size is optimized for the limited uplink bandwidth available in direct-to-Earth communications mode (0.5 kbps)."
  },
  {
    id: "Q_007",
    instrument: "NavCam · Mobility",
    difficulty: "MOBILITY",
    title: "Rocker-Bogie Slip Monitoring — Instrument Objective",
    sub: "NavCam detects sudden increase in wheel sinkage.",
    question: "The \"rocker-bogie\" suspension system is visible in NavCam monitoring. If the NavCam detects a sudden increase in wheel sinkage, the operator must assess the \"slip\" risk. Which ISRO/NASA instrument objective specifically covers this monitoring?",
    choices: [
      { text: "A) Investigating landing sites at meter-scale resolution", correct: false },
      { text: "B) Mobility planning including wheel sinkage and obstruction analysis", correct: true },
      { text: "C) Atmospheric pressure monitoring for dust devil detection", correct: false },
    ],
    explanation: "NavCam mobility planning objectives specifically include wheel sinkage assessment and obstruction analysis — critical functions for safe rover traversal across soft regolith and rocky terrain."
  },
  {
    id: "Q_008",
    instrument: "APXS · Chandrayaan-3",
    difficulty: "CALIBRATION",
    title: "Pragyan APXS Calibration Plate — Target Materials",
    sub: "Four metallic targets mounted on rover for calibration check.",
    question: "To ensure data integrity, the Pragyan rover's APXS performs a calibration check against a plate mounted on the rover. This plate contains four specific metallic targets. Identify the correct materials:",
    choices: [
      { text: "A) Gold, Silver, Platinum, and Nickel", correct: false },
      { text: "B) Stainless Steel, Copper, Titanium, and Aluminum", correct: true },
      { text: "C) Iron, Lead, Zinc, and Magnesium", correct: false },
    ],
    explanation: "The Pragyan APXS calibration plate uses Stainless Steel, Copper, Titanium, and Aluminum — materials with well-characterized X-ray fluorescence spectra covering the instrument's detection range."
  },
  {
    id: "Q_009",
    instrument: "APXS · MSL Design",
    difficulty: "METHODOLOGY",
    title: "MSL APXS Dual Methodology — Analytical Techniques",
    sub: "Two integrated terrestrial methods in MSL APXS design.",
    question: "The APXS instrument utilizes a combination of two standard terrestrial methods to determine elemental chemistry. Which two methods are integrated into the MSL APXS design?",
    choices: [
      { text: "A) Laser-Induced Breakdown Spectroscopy (LIBS) and Mass Spectrometry", correct: false },
      { text: "B) Particle-Induced X-ray Emission (PIXE) and X-ray Fluorescence (XRF)", correct: true },
      { text: "C) Gamma Ray Spectroscopy and Neutron Activation Analysis", correct: false },
    ],
    explanation: "The MSL APXS integrates PIXE (using alpha particles from Curium-244 to excite characteristic X-rays) and XRF (using X-rays to excite fluorescence) — together covering elements from Na to Br."
  },
  {
    id: "Q_010",
    instrument: "NavCam · Chandrayaan-3",
    difficulty: "NAVIGATION",
    title: "Pragyan Dual NavCam — Primary Stereo Purpose",
    sub: "Two 1-megapixel cameras. Purpose of dual-camera configuration.",
    question: "Pragyan's NavCam system consists of two 1-megapixel cameras. What is the primary purpose of this specific dual-camera configuration for the ground control team on Earth?",
    choices: [
      { text: "A) To detect high-frequency radio interference from the Sun", correct: false },
      { text: "B) To generate 3D vision maps of the lunar surface for path planning", correct: true },
      { text: "C) To monitor the thermal degradation of the solar panels", correct: false },
    ],
    explanation: "The dual 1-MP NavCam configuration on Pragyan generates stereoscopic 3D terrain maps — enabling the ground control team to plan safe traversal paths across the lunar south pole region."
  }
];
let challengeIdx = 0;
let selectedChoiceIdx = null;

/* ── TERRAIN CANVAS ─────────────────────────────────────── */
let canvas, ctx;
let tx = 0, ty = 0; // terrain scroll offsets

function initCanvas() {
  canvas = document.getElementById('terrain-canvas');
  const vp = document.getElementById('viewport');
  canvas.width  = vp.offsetWidth;
  canvas.height = vp.offsetHeight;
  window.addEventListener('resize', () => {
    canvas.width  = vp.offsetWidth;
    canvas.height = vp.offsetHeight;
  });
  renderLoop();
}

function renderLoop() {
  drawTerrain();
  requestAnimationFrame(renderLoop);
}

function drawTerrain() {
  if (!ctx) { ctx = canvas.getContext('2d'); }
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  // Sky
  const sky = ctx.createLinearGradient(0, 0, 0, h * 0.48);
  sky.addColorStop(0, '#060204');
  sky.addColorStop(1, '#180a06');
  ctx.fillStyle = sky;
  ctx.fillRect(0, 0, w, h * 0.48);

  // Horizon glow
  const hg = ctx.createRadialGradient(w/2, h*0.46, 0, w/2, h*0.46, w*0.7);
  hg.addColorStop(0, 'rgba(160,60,10,0.1)');
  hg.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = hg;
  ctx.fillRect(0, 0, w, h);

  // Ground base
  const grd = ctx.createLinearGradient(0, h*0.46, 0, h);
  grd.addColorStop(0, '#1c0e07');
  grd.addColorStop(0.4, '#160b06');
  grd.addColorStop(1, '#0e0704');
  ctx.fillStyle = grd;
  ctx.fillRect(0, h*0.46, w, h*0.54);

  // Terrain ridge silhouette
  const ridge = ctx.createLinearGradient(0, h*0.43, 0, h*0.52);
  ridge.addColorStop(0, '#2a1508');
  ridge.addColorStop(1, '#160b05');
  ctx.fillStyle = ridge;
  ctx.beginPath();
  ctx.moveTo(0, h);
  const pts = 24;
  for (let i = 0; i <= pts; i++) {
    const xp = (i / pts) * w;
    const phase = xp / w * 6.28 + tx * 0.008;
    const yp = h * 0.47 - Math.sin(phase) * 9 - Math.cos(phase * 2.3) * 5;
    if (i === 0) ctx.moveTo(xp, yp); else ctx.lineTo(xp, yp);
  }
  ctx.lineTo(w, h); ctx.lineTo(0, h);
  ctx.closePath(); ctx.fill();

  // Rocks
  const rocks = [
    { bx: 0.08, by: 0.62, rw: 0.055, rh: 0.038, phase: 1.0 },
    { bx: 0.22, by: 0.59, rw: 0.038, rh: 0.028, phase: 2.1 },
    { bx: 0.41, by: 0.66, rw: 0.072, rh: 0.048, phase: 3.2 },
    { bx: 0.60, by: 0.61, rw: 0.030, rh: 0.022, phase: 0.7 },
    { bx: 0.74, by: 0.70, rw: 0.048, rh: 0.034, phase: 4.1 },
    { bx: 0.88, by: 0.58, rw: 0.080, rh: 0.052, phase: 5.2 },
    { bx: 0.30, by: 0.75, rw: 0.032, rh: 0.024, phase: 1.8 },
    { bx: 0.55, by: 0.72, rw: 0.025, rh: 0.018, phase: 2.9 },
  ];
  rocks.forEach(r => {
    const rx = ((r.bx * w + tx * 0.45 + r.phase * 80) % (w * 1.25)) - w * 0.12;
    const ry = r.by * h - ty * 0.1;
    ctx.save();
    ctx.shadowColor = 'rgba(0,0,0,0.6)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 5;
    ctx.fillStyle = '#1c0f07';
    ctx.beginPath();
    ctx.ellipse(rx, ry, r.rw * w, r.rh * h, 0.15, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = 'rgba(60,28,10,0.35)';
    ctx.beginPath();
    ctx.ellipse(rx - r.rw*w*0.25, ry - r.rh*h*0.3, r.rw*w*0.5, r.rh*h*0.45, 0.15, 0, Math.PI);
    ctx.fill();
    ctx.restore();
  });

  // Geological node indicator
  if (S.nodeNearby) {
    const nx = w * 0.5, ny = h * 0.52;
    const t = Date.now() / 1000;
    ctx.save();
    ctx.strokeStyle = `rgba(0,200,255,${0.3 + Math.sin(t*3)*0.2})`;
    ctx.lineWidth = 1;
    ctx.setLineDash([3, 6]);
    ctx.beginPath();
    ctx.arc(nx, ny, 14 + Math.sin(t*2)*3, 0, Math.PI*2);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = `rgba(0,200,255,${0.5 + Math.sin(t*3)*0.3})`;
    ctx.beginPath();
    ctx.arc(nx, ny, 3, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  // Fine grain
  ctx.save();
  ctx.globalAlpha = 0.025;
  ctx.fillStyle = '#c88040';
  for (let i = 0; i < 40; i++) {
    const gx = (Math.sin(i * 13.7 + tx * 0.01) * 0.5 + 0.5) * w;
    const gy = (Math.cos(i * 7.3 + ty * 0.01) * 0.3 + 0.65) * h;
    ctx.fillRect(gx, gy, 1, 1);
  }
  ctx.globalAlpha = 1;
  ctx.restore();

  // Scientific grid
  ctx.save();
  ctx.strokeStyle = 'rgba(0,200,255,0.018)';
  ctx.lineWidth = 0.5;
  for (let gx = 0; gx < w; gx += 44) { ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,h); ctx.stroke(); }
  for (let gy = 0; gy < h; gy += 44) { ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(w,gy); ctx.stroke(); }
  ctx.restore();
}

/* ── MOVE TERRAIN OFFSET on movement ───────────────────── */
const DIR_VECTORS = {
  N:[0,-1], NE:[1,-1], E:[1,0], SE:[1,1],
  S:[0,1], SW:[-1,1], W:[-1,0], NW:[-1,-1]
};

/* ============================================================
   CORE FUNCTIONS (original engine — untouched)
   ============================================================ */

function initiateControl() {
  document.getElementById('boot-screen').classList.remove('active');
  const ss = document.getElementById('sim-screen');
  ss.classList.add('active');
  initCanvas();
  updateUI();
  startLoops();
}

function endSim() {
  document.getElementById('fail-modal').classList.remove('open');
  document.getElementById('sim-screen').classList.remove('active');
  document.getElementById('boot-screen').classList.add('active');

  clearInterval(loops.ambient);
  clearInterval(loops.solar);
  clearInterval(loops.nodes);

  S.energy = 84;
  S.validation = 0;
  S.roverState = 'IDLE';
  S.stormActive = false;
  S.playableLatencyMs = 1200;
  S.simLatencySeconds = MISSION_CONFIG.communications.latency.averageMs / 1000;
  S.nodeNearby = false;
  S.currentTerrain = TERRAIN_DATABASE[0];
  challengeIdx = 0;
  selectedChoiceIdx = null;
  tx = 0; ty = 0;
}

function updateUI() {
  /* Energy */
  const pct = Math.max(0, Math.floor(S.energy));
  document.getElementById('eb-fill').style.width = pct + '%';
  document.getElementById('energy-text').textContent = pct + '%';
  const fill = document.getElementById('eb-fill');
  fill.style.background = pct < 15 ? 'var(--red)' : pct < 30 ? 'var(--amber)' : 'var(--accent)';

  /* Latency */
  const mins = Math.floor(S.simLatencySeconds / 60);
  const secs = Math.floor(S.simLatencySeconds % 60);
  document.getElementById('latency-text').innerHTML =
    `<span class="sig-dot"></span>${mins}m ${secs}s`;

  /* Validation */
  document.getElementById('val-text').textContent = S.validation + ' pts';
  document.getElementById('val-chip-val').textContent = S.validation;

  /* Terrain overlay */
  document.getElementById('to-name').textContent = S.currentTerrain.name.toUpperCase();
  document.getElementById('to-cmplx').textContent = S.currentTerrain.complexityIndex;
  document.getElementById('to-slip').textContent = (S.currentTerrain.hazards.slipProbability * 100).toFixed(0) + '%';

  /* Sys rows */
  const stateEl = document.getElementById('sr-state');
  stateEl.textContent = S.roverState;
  stateEl.className = 'sys-val ' +
    (S.roverState === 'IDLE' ? 'ok' : S.roverState === 'SCANNING' ? 'warn' : '');

  document.getElementById('sr-temp').textContent  = S.stormActive ? '-85.4°C' : '-54.2°C';
  const solarEl = document.getElementById('sr-solar');
  solarEl.textContent = S.stormActive ? 'COMPROMISED' : 'OPTIMAL';
  solarEl.className   = 'sys-val ' + (S.stormActive ? 'warn' : 'ok');

  /* Rover state badge */
  const rsb = document.getElementById('rsb');
  rsb.textContent = S.roverState;
  rsb.className = 'rover-state-badge ' +
    (S.roverState.includes('MOVING') ? 'moving' : S.roverState === 'SCANNING' ? 'scanning' : '');

  /* Scan button */
  const scanBtn = document.getElementById('scan-btn');
  const canScan = S.nodeNearby && S.roverState === 'IDLE';
  scanBtn.className = 'scan-btn' + (canScan ? ' ready' : '');
  // NOTE: never set scanBtn.disabled — it blocks onclick even with .ready
  // Guard is handled inside startScan() itself.
  const scnBtn = document.getElementById('d-scan');
  if (scnBtn) {
    scnBtn.style.borderColor = canScan ? 'var(--accent)' : '';
    scnBtn.style.color = canScan ? 'var(--accent)' : '';
    scnBtn.style.boxShadow = canScan ? '0 0 8px rgba(0,200,255,0.3)' : '';
  }

  /* Node pill */
  document.getElementById('node-pill').classList.toggle('visible', S.nodeNearby);

  /* Storm */
  document.getElementById('storm-badge').classList.toggle('visible', S.stormActive);
  document.getElementById('storm-veil').classList.toggle('active', S.stormActive);

  /* Heartbeat when energy critical */
  document.getElementById('hb-veil').classList.toggle('pulse', S.energy < 15);

  /* Fail modal */
  if (S.energy <= 0) {
    document.getElementById('fail-modal').classList.add('open');
  }
}

function logToast(msg) {
  document.getElementById('toast-log').textContent = 'SYS: ' + msg;
}

/* ── LOOPS ──────────────────────────────────────────────── */
function startLoops() {
  loops.solar = setInterval(() => {
    if (S.roverState === 'IDLE' && S.energy < 100) {
      const chargeBase = 0.5;
      const charge = S.stormActive
        ? chargeBase * MISSION_CONFIG.powerSystems.solar.dustStormMultiplier
        : chargeBase;
      S.energy = Math.min(100, S.energy + charge);
      // Solar glow pulse when charging
      if (!S.stormActive) {
        const sg = document.getElementById('solar-glow');
        sg.classList.add('active');
        setTimeout(() => sg.classList.remove('active'), 2500);
      }
      updateUI();
    }
  }, 2000);

  loops.nodes = setInterval(() => {
    if (S.roverState === 'MOVING' && Math.random() < 0.2 && !S.nodeNearby) {
      S.nodeNearby = true;
      logToast('GEO-NODE PROXIMITY ALERT — INITIATE SCAN');
      updateUI();
    }
  }, 4000);
}

/* ── MOVE ───────────────────────────────────────────────── */
function move(dir) {
  if (S.roverState !== 'IDLE' || S.energy <= 0) return;

  S.roverState = 'MOVING_QUEUED';
  logToast(`CMD [MOVE ${dir}] TRANSMITTING…`);

  /* Highlight active direction button briefly */
  const btn = document.getElementById('d-' + dir);
  if (btn) btn.classList.add('lit');

  /* Show latency banner */
  document.getElementById('lat-banner').classList.add('visible');
  updateUI();

  setTimeout(() => {
    if (btn) btn.classList.remove('lit');
    document.getElementById('lat-banner').classList.remove('visible');
    executeMove(dir);
  }, S.playableLatencyMs);
}

function executeMove(dir) {
  S.roverState = 'MOVING';
  S.currentTerrain = TERRAIN_DATABASE[Math.floor(Math.random() * TERRAIN_DATABASE.length)];

  const drain = MISSION_CONFIG.locomotion.baseEnergyDrainPerMove * S.currentTerrain.hazards.costMult;
  S.energy -= drain;

  /* Scroll terrain canvas */
  const v = DIR_VECTORS[dir] || [0,0];
  tx += v[0] * 18;
  ty += v[1] * 18;

  if (Math.random() < S.currentTerrain.hazards.slipProbability) {
    logToast('HAZARD: WHEEL SLIP — EXTRA POWER DRAWN');
    S.energy -= 2.5;
  } else {
    logToast(`MOVED ${dir} · TERRAIN: ${S.currentTerrain.name.toUpperCase()}`);
  }

  if (Math.random() < 0.05) triggerStorm();

  setTimeout(() => {
    S.roverState = 'IDLE';
    // nodeNearby intentionally NOT reset here — operator needs to stop and scan
    updateUI();
  }, 1000);

  updateUI();
}

/* ── STORM ──────────────────────────────────────────────── */
function triggerStorm() {
  S.stormActive = true;
  S.simLatencySeconds += 300;
  logToast('WARNING: DUST STORM DETECTED — SOLAR COMPROMISED');
  updateUI();

  setTimeout(() => {
    S.stormActive = false;
    S.simLatencySeconds -= 300;
    logToast('STORM CLEARED — NOMINAL OPERATIONS RESUMED');
    updateUI();
  }, 15000);
}

/* ── SCAN ───────────────────────────────────────────────── */
function startScan() {
  if (!S.nodeNearby || S.roverState !== 'IDLE') return;
  if (S.energy < MISSION_CONFIG.instruments.apxs_spectrometer.energyCostPct) {
    logToast('ERROR: INSUFFICIENT ENERGY FOR APXS SCAN');
    return;
  }

  S.roverState = 'SCANNING';
  logToast('APXS SCAN INITIATED — PROCESSING…');
  document.getElementById('cam-data').textContent = 'SCANNING…\nANALYSING…\nPROCESSING…';
  document.getElementById('scan-sweep').classList.add('active');
  updateUI();

  setTimeout(() => {
    S.energy -= MISSION_CONFIG.instruments.apxs_spectrometer.energyCostPct;
    document.getElementById('scan-sweep').classList.remove('active');
    document.getElementById('cam-data').innerHTML = 'FOCAL 50mm<br>ISO 800<br>EXP 1/250';
    S.roverState = 'IDLE';
    S.nodeNearby = false;
    updateUI();
    showChallenge();
  }, S.playableLatencyMs);
}

/* ── CHALLENGE MODAL ────────────────────────────────────── */
function showChallenge() {
  const ch = CHALLENGES[challengeIdx % CHALLENGES.length];
  selectedChoiceIdx = null;

  document.getElementById('c-qid').textContent = '◈ ' + ch.id + ' · ' + ch.instrument;
  const diffEl = document.getElementById('c-diff');
  diffEl.textContent = ch.difficulty;
  diffEl.className = 'difficulty-badge diff-' + ch.difficulty.toLowerCase().replace(/[ ]+/g,'-');

  document.getElementById('c-title').textContent = ch.title;
  document.getElementById('c-sub').textContent   = ch.sub;
  document.getElementById('q-text').textContent  = ch.question;

  document.getElementById('explanation-box').style.display = 'none';
  document.getElementById('exp-text').textContent = '';

  const div = document.getElementById('choices-div');
  div.innerHTML = '';
  ch.choices.forEach((c, i) => {
    const btn = document.createElement('button');
    btn.className = 'c-btn';
    btn.textContent = c.text;
    btn.onclick = () => selectChoice(i);
    div.appendChild(btn);
  });

  const sb = document.getElementById('submit-btn');
  sb.style.display = 'none';
  sb.textContent = 'TRANSMIT ANALYSIS';
  sb.onclick = submitAnswer;
  document.getElementById('challenge-modal').classList.add('open');
}

function selectChoice(idx) {
  selectedChoiceIdx = idx;
  document.querySelectorAll('.c-btn').forEach((b, i) => {
    b.classList.toggle('selected', i === idx);
  });
  document.getElementById('submit-btn').style.display = 'block';
}

function submitAnswer() {
  if (selectedChoiceIdx === null) return;
  const ch = CHALLENGES[challengeIdx % CHALLENGES.length];
  const correct = ch.choices[selectedChoiceIdx].correct;

  document.querySelectorAll('.c-btn').forEach((b, i) => {
    b.onclick = null;
    if (ch.choices[i].correct) b.classList.add('correct');
    else if (i === selectedChoiceIdx && !correct) b.classList.add('wrong');
  });

  if (ch.explanation) {
    document.getElementById('exp-text').textContent = ch.explanation;
    document.getElementById('explanation-box').style.display = 'block';
  }

  const sb = document.getElementById('submit-btn');
  sb.textContent = correct ? 'CONFIRMED · CONTINUE MISSION' : 'ACKNOWLEDGED · CONTINUE';
  sb.style.display = 'block';
  sb.onclick = () => {
    sb.onclick = submitAnswer;
    document.getElementById('challenge-modal').classList.remove('open');
    applyResult(correct);
  };
}

/* ── RESULT ─────────────────────────────────────────────── */
function applyResult(correct) {
  let energyDelta, valDelta, latDelta;

  if (correct) {
    /* Original engine logic */
    S.validation += 10;
    energyDelta = +8;
    valDelta    = '+10 pts';
    latDelta    = '—';
    logToast('VALIDATION SUCCESS · DATA PACKET LOGGED');
    challengeIdx++;
  } else {
    /* Original engine penalties */
    S.energy -= 5;
    S.simLatencySeconds += 120;
    S.playableLatencyMs += 300;
    energyDelta = -5;
    valDelta    = '0 pts';
    latDelta    = '+120s';
    logToast('ERROR: DATA INCONCLUSIVE · PENALTY APPLIED');
  }

  S.energy = Math.min(100, S.energy + (correct ? 8 : 0));

  /* Populate result modal */
  const _ch = CHALLENGES[(correct ? challengeIdx - 1 : challengeIdx) % CHALLENGES.length];
  document.getElementById('r-tag').textContent   = correct ? '◈ LOGGED · ' + _ch.id : '✕ REJECTED · ' + _ch.id;
  document.getElementById('r-title').textContent = correct ? 'Sample Integrity Confirmed' : 'Analysis Inconclusive';
  document.getElementById('r-sub').textContent   = _ch.instrument + ' · ' + (correct
    ? 'Data validated. Survey region unlocked.'
    : 'Incorrect interpretation. Energy & latency penalty applied.');

  const rE = document.getElementById('r-energy');
  rE.textContent = (energyDelta >= 0 ? '+' : '') + energyDelta + '%';
  rE.className   = 'r-stat-val' + (energyDelta < 0 ? ' neg' : '');

  const rV = document.getElementById('r-val');
  rV.textContent = valDelta;
  rV.className   = 'r-stat-val' + (valDelta === '0 pts' ? ' amber' : '');

  const rL = document.getElementById('r-lat');
  rL.textContent = latDelta;
  rL.className   = 'r-stat-val' + (latDelta !== '—' ? ' neg' : '');

  document.getElementById('result-modal').classList.add('open');
  updateUI();
}

function closeResult() {
  document.getElementById('result-modal').classList.remove('open');
}

/* ── BOOT SEQUENCE ──────────────────────────────────────── */
const BOOT_LINES = [
  { text: 'DSN Relay Node 7 …',        key: null,           val: 'CONNECTING',  cls: '' },
  { text: 'Signal established.',        key: null,           val: 'OK',          cls: 'bl-ok' },
  { text: 'Rover ID:',                  key: 'HEX-01',       val: null,          cls: '' },
  { text: 'Mission:',                   key: 'Geological Survey · Quadrant A3', val: null, cls: '' },
  { text: 'Solar charge:',             key: '84%',          val: null,          cls: '' },
  { text: 'Signal latency:',           key: '12m 30s',      val: null,          cls: '' },
  { text: 'APXS spectrometer:',        key: 'NOMINAL',      val: null,          cls: '' },
  { text: 'All systems nominal.',       key: null,           val: 'READY',       cls: 'bl-ok' },
];

(function runBoot() {
  const log = document.getElementById('boot-log');
  const fill = document.getElementById('boot-progress-fill');
  const cta  = document.getElementById('boot-cta');

  BOOT_LINES.forEach((line, i) => {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'boot-line';
      let html = `<span>${line.text}</span>`;
      if (line.key) html += ` <span class="bl-key">${line.key}</span>`;
      if (line.val) html += ` <span class="${line.cls || 'bl-val'}">${line.val}</span>`;
      el.innerHTML = html;
      log.appendChild(el);
      fill.style.width = ((i + 1) / BOOT_LINES.length * 100) + '%';
    }, 320 * (i + 1));
  });

  setTimeout(() => {
    cta.classList.add('visible');
  }, 320 * (BOOT_LINES.length + 1) + 200);
})();

</script>
</body>
</html>
